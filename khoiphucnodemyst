#!/bin/bash

# ==============================================================================
# NHáº¬N DIá»†N IP Tá»° Äá»˜NG Tá»ª TOOL PYTHON
# ==============================================================================
OLD_IP_1="$1"
OLD_IP_2="$2"

if [ -z "$OLD_IP_1" ] || [ -z "$OLD_IP_2" ]; then
    echo "âŒ Lá»–I: Script cáº§n tham sá»‘ IP. (Tool Python sáº½ tá»± truyá»n vÃ o)"
    exit 1
fi

# ==============================================================================
# Cáº¤U HÃŒNH TOKEN
# ==============================================================================
MY_TOKEN='{"access_token":"ya29.a0AUMWg_Kv0s3-JmIBl3jGwG1Pwn-0877B8JiOenW0J1O2C0gV52r3tQZCMC_a6Y-r_nRUh-AIlbb61qyCiosp4j4BUoPZZykHd3YTJDQ7x3o1kL5n84E-SfZV_nNFDlh_gElAFX_TwO-R97Hg-BIT4wAIwv41m6eWsP9_5eeG4glGLKttsbb_hG4EjwgRzp3HxDyPItEaCgYKAe4SARISFQHGX2MiFWO2VNZwCbdqMice83bxeQ0206","token_type":"Bearer","refresh_token":"1//0gYKP3t9gNLbcCgYIARAAGBASNwF-L9Ir1JCy9-XxItZRooJntSaxU1pkFCpfJFbdbsVtvGy7SCMdhavxXRN_Ky-tXfBUqF_dfXA","expiry":"2026-02-12T13:42:42.0402294+07:00"}'
RCLONE_REMOTE="gdrive:Mysterium_Backups"
TEMP_DIR="/root/restore_temp"

# CÃ i Ä‘áº·t
if ! command -v rclone &> /dev/null; then
    curl https://rclone.org/install.sh | sudo bash >/dev/null 2>&1
fi
if ! command -v docker &> /dev/null; then
    curl -fsSL https://get.docker.com | sh >/dev/null 2>&1
    systemctl enable --now docker
fi

# Cáº¥u hÃ¬nh Rclone
mkdir -p /root/.config/rclone
cat << EOF > /root/.config/rclone/rclone.conf
[gdrive]
type = drive
scope = drive
token = $MY_TOKEN
EOF
mkdir -p "$TEMP_DIR"

# HÃ€M KHÃ”I PHá»¤C (ÄÃ£ sá»­a Ä‘á»ƒ nháº­n biáº¿n, KHÃ”NG dÃ¹ng read)
restore_process() {
    local ID=$1
    local TARGET_IP=$2
    local NODE_SUFFIX="myst$ID"
    local VOL_NAME="myst-data$ID"

    echo "ðŸ” Xá»­ lÃ½ Node $ID (Nguá»“n IP: $TARGET_IP)..."

    # TÃ¬m file backup
    FILE_NAME=$(rclone lsl "$RCLONE_REMOTE" | grep "$TARGET_IP" | grep "$NODE_SUFFIX" | sort -k2,2 -k3,3 | tail -n 1 | awk '{print $4}')

    if [ -z "$FILE_NAME" ]; then
        echo "âš ï¸  KHÃ”NG TÃŒM THáº¤Y BACKUP!"
        return
    fi

    echo "ðŸ“¥ Táº£i: $FILE_NAME"
    rclone copyto "$RCLONE_REMOTE/$FILE_NAME" "$TEMP_DIR/backup_$ID.tar"

    echo "â™»ï¸  Bung nÃ©n vÃ o $VOL_NAME..."
    docker volume create "$VOL_NAME" >/dev/null 2>&1
    docker run --rm -v "$VOL_NAME":/data alpine sh -c 'rm -rf /data/*'
    docker run --rm -v "$VOL_NAME":/data -v "$TEMP_DIR":/backup alpine tar xf "/backup/backup_$ID.tar" -C /data
    
    rm -f "$TEMP_DIR/backup_$ID.tar"
    echo "âœ… Xong Node $ID!"
}

# CHáº Y
restore_process 1 "$OLD_IP_1"
restore_process 2 "$OLD_IP_2"

rm -rf "$TEMP_DIR"
echo "ðŸŽ‰ RESTORE COMPLETE"
