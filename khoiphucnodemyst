#!/bin/bash

# ==============================================================================
# 1. Cáº¤U HÃŒNH TOKEN
# ==============================================================================
MY_TOKEN='{"access_token":"ya29.a0AUMWg_Kv0s3-JmIBl3jGwG1Pwn-0877B8JiOenW0J1O2C0gV52r3tQZCMC_a6Y-r_nRUh-AIlbb61qyCiosp4j4BUoPZZykHd3YTJDQ7x3o1kL5n84E-SfZV_nNFDlh_gElAFX_TwO-R97Hg-BIT4wAIwv41m6eWsP9_5eeG4glGLKttsbb_hG4EjwgRzp3HxDyPItEaCgYKAe4SARISFQHGX2MiFWO2VNZwCbdqMice83bxeQ0206","token_type":"Bearer","refresh_token":"1//0gYKP3t9gNLbcCgYIARAAGBASNwF-L9Ir1JCy9-XxItZRooJntSaxU1pkFCpfJFbdbsVtvGy7SCMdhavxXRN_Ky-tXfBUqF_dfXA","expiry":"2026-02-12T13:42:42.0402294+07:00"}'
RCLONE_REMOTE="gdrive:Mysterium_Backups"
TEMP_DIR="/root/restore_temp"

# ==============================================================================
# 2. CÃ€I Äáº¶T
# ==============================================================================
echo "âš™ï¸  Äang cÃ i Ä‘áº·t Rclone & Docker..."
if ! command -v rclone &> /dev/null; then
    sudo apt-get update -qq >/dev/null 2>&1
    sudo apt-get install -y unzip curl >/dev/null 2>&1
    curl https://rclone.org/install.sh | sudo bash >/dev/null 2>&1
fi

if ! command -v docker &> /dev/null; then
    curl -fsSL https://get.docker.com | sh >/dev/null 2>&1
    systemctl enable --now docker
fi

# Cáº¥u hÃ¬nh Rclone
mkdir -p /root/.config/rclone
cat << EOF > /root/.config/rclone/rclone.conf
[gdrive]
type = drive
scope = drive
token = $MY_TOKEN
EOF

mkdir -p "$TEMP_DIR"

# ==============================================================================
# 3. HÃ€M KHÃ”I PHá»¤C (Xá»­ lÃ½ tá»«ng node riÃªng biá»‡t)
# ==============================================================================
restore_process() {
    local ID=$1
    local NODE_SUFFIX="myst$ID"    # VÃ­ dá»¥: myst1 hoáº·c myst2
    local VOL_NAME="myst-data$ID"  # VÃ­ dá»¥: myst-data1 hoáº·c myst-data2

    echo "============================================================"
    echo "ğŸ” ÄANG Xá»¬ LÃ NODE $ID ($NODE_SUFFIX)..."
    echo "ğŸ‘‰ Nháº­p IP CÅ¨ cá»§a Node $ID (IP mÃ  nÃ³ dÃ¹ng Ä‘á»ƒ cháº¡y áº¥y):"
    read -p "   IP CÅ© Node $ID: " OLD_IP

    if [ -z "$OLD_IP" ]; then
        echo "âŒ Bá» qua Node $ID vÃ¬ khÃ´ng nháº­p IP."
        return
    fi

    echo "ğŸ” Äang tÃ¬m file backup má»›i nháº¥t khá»›p lá»‡nh: $OLD_IP...$NODE_SUFFIX"
    
    # TÃ¬m file cÃ³ tÃªn chá»©a cáº£ IP CÅ© vÃ  'myst1'/'myst2'
    # Sort theo thá»i gian Ä‘á»ƒ láº¥y file má»›i nháº¥t
    FILE_NAME=$(rclone lsl "$RCLONE_REMOTE" | grep "$OLD_IP" | grep "$NODE_SUFFIX" | sort -k2,2 -k3,3 | tail -n 1 | awk '{print $4}')

    if [ -z "$FILE_NAME" ]; then
        echo "âš ï¸  KHÃ”NG TÃŒM THáº¤Y file backup nÃ o!"
        echo "   (Check láº¡i xem IP $OLD_IP cÃ³ Ä‘Ãºng khÃ´ng, hoáº·c node Ä‘Ã³ tÃªn lÃ  myst$ID khÃ´ng)"
        return
    fi

    echo "ğŸ“¥ ÄÃ£ tÃ¬m tháº¥y: $FILE_NAME"
    echo "â³ Äang táº£i vá»..."
    rclone copyto "$RCLONE_REMOTE/$FILE_NAME" "$TEMP_DIR/backup_$ID.tar"

    echo "â™»ï¸  Äang bung nÃ©n vÃ o Volume: $VOL_NAME..."
    
    # 1. Táº¡o Volume
    docker volume create "$VOL_NAME" >/dev/null 2>&1
    
    # 2. XÃ³a dá»¯ liá»‡u rÃ¡c trong volume (náº¿u cÃ³)
    docker run --rm -v "$VOL_NAME":/data alpine sh -c 'rm -rf /data/*'
    
    # 3. Bung file vÃ o
    docker run --rm -v "$VOL_NAME":/data -v "$TEMP_DIR":/backup alpine tar xf "/backup/backup_$ID.tar" -C /data
    
    # Dá»n dáº¹p file táº¡m
    rm -f "$TEMP_DIR/backup_$ID.tar"
    echo "âœ… ÄÃ£ khÃ´i phá»¥c xong Node $ID!"
}

# ==============================================================================
# 4. CHáº Y
# ==============================================================================
echo "ğŸ“¡ Káº¾T Ná»I DRIVE THÃ€NH CÃ”NG!"
echo "ğŸ’¡ VÃ¬ lÃ  VPS Multi-IP, file backup Node 1 vÃ  Node 2 cÃ³ thá»ƒ mang IP khÃ¡c nhau."
echo "   HÃ£y nháº­p chÃ­nh xÃ¡c IP cÅ© cá»§a tá»«ng node nhÃ©."

restore_process 1  # Há»i IP cÅ© node 1 -> Restore vÃ o myst-data1
restore_process 2  # Há»i IP cÅ© node 2 -> Restore vÃ o myst-data2

rm -rf "$TEMP_DIR"
echo "============================================================"
echo "ğŸ‰ XONG TOÃ€N Bá»˜!"
echo "ğŸ‘‰ Dá»¯ liá»‡u Ä‘Ã£ vÃ o 2 volume: myst-data1 & myst-data2"
echo "ğŸ‘‰ Giá» cháº¡y Script CÃ i Äáº·t (Install) lÃ  xong phim!"
