#!/bin/bash

# NH·∫¨N DI·ªÜN IP
OLD_IP_1="$1"
OLD_IP_2="$2"

if [ -z "$OLD_IP_1" ] || [ -z "$OLD_IP_2" ]; then
    echo "‚ùå L·ªñI: Thi·∫øu IP ƒë·∫ßu v√†o."
    exit 1
fi

# ================= C·∫§U H√åNH =================
# (Gi·ªØ nguy√™n Token c≈© c·ªßa √¥ng)
MY_TOKEN='{"access_token":"ya29.a0ATkoCc5YpwZF-TrK_rAeVfHZAWYTTp-hwfTJhpoZh5mvak5WsF2Sg-a6vUfkBsW5LtZadeA98Ucg_dGjn_gYvFj4haeJsN9EsVUcYR1ChiU4CYgNjaHrdj1OAb3b4vv7LBz_dZTgtWcIxH0TrKxF_t6px7JoFswEYCm8lKI7qImA5fm_T9LGHVHMJARzKqHm0GKx0wEaCgYKAf4SARISFQHGX2MiC8QhB1N6QohsaQCKD2WbIg0206","token_type":"Bearer","refresh_token":"1//0gBDTyzwX2lYYCgYIARAAGBASNwF-L9IrlihLVC49TEFn9gUlCkgqpta8F09ccC249ZdF1Lc5DFM4ThRf2FYlKYRE2VYmcnrcqBI","expiry":"2026-02-19T01:23:11.0332194+07:00"}'
RCLONE_REMOTE="gdrive:Mysterium_Backups"
TEMP_DIR="/root/restore_temp"

# C√ÄI ƒê·∫∂T NHANH
if ! command -v rclone &> /dev/null; then
    curl https://rclone.org/install.sh | sudo bash >/dev/null 2>&1
fi
if ! command -v docker &> /dev/null; then
    curl -fsSL https://get.docker.com | sh >/dev/null 2>&1
    systemctl enable --now docker
fi

# T·∫†O CONFIG RCLONE (Ghi ƒë√® ƒë·ªÉ ch·∫Øc ch·∫Øn ƒë√∫ng)
mkdir -p /root/.config/rclone
cat << EOF > /root/.config/rclone/rclone.conf
[gdrive]
type = drive
scope = drive
token = $MY_TOKEN
EOF
mkdir -p "$TEMP_DIR"

# KI·ªÇM TRA K·∫æT N·ªêI DRIVE NGAY L·∫¨P T·ª®C
if ! rclone listremotes | grep -q "gdrive"; then
    echo "‚ùå L·ªñI: Kh√¥ng k·∫øt n·ªëi ƒë∆∞·ª£c Google Drive (Token sai ho·∫∑c Config l·ªói)."
    exit 1
fi

# H√ÄM KH√îI PH·ª§C (S·ª¨A L·∫†I: L·ªñI L√Ä EXIT LU√îN)
restore_process() {
    local ID=$1
    local TARGET_IP=$2
    local NODE_SUFFIX="myst$ID"
    local VOL_NAME="myst-data$ID"

    echo "üîç ƒêang t√¨m backup cho Node $ID (Ngu·ªìn: $TARGET_IP)..."

    # T√¨m file
    FILE_NAME=$(rclone lsl "$RCLONE_REMOTE" | grep "$TARGET_IP" | grep "$NODE_SUFFIX" | sort -k2,2 -k3,3 | tail -n 1 | awk '{print $4}')

    if [ -z "$FILE_NAME" ]; then
        echo "‚ùå L·ªñI: Kh√¥ng t√¨m th·∫•y file backup n√†o ch·ª©a '$TARGET_IP' v√† '$NODE_SUFFIX' tr√™n Drive!"
        exit 1  # <--- QUAN TR·ªåNG: Tho√°t ngay ƒë·ªÉ b√°o l·ªói
    fi

    echo "üì• T·∫£i v·ªÅ: $FILE_NAME"
    if ! rclone copyto "$RCLONE_REMOTE/$FILE_NAME" "$TEMP_DIR/backup_$ID.tar"; then
        echo "‚ùå L·ªñI: T·∫£i file th·∫•t b·∫°i."
        exit 1
    fi

    echo "‚ôªÔ∏è  Bung n√©n v√†o $VOL_NAME..."
    # T·∫°o volume v√† ƒë·∫£m b·∫£o n√≥ t·ªìn t·∫°i
    docker volume create "$VOL_NAME" >/dev/null 2>&1
    
    # X·∫£ n√©n (N·∫øu l·ªánh tar l·ªói th√¨ b√°o l·ªói lu√¥n)
    if ! docker run --rm -v "$VOL_NAME":/data -v "$TEMP_DIR":/backup alpine tar xf "/backup/backup_$ID.tar" -C /data; then
         echo "‚ùå L·ªñI: Bung n√©n v√†o Docker Volume th·∫•t b·∫°i."
         exit 1
    fi

    rm -f "$TEMP_DIR/backup_$ID.tar"
    echo "‚úÖ Xong Node $ID"
}

# CH·∫†Y
restore_process 1 "$OLD_IP_1"
restore_process 2 "$OLD_IP_2"

rm -rf "$TEMP_DIR"
# CH·ªà IN D√íNG N√ÄY N·∫æU M·ªåI TH·ª® OK
echo "RESTORE COMPLETE"
