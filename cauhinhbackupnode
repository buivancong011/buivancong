#!/bin/bash

# ==============================================================================
# ‚ö†Ô∏è C·∫§U H√åNH TOKEN (Gi·ªØ nguy√™n Token c·ªßa √¥ng)
# ==============================================================================
MY_TOKEN='{"access_token":"ya29.a0AUMWg_Kv0s3-JmIBl3jGwG1Pwn-0877B8JiOenW0J1O2C0gV52r3tQZCMC_a6Y-r_nRUh-AIlbb61qyCiosp4j4BUoPZZykHd3YTJDQ7x3o1kL5n84E-SfZV_nNFDlh_gElAFX_TwO-R97Hg-BIT4wAIwv41m6eWsP9_5eeG4glGLKttsbb_hG4EjwgRzp3HxDyPItEaCgYKAe4SARISFQHGX2MiFWO2VNZwCbdqMice83bxeQ0206","token_type":"Bearer","refresh_token":"1//0gYKP3t9gNLbcCgYIARAAGBASNwF-L9Ir1JCy9-XxItZRooJntSaxU1pkFCpfJFbdbsVtvGy7SCMdhavxXRN_Ky-tXfBUqF_dfXA","expiry":"2026-02-12T13:42:42.0402294+07:00"}'
# ==============================================================================

echo "üöÄ ƒêANG C·∫§U H√åNH H·ªÜ TH·ªêNG BACKUP (B·∫¢N FIX L·ªñI)..."

# 1. C√†i ƒë·∫∑t Rclone & Unzip
sudo apt-get update -qq >/dev/null 2>&1
sudo apt-get install -y unzip curl >/dev/null 2>&1
curl https://rclone.org/install.sh | sudo bash >/dev/null 2>&1

# 2. T·∫°o file c·∫•u h√¨nh Rclone
mkdir -p /root/.config/rclone
cat << EOF > /root/.config/rclone/rclone.conf
[gdrive]
type = drive
scope = drive
token = $MY_TOKEN
EOF

# 3. T·∫°o Script Backup th√¥ng minh (S·ª¨ D·ª§NG RENICE)
cat << 'EOF' > /root/auto_backup.sh
#!/bin/bash

# --- QUAN TR·ªåNG: T·ª± gi·∫£m ∆∞u ti√™n CPU c·ªßa ch√≠nh script n√†y xu·ªëng th·∫•p nh·∫•t ---
# (Thay th·∫ø cho l·ªánh nice ph·ª©c t·∫°p g√¢y l·ªói syntax c≈©)
renice -n 19 -p $$ >/dev/null 2>&1

RCLONE_REMOTE="gdrive:Mysterium_Backups"
LOCAL_TEMP="/tmp/myst_backups"
NODE_IDS=(1 2) 

mkdir -p "$LOCAL_TEMP"

backup_node() {
    local ID=$1
    local VOL="myst-data$ID"
    local NET="my_network_$ID"
    
    # L·∫•y IP Public
    PUBLIC_IP=$(docker run --rm --network "$NET" curlimages/curl:latest -s --max-time 10 https://api.ipify.org)
    [ -z "$PUBLIC_IP" ] && PREFIX="Unknown_myst$ID" || PREFIX="${PUBLIC_IP}_myst$ID"
    
    # ƒêu√¥i .tar (KH√îNG N√âN - GI√öP CPU 1 CORE KH√îNG B·ªä LAG)
    FILENAME="${PREFIX}_$(date +%F).tar"
    
    if docker volume inspect "$VOL" >/dev/null 2>&1; then
        echo "üì¶ ƒêang x·ª≠ l√Ω Node $ID ($VOL)..."
        
        # Ch·ªâ ƒë√≥ng g√≥i tar cf (Kh√¥ng n√©n)
        docker run --rm -v "$VOL":/data:ro -v "$LOCAL_TEMP":/backup alpine tar cf "/backup/$FILENAME" -C /data .
        
        # Upload
        if rclone copy "$LOCAL_TEMP/$FILENAME" "$RCLONE_REMOTE"; then
             echo "‚úÖ ƒê√£ backup xong: $FILENAME"
             rm -f "$LOCAL_TEMP/$FILENAME"
        else
             echo "‚ùå L·ªói Upload Node $ID"
        fi
    fi
}

# Ch·∫°y v√≤ng l·∫∑p b√¨nh th∆∞·ªùng (Kh√¥ng c√≤n b·ªã l·ªói c√∫ ph√°p n·ªØa)
for id in "${NODE_IDS[@]}"; do
    backup_node "$id"
done

echo "üéâ HO√ÄN T·∫§T TO√ÄN B·ªò!"
EOF

chmod +x /root/auto_backup.sh

# 4. Ch·∫°y th·ª≠ nghi·ªám
echo "‚è≥ ƒêang ch·∫°y th·ª≠ l·∫ßn ƒë·∫ßu..."
/root/auto_backup.sh

echo "----------------------------------------------------------------"
echo "‚úÖ ƒê√É S·ª¨A XONG! Script ch·∫°y m∆∞·ª£t m√† kh√¥ng l·ªói."
echo "üëâ L·ªánh ch·∫°y th·ªß c√¥ng: /root/auto_backup.sh"
