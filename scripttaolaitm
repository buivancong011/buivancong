#!/bin/bash
set -e

# ==== C·∫§U H√åNH TOKEN ====
TOKEN_TM="/PfkwR8qQMfbsCMrSaaDhsX96E9w2PeHH2bcGeyFBno="

# ==== T·ª∞ ƒê·ªòNG CH·ªåN IMAGE THEO CPU ====
ARCH=$(uname -m)
if [[ "$ARCH" == "aarch64" ]]; then
  echo -e "\e[32m[INFO] Detected ARM64 CPU (Graviton)\e[0m"
  IMG_TM="traffmonetizer/cli_v2:arm64v8"
else
  echo -e "\e[32m[INFO] Detected AMD64/x86 CPU\e[0m"
  IMG_TM="traffmonetizer/cli_v2:latest"
fi

# H√†m log m√†u m√® cho d·ªÖ nh√¨n
log() { echo -e "\e[32m[INFO] $1\e[0m"; }

# ==== 1. D·ªåN D·∫∏P CONTAINER TM C≈® ====
log "ƒêang d·ªçn d·∫πp c√°c node Traffmonetizer c≈©..."
# X√≥a tm1, tm2... (n·∫øu c√≥)
docker rm -f tm1 tm2 >/dev/null 2>&1 || true

# ==== 2. KH·ªûI CH·∫†Y L·∫†I ====
run_tm() {
  local ID=$1
  local NET="my_network_$ID"

  # Ki·ªÉm tra m·∫°ng c√≥ t·ªìn t·∫°i kh√¥ng
  if docker network inspect "$NET" >/dev/null 2>&1; then
      log "üöÄ ƒêang kh·ªüi t·∫°o tm$ID tr√™n m·∫°ng $NET..."
      
      docker run -d \
        --name "tm$ID" \
        --network "$NET" \
        --restart always \
        --dns 1.1.1.1 \
        --dns 1.0.0.1 \
        "$IMG_TM" start accept --token "$TOKEN_TM" >/dev/null
        
      log "‚úÖ tm$ID ƒë√£ ch·∫°y th√†nh c√¥ng."
  else
      echo -e "\e[31m[ERROR] Network $NET kh√¥ng t·ªìn t·∫°i. H√£y ch·∫°y script t·∫°o m·∫°ng tr∆∞·ªõc!\e[0m"
  fi
}

# Ch·∫°y cho IP 1 v√† IP 2
run_tm 1
run_tm 2

# ==== 3. KI·ªÇM TRA ====
echo "----------------------------------------------------"
log "DANH S√ÅCH TRAFFMONETIZER:"
docker ps --filter "name=tm" --format "table {{.Names}}\t{{.Status}}\t{{.Image}}"
