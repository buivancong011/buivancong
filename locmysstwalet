#!/bin/bash

# =================================================================
# Cáº¤U HÃŒNH (Sá»¬A 3 DÃ’NG NÃ€Y)
# =================================================================
# 1. API Key (Láº¥y táº¡i my.mystnodes.com/me)
MYST_API_KEY="nX51wlGwSBAmcZ6da2tKUqTf6kzDNRMCg1xIxCwT" 

# 2. VÃ­ nháº­n tiá»n (Polygon/Metamask)
MY_WALLET="0x22cBdE4c61BA69374169eB9B1a49d62Db3beCC7f" 

# 3. Máº­t kháº©u Web Local (Äá»ƒ Ä‘Äƒng nháº­p IP:4449)
NODE_PASSWORD="MatKhauManh123@"
# =================================================================

echo "========================================================"
echo "   MYSTERIUM CLI SETUP (STRICT FLOW)"
echo "========================================================"

NODES=$(docker ps --format "{{.Names}}" | grep "myst")

if [ -z "$NODES" ]; then echo "âŒ KhÃ´ng tÃ¬m tháº¥y node."; exit 1; fi

for node in $NODES; do
    echo "--------------------------------------------------"
    echo "âš™ï¸  Xá»­ lÃ½ Node: $node"

    # 1. CHáº¤P NHáº¬N ÄIá»€U KHOáº¢N (LuÃ´n lÃ  bÆ°á»›c Ä‘áº§u tiÃªn)
    docker exec "$node" myst cli --agreed-terms-and-conditions >/dev/null 2>&1

    # 2. Láº¤Y IDENTITY & UNLOCK (Báº®T BUá»˜C THEO DOCS)
    echo "   ðŸ”‘ Äang láº¥y vÃ  Unlock Identity..."
    
    # Láº¥y list identity
    RAW_LIST=$(docker exec "$node" myst cli identities list)
    # Lá»c láº¥y Ä‘á»‹a chá»‰ vÃ­ (0x...)
    ID_ADDR=$(echo "$RAW_LIST" | grep -oE '0x[a-fA-F0-9]{40}' | head -n 1)

    # Náº¿u chÆ°a cÃ³ identity thÃ¬ táº¡o má»›i
    if [ -z "$ID_ADDR" ]; then
        echo "      -> ChÆ°a cÃ³ ID, Ä‘ang táº¡o má»›i..."
        docker exec "$node" myst cli identities new >/dev/null 2>&1
        ID_ADDR=$(docker exec "$node" myst cli identities list | grep -oE '0x[a-fA-F0-9]{40}' | head -n 1)
    fi

    # *** BÆ¯á»šC QUAN TRá»ŒNG: UNLOCK ***
    # TÃ i liá»‡u: identities unlock <address>
    if [ -n "$ID_ADDR" ]; then
        docker exec "$node" myst cli identities unlock "$ID_ADDR" >/dev/null 2>&1
        echo "      -> ÄÃ£ Unlock ID: $ID_ADDR"
    fi

    # 3. ÄÄ‚NG KÃ VÃ (REGISTER)
    # TÃ i liá»‡u: identities register [beneficiary]
    echo "   ðŸ’° Äang Ä‘Äƒng kÃ½ vÃ­ nháº­n tiá»n..."
    docker exec "$node" myst cli identities register "$MY_WALLET" >/dev/null 2>&1

    # 4. Káº¾T Ná»I DASHBOARD (MMN)
    # TÃ i liá»‡u: mmn [api-key]
    echo "   â˜ï¸  Káº¿t ná»‘i mystnodes.com (MMN)..."
    MMN_LOG=$(docker exec "$node" myst cli mmn "$MYST_API_KEY" 2>&1)
    
    if echo "$MMN_LOG" | grep -q "Error"; then
        echo "      âš ï¸  MMN Info: $MMN_LOG"
    else
        echo "      âœ… Káº¿t ná»‘i Dashboard thÃ nh cÃ´ng!"
    fi

    # 5. CÃ€I Máº¬T KHáº¨U LOCAL (Äá»ƒ báº¡n vÃ o Ä‘Æ°á»£c IP:4449)
    # BÆ°á»›c nÃ y khÃ´ng náº±m trong CLI docs nhÆ°ng náº±m trong pháº§n Config cá»§a Node
    echo "   ðŸ”’ CÃ i máº­t kháº©u Web Local..."
    docker exec "$node" myst config set tequilapi.pass "$NODE_PASSWORD"

    # 6. KHá»žI Äá»˜NG Láº I (Äá»ƒ Ã¡p dá»¥ng Password)
    echo "   ðŸ”„ Restarting..."
    docker restart "$node" >/dev/null
    
    # LÆ°u Ã½: Sau khi restart, Identity sáº½ bá»‹ Lock láº¡i (theo docs). 
    # NhÆ°ng vÃ¬ Node tá»± cháº¡y service nÃªn nÃ³ sáº½ tá»± unlock ná»™i bá»™ Ä‘á»ƒ Ä‘Ã o.
    
    echo "   âœ… Xong $node"
done

echo "--------------------------------------------------"
echo "ðŸŽ‰ HOÃ€N Táº¤T!"
echo "ðŸ‘‰ Kiá»ƒm tra Dashboard: https://my.mystnodes.com/nodes"
echo "ðŸ‘‰ Web Local: http://IP:4449 (Pass: $NODE_PASSWORD)"
