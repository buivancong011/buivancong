#!/bin/bash

# =================================================================
# Cáº¤U HÃŒNH (ÄIá»€N THÃ”NG TIN Cá»¦A Báº N)
# =================================================================
# 1. API Key (Láº¥y táº¡i my.mystnodes.com/me)
MYST_API_KEY="nX51wlGwSBAmcZ6da2tKUqTf6kzDNRMCg1xIxCwT" 

# 2. VÃ­ nháº­n tiá»n lÃ£i (VÃ­ chÃ­nh cá»§a báº¡n)
MY_WALLET="0x22cBdE4c61BA69374169eB9B1a49d62Db3beCC7f"
# =================================================================

echo "========================================================"
echo "   MYSTERIUM AUTO SETUP & GET CHANNEL ADDRESS"
echo "========================================================"

NODES=$(docker ps --format "{{.Names}}" | grep "myst")

if [ -z "$NODES" ]; then echo "âŒ KhÃ´ng tÃ¬m tháº¥y node."; exit 1; fi

# Táº¡o file táº¡m Ä‘á»ƒ lÆ°u danh sÃ¡ch náº¡p tiá»n
> myst_topup_list.txt

printf "%-10s | %-42s | %-42s\n" "NODE" "IDENTITY (ProviderID)" "CHANNEL ADDRESS (Náº¡p tiá»n vÃ o Ä‘Ã¢y)"
echo "--------------------------------------------------------------------------------------------------------"

for node in $NODES; do
    # 1. Láº¤Y IDENTITY
    RAW_LIST=$(docker exec "$node" myst cli identities list)
    ID=$(echo "$RAW_LIST" | grep -oE '0x[a-fA-F0-9]{40}' | head -n 1)

    # Náº¿u chÆ°a cÃ³ thÃ¬ táº¡o má»›i
    if [ -z "$ID" ]; then
        docker exec "$node" myst cli identities new >/dev/null 2>&1
        ID=$(docker exec "$node" myst cli identities list | grep -oE '0x[a-fA-F0-9]{40}' | head -n 1)
    fi

    # 2. UNLOCK (BÆ°á»›c báº¯t buá»™c thá»§ cÃ´ng báº¡n Ä‘Ã£ lÃ m)
    docker exec "$node" myst cli identities unlock "$ID" >/dev/null 2>&1

    # 3. Káº¾T Ná»I DASHBOARD (MMN)
    docker exec "$node" myst cli mmn "$MYST_API_KEY" >/dev/null 2>&1

    # 4. ÄÄ‚NG KÃ (REGISTER) - KÃ¨m vÃ­ nháº­n tiá»n
    # Lá»‡nh nÃ y sáº½ set luÃ´n vÃ­ MY_WALLET lÃ m beneficiary
    docker exec "$node" myst cli identities register "$ID" "$MY_WALLET" >/dev/null 2>&1

    # 5. START WIREGUARD
    docker exec "$node" myst cli service start "$ID" wireguard >/dev/null 2>&1

    # 6. Láº¤Y CHANNEL ADDRESS (Pháº§n quan trá»ng nháº¥t báº¡n cáº§n)
    # Cháº¡y lá»‡nh 'identities get' vÃ  lá»c dÃ²ng 'Channel address'
    INFO=$(docker exec "$node" myst cli identities get "$ID")
    CHANNEL_ADDR=$(echo "$INFO" | grep "Channel address" | awk '{print $NF}')

    # In ra mÃ n hÃ¬nh
    printf "%-10s | %-42s | %-42s\n" "$node" "$ID" "$CHANNEL_ADDR"
    
    # LÆ°u vÃ o file Ä‘á»ƒ copy cho dá»…
    echo "$CHANNEL_ADDR" >> myst_topup_list.txt

done

echo "--------------------------------------------------------------------------------------------------------"
echo "ğŸ‰ HOÃ€N Táº¤T QUY TRÃŒNH!"
echo ""
echo "ğŸ‘‰ BÆ¯á»šC TIáº¾P THEO (QUAN TRá»ŒNG):"
echo "   Báº¡n cáº§n náº¡p khoáº£ng 0.1 - 0.2 MYST (Máº¡ng Polygon) vÃ o cá»™t 'CHANNEL ADDRESS' á»Ÿ trÃªn."
echo "   (Danh sÃ¡ch Ä‘á»‹a chá»‰ náº¡p tiá»n Ä‘Ã£ Ä‘Æ°á»£c lÆ°u vÃ o file: myst_topup_list.txt)"
echo ""
echo "   Sau khi Channel Address nháº­n Ä‘Æ°á»£c tiá»n, Node sáº½ tá»± Ä‘á»™ng chuyá»ƒn sang tráº¡ng thÃ¡i Registered."
