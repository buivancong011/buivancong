#!/bin/bash

# =================================================================
# CแบคU HรNH (SแปฌA 3 DรNG NรY)
# =================================================================
# 1. API Key lแบฅy tแบกi: https://my.mystnodes.com/me
MYST_API_KEY="nX51wlGwSBAmcZ6da2tKUqTf6kzDNRMCg1xIxCwT" 

# 2. ฤแปa chแป vรญ Polygon/Metamask ฤแป nhแบญn tiแปn
MY_WALLET="0x22cBdE4c61BA69374169eB9B1a49d62Db3beCC7f"

# 3. Mแบญt khแบฉu cho Web UI (IP:4449) -> ฤแป bแบกn login vรo kiแปm tra
NODE_PASSWORD="nX51wlGwSBAmcZ6da2tKUqTf6kzDNRMCg1xIxCwT"
# =================================================================

echo "========================================================"
echo "   MYSTERIUM FULL AUTO SETUP (CLI + PASS + WALLET)"
echo "========================================================"

NODES=$(docker ps --format "{{.Names}}" | grep "myst")

if [ -z "$NODES" ]; then
    echo "โ Khรดng tรฌm thแบฅy container Mysterium nรo."
    exit 1
fi

for node in $NODES; do
    echo "--------------------------------------------------"
    echo "Processing Node: $node..."

    # BฦฏแปC 1: CHแบคP NHแบฌN ฤIแปU KHOแบขN (Bแบฏt buแปc)
    docker exec "$node" myst cli --agreed-terms-and-conditions >/dev/null 2>&1

    # BฦฏแปC 2: CรI ฤแบถT MแบฌT KHแบจU CHO WEB UI (Cรกi bแบกn ฤang thiแบฟu)
    # Lแปnh nรy can thiแปp vรo file config ฤแป set pass luรดn
    echo "   ๐ ฤang set mแบญt khแบฉu Web UI..."
    docker exec "$node" myst config set "tequilapi.pass" "$NODE_PASSWORD"

    # BฦฏแปC 3: LIรN KแบพT DASHBOARD (MMN)
    echo "   ๐ ฤang liรชn kแบฟt Dashboard..."
    docker exec "$node" myst cli mmn "$MYST_API_KEY"

    # BฦฏแปC 4: ฤฤNG Kร IDENTITY & Vร (ฤแป nhแบญn tiแปn)
    echo "   ๐ฐ ฤang cรi ฤแบทt vรญ nhแบญn tiแปn..."
    # Lแบฅy Identity hiแปn tแบกi
    ID_ADDR=$(docker exec "$node" myst cli identities list | grep -oE '0x[a-fA-F0-9]{40}' | head -n 1)
    if [ -z "$ID_ADDR" ]; then
        docker exec "$node" myst cli identities new >/dev/null 2>&1
    fi
    # ฤฤng kรฝ
    docker exec "$node" myst cli identities register "$MY_WALLET"

    # BฦฏแปC 5: KHแปI ฤแปNG LแบI ฤแป รP DแปคNG MแบฌT KHแบจU
    echo "   ๐ Restart node ฤแป mแบญt khแบฉu cรณ hiแปu lแปฑc..."
    docker restart "$node" >/dev/null
    sleep 5

    echo "   โ Xong node $node!"
done

echo "--------------------------------------------------"
echo "๐ HOรN TแบคT TOรN Bแป!"
echo "๐ Giแป bแบกn vรo IP:4449 sแบฝ thแบฅy mรn hรฌnh Login (khรดng phแบฃi Onboarding nแปฏa)."
echo "๐ Mแบญt khแบฉu ฤฤng nhแบญp lร: $NODE_PASSWORD"
