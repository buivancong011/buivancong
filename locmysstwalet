#!/bin/bash

# ==== C·∫§U H√åNH M√ÄU S·∫ÆC ====
RED='\033[0;31m'
GREEN='\033[0;32m'
NC='\033[0m' # No Color

echo "=========================================================="
echo "   KI·ªÇM TRA TR·∫†NG TH√ÅI NODE MYSTERIUM (AUTO-CHECK)"
echo "=========================================================="

# L·∫•y danh s√°ch container
NODES=$(docker ps --format "{{.Names}}" | grep "myst")

if [ -z "$NODES" ]; then
    echo "‚ùå Kh√¥ng t√¨m th·∫•y container Mysterium n√†o."
    exit 1
fi

printf "%-10s | %-42s | %-15s\n" "NODE" "IDENTITY ADDRESS" "TR·∫†NG TH√ÅI"
echo "------------------------------------------------------------------------"

for node in $NODES; do
    # 1. L·∫•y to√†n b·ªô th√¥ng tin Identity
    RAW_DATA=$(docker exec "$node" myst cli identities list 2>&1)
    
    # 2. L·∫•y ƒë·ªãa ch·ªâ v√≠ (Identity) - L·∫•y chu·ªói 0x ƒë·∫ßu ti√™n t√¨m th·∫•y
    IDENTITY=$(echo "$RAW_DATA" | grep -oE '0x[a-fA-F0-9]{40}' | head -n 1)

    if [ -z "$IDENTITY" ]; then
        IDENTITY="Kh√¥ng t√¨m th·∫•y ID"
        STATUS_TEXT="${RED}L·ªói Node${NC}"
    else
        # 3. Ki·ªÉm tra tr·∫°ng th√°i d·ª±a tr√™n t·ª´ kh√≥a trong log
        # D√πng grep -i ƒë·ªÉ kh√¥ng ph√¢n bi·ªát hoa th∆∞·ªùng
        if echo "$RAW_DATA" | grep -iq "Unregistered"; then
            STATUS_TEXT="${RED}‚ùå Ch∆∞a Active${NC}"
            CMD_HINT="(C·∫ßn n·∫°p ph√≠)"
        elif echo "$RAW_DATA" | grep -iq "Registered"; then
            STATUS_TEXT="${GREEN}‚úÖ ƒê√£ Active${NC}"
            CMD_HINT=""
        elif echo "$RAW_DATA" | grep -iq "Registration in progress"; then
             STATUS_TEXT="${YELLOW}‚è≥ ƒêang ƒêK...${NC}"
        else
            STATUS_TEXT="‚ùì Kh√¥ng r√µ"
        fi
    fi

    # In ra k·∫øt qu·∫£
    printf "%-10s | %-42s | %b %s\n" "$node" "$IDENTITY" "$STATUS_TEXT" "$CMD_HINT"

done
echo "------------------------------------------------------------------------"
echo "üëâ L∆ØU √ù:"
echo "1. N·∫øu tr·∫°ng th√°i l√† '‚ùå Ch∆∞a Active': Copy ƒë·ªãa ch·ªâ Identity Address."
echo "2. G·ª≠i kho·∫£ng 0.1 MATIC ho·∫∑c MYST (Polygon) v√†o ƒë·ªãa ch·ªâ ƒë√≥."
echo "3. Sau khi g·ª≠i ti·ªÅn, ch·∫°y l·ªánh sau ƒë·ªÉ k√≠ch ho·∫°t:"
echo "   docker exec <t√™n_node> myst cli identities register"
