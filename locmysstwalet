#!/bin/bash

# =================================================================
# Cáº¤U HÃŒNH (Sá»¬A 3 DÃ’NG NÃ€Y)
# =================================================================
# 1. API Key (Láº¥y táº¡i my.mystnodes.com/me)
MYST_API_KEY="nX51wlGwSBAmcZ6da2tKUqTf6kzDNRMCg1xIxCwT" 

# 2. Máº­t kháº©u báº¡n muá»‘n Ä‘áº·t cho Node (Äá»ƒ Ä‘Äƒng nháº­p IP:4449)
NODE_PASSWORD="CAOcao123@"

# 3. VÃ­ nháº­n tiá»n (Polygon/Metamask)
MY_WALLET="0x22cBdE4c61BA69374169eB9B1a49d62Db3beCC7f" 
# =================================================================

echo "========================================================"
echo "   MYSTERIUM FULL SETUP (CLI)"
echo "========================================================"

NODES=$(docker ps --format "{{.Names}}" | grep "myst")

if [ -z "$NODES" ]; then
    echo "âŒ KhÃ´ng tÃ¬m tháº¥y container Mysterium nÃ o."
    exit 1
fi

for node in $NODES; do
    echo "--------------------------------------------------"
    echo "ðŸ”Œ Äang xá»­ lÃ½ Node: $node"

    # 1. CHáº¤P NHáº¬N ÄIá»€U KHOáº¢N
    docker exec "$node" myst cli --agreed-terms-and-conditions >/dev/null 2>&1

    # 2. SET Máº¬T KHáº¨U (Quan trá»ng)
    # Lá»‡nh nÃ y cáº¥u hÃ¬nh trá»±c tiáº¿p vÃ o service Tequilapi (Giao diá»‡n Web)
    echo "   ðŸ”‘ Äang cÃ i máº­t kháº©u Local..."
    docker exec "$node" myst config set tequilapi.pass "$NODE_PASSWORD"

    # 3. Káº¾T Ná»I DASHBOARD (Lá»‡nh mmn)
    echo "   â˜ï¸  Äang káº¿t ná»‘i Dashboard (MMN)..."
    docker exec "$node" myst cli mmn "$MYST_API_KEY"

    # 4. ÄÄ‚NG KÃ VÃ (Register)
    echo "   ðŸ’° Äang Ä‘Äƒng kÃ½ vÃ­ nháº­n tiá»n..."
    docker exec "$node" myst cli identities register "$MY_WALLET" >/dev/null 2>&1

    # 5. KHá»žI Äá»˜NG Láº I (Báº¯t buá»™c Ä‘á»ƒ máº­t kháº©u cÃ³ hiá»‡u lá»±c)
    echo "   ðŸ”„ Äang khá»Ÿi Ä‘á»™ng láº¡i node..."
    docker restart "$node" >/dev/null
    
    echo "   âœ… Xong node $node"
done

echo "--------------------------------------------------"
echo "ðŸŽ‰ HOÃ€N Táº¤T!"
echo "ðŸ‘‰ Truy cáº­p Web Local: http://<IP_VPS>:4449"
echo "ðŸ‘‰ Máº­t kháº©u Ä‘Äƒng nháº­p: $NODE_PASSWORD"
echo "ðŸ‘‰ Kiá»ƒm tra Dashboard: https://my.mystnodes.com/nodes"
