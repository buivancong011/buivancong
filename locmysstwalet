#!/bin/bash

# =================================================================
# CแบคU HรNH (SแปฌA LแบI API Vร Vร CแปฆA BแบN)
# =================================================================
# 1. API Key (Lแบฅy tแบกi my.mystnodes.com/me)
MYST_API_KEY="nX51wlGwSBAmcZ6da2tKUqTf6kzDNRMCg1xIxCwT" 

# 2. Vรญ nhแบญn tiแปn (Vรญ chรญnh Polygon/Metamask)
MY_WALLET="0x22cBdE4c61BA69374169eB9B1a49d62Db3beCC7f" 
# =================================================================

echo "========================================================"
echo "   MYSTERIUM AUTO SETUP (FORCE WALLET SET)"
echo "========================================================"

NODES=$(docker ps --format "{{.Names}}" | grep "myst")

if [ -z "$NODES" ]; then echo "โ Khรดng tรฌm thแบฅy node."; exit 1; fi

# Tแบกo file danh sรกch nแบกp tiแปn
> myst_topup.txt

printf "%-10s | %-42s | %-42s\n" "NODE" "IDENTITY (ProviderID)" "CHANNEL ADDRESS (Nแบกp tiแปn vรo ฤรขy)"
echo "--------------------------------------------------------------------------------------------------------"

for node in $NODES; do
    # 1. LแบคY IDENTITY
    RAW_LIST=$(docker exec "$node" myst cli identities list)
    ID=$(echo "$RAW_LIST" | grep -oE '0x[a-fA-F0-9]{40}' | head -n 1)

    # Nแบฟu chฦฐa cรณ thรฌ tแบกo mแปi
    if [ -z "$ID" ]; then
        docker exec "$node" myst cli identities new >/dev/null 2>&1
        ID=$(docker exec "$node" myst cli identities list | grep -oE '0x[a-fA-F0-9]{40}' | head -n 1)
    fi

    # 2. UNLOCK (Bฦฐแปc bแบฏt buแปc)
    docker exec "$node" myst cli identities unlock "$ID" >/dev/null 2>&1

    # 3. KแบพT NแปI DASHBOARD (MMN)
    docker exec "$node" myst cli mmn "$MYST_API_KEY" >/dev/null 2>&1

    # 4. ฤฤNG Kร (REGISTER)
    docker exec "$node" myst cli identities register "$ID" "$MY_WALLET" >/dev/null 2>&1

    # 5. SET Vร (FORCE SET - THEO YรU CแบฆU CแปฆA BแบN)
    # Lแปnh nรy sแบฝ chแบกy vร bแป qua lแปi hiแปn thแป (nhฦฐ lแปi 500 fee)
    # Chรบng ta thรชm "|| true" ฤแป script khรดng bแป dแปซng nแบฟu cรณ lแปi
    docker exec "$node" myst cli identities beneficiary-set "$ID" "$MY_WALLET" >/dev/null 2>&1 || true

    # 6. START WIREGUARD
    docker exec "$node" myst cli service start "$ID" wireguard >/dev/null 2>&1

    # 7. LแบคY CHANNEL ADDRESS ฤแป NแบP TIแปN
    INFO=$(docker exec "$node" myst cli identities get "$ID")
    CHANNEL_ADDR=$(echo "$INFO" | grep "Channel address" | awk '{print $NF}')

    # In ra mรn hรฌnh
    printf "%-10s | %-42s | %-42s\n" "$node" "$ID" "$CHANNEL_ADDR"
    
    # Lฦฐu vรo file
    echo "$CHANNEL_ADDR" >> myst_topup.txt

done

echo "--------------------------------------------------------------------------------------------------------"
echo "๐ ฤร SET Vร THรNH CรNG (Bแบฅt chแบฅp lแปi bรกo ฤแป)!"
echo ""
echo "๐ BฦฏแปC CUแปI CรNG:"
echo "   Copy danh sรกch ฤแปa chแป แป cแปt 'CHANNEL ADDRESS' (bรชn phแบฃi cรนng)."
echo "   Nแบกp 0.1 MYST (Polygon) vรo ฤรณ ฤแป Node chรญnh thแปฉc chแบกy."
