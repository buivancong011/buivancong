#!/bin/bash

# =================================================================
# CแบคU HรNH (BแบN PHแบขI SแปฌA 2 DรNG NรY)
# =================================================================
# 1. API Key lแบฅy tแบกi: https://my.mystnodes.com/me
MYST_API_KEY="nX51wlGwSBAmcZ6da2tKUqTf6kzDNRMCg1xIxCwT" 

# 2. Mแบญt khแบฉu bแบกn muแปn ฤแบทt cho Node (Thay cho viแปc nhแบญp trรชn web)
NODE_PASSWORD="MnX51wlGwSBAmcZ6da2tKUqTf6kzDNRMCg1xIxCwT"
# =================================================================

echo "========================================================"
echo "   MYSTERIUM AUTO ONBOARDING (CLI BASED)"
echo "========================================================"

# Lแบฅy danh sรกch cรกc container myst ฤang chแบกy
NODES=$(docker ps --format "{{.Names}}" | grep "myst")

if [ -z "$NODES" ]; then
    echo "โ Khรดng tรฌm thแบฅy container Mysterium nรo."
    exit 1
fi

for node in $NODES; do
    echo "Processing Node: $node..."

    # BฦฏแปC 1: CHแบคP NHแบฌN ฤIแปU KHOแบขN (Bแบฏt buแปc theo Docs)
    # Lแปnh: --agreed-terms-and-conditions
    docker exec "$node" sh -c "myst cli --agreed-terms-and-conditions >/dev/null 2>&1"
    echo "   โ ฤรฃ chแบฅp nhแบญn ฤiแปu khoแบฃn."

    # BฦฏแปC 2: CรI ฤแบถT MแบฌT KHแบจU CHO UI (Bแป qua bฦฐแปc Create Password trรชn mรn hรฌnh)
    # Chรบng ta can thiแปp vรo file config.toml thรดng qua lแปnh config set
    docker exec "$node" sh -c "myst config set 'tequilapi.pass'='$NODE_PASSWORD' >/dev/null 2>&1"
    echo "   โ ฤรฃ set mแบญt khแบฉu quแบฃn trแป."

    # BฦฏแปC 3: CLAIM NODE (Liรชn kแบฟt vแปi my.mystnodes.com)
    # Lแปnh: claims create [API_KEY]
    # Bฦฐแปc nรy sแบฝ bแป qua รด nhแบญp API Key trรชn mรn hรฌnh
    CLAIM_OUT=$(docker exec "$node" myst cli claims create "$MYST_API_KEY" 2>&1)
    
    if echo "$CLAIM_OUT" | grep -q "Error"; then
        # Nแบฟu ฤรฃ claim rแปi thรฌ nรณ sแบฝ bรกo lแปi, khรดng sao cแบฃ
        echo "   โ๏ธ  Thรดng bรกo Claim: $CLAIM_OUT"
    else
        echo "   โ Claim thรnh cรดng! Node ฤรฃ kแบฟt nแปi Dashboard."
    fi

    # BฦฏแปC 4: RESTART ฤแป รP DแปคNG PASSWORD
    docker restart "$node" >/dev/null
    echo "   ๐ ฤรฃ khแปi ฤแปng lแบกi node ฤแป รกp dแปฅng cแบฅu hรฌnh."
    echo "--------------------------------------------------------"
done

echo "๐ HOรN TแบคT!"
echo "๐ Bแบกn hรฃy thแปญ f5 lแบกi trang web 13.113...:4449."
echo "   Nรณ sแบฝ hแปi mแบญt khแบฉu (nhแบญp: $NODE_PASSWORD) thay vรฌ mรn hรฌnh Onboarding."
