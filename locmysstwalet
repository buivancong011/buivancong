#!/bin/bash

# =================================================================
# CแบคU HรNH (BแบฎT BUแปC ฤIแปN ฤรNG)
# =================================================================
# 1. API Key lแบฅy tแบกi: https://my.mystnodes.com/me
MYST_API_KEY="nX51wlGwSBAmcZ6da2tKUqTf6kzDNRMCg1xIxCwT" 

# 2. Mแบญt khแบฉu bแบกn muแปn ฤแบทt cho Web UI
NODE_PASSWORD="CAOcao123@"

# 3. Vรญ nhแบญn tiแปn (Nแบฟu cรณ)
MY_WALLET="0x22cBdE4c61BA69374169eB9B1a49d62Db3beCC7f"
# =================================================================

echo "========================================================"
echo "   MYSTERIUM FORCE FIX (AUTO ONBOARDING)"
echo "========================================================"

NODES=$(docker ps --format "{{.Names}}" | grep "myst")

if [ -z "$NODES" ]; then
    echo "โ Khรดng tรฌm thแบฅy container Mysterium nรo."
    exit 1
fi

for node in $NODES; do
    echo "--------------------------------------------------"
    echo "๐ง ฤang xแปญ lรฝ Node: $node"

    # 1. CHแบคP NHแบฌN ฤIแปU KHOแบขN (Bแบฑng lแปnh CLI trฦฐแปc)
    docker exec "$node" myst cli --agreed-terms-and-conditions >/dev/null 2>&1
    
    # 2. BIแปN PHรP MแบNH: Sแปญa file config.toml trแปฑc tiแบฟp
    # Chรบng ta dรนng sed ฤแป chรจn mแบญt khแบฉu vรo file cแบฅu hรฌnh
    echo "   ๐ ฤang ghi mแบญt khแบฉu vรo file cแบฅu hรฌnh..."
    
    # Lแปnh nรy tรฌm dรฒng [tequilapi] vร ฤแบฃm bแบฃo cรกc dรฒng pass ฤฦฐแปฃc set
    # Lฦฐu รฝ: Pass phแบฃi nแบฑm trong dแบฅu ngoแบทc kรฉp
    docker exec "$node" sh -c "sed -i 's/^pass = .*/pass = \"$NODE_PASSWORD\"/' /var/lib/mysterium-node/config.toml"
    
    # Nแบฟu trong file chฦฐa cรณ dรฒng pass (node mแปi tinh), ta chรจn vรo dฦฐแปi [tequilapi]
    # Kiแปm tra xem cรณ [tequilapi] chฦฐa, nแบฟu chฦฐa thรฌ thรชm vรo cuแปi
    docker exec "$node" sh -c "grep -q '\[tequilapi\]' /var/lib/mysterium-node/config.toml || echo -e '\n[tequilapi]\npass = \"$NODE_PASSWORD\"' >> /var/lib/mysterium-node/config.toml"
    
    # ฤแบฃm bแบฃo dรฒng pass tแปn tแบกi nแบฟu section ฤรฃ cรณ
    docker exec "$node" sh -c "grep -q 'pass =' /var/lib/mysterium-node/config.toml || sed -i '/\[tequilapi\]/a pass = \"$NODE_PASSWORD\"' /var/lib/mysterium-node/config.toml"

    # 3. RESTART NODE (Bแบฏt buแปc ฤแป file config cรณ hiแปu lแปฑc)
    echo "   ๐ Restart node ฤแป รกp dแปฅng..."
    docker restart "$node"
    
    # Chแป 10 giรขy cho node khแปi ฤแปng xong
    echo "   โณ ฤแปฃi 10s cho node khแปi ฤแปng..."
    sleep 10

    # 4. TแบO IDENTITY (Nแบฟu chฦฐa cรณ)
    echo "   ๐ Kiแปm tra Identity..."
    ID_CHECK=$(docker exec "$node" myst cli identities list)
    if [[ $ID_CHECK == *"Empty"* ]] || [[ -z $ID_CHECK ]]; then
         docker exec "$node" myst cli identities new >/dev/null 2>&1
    fi

    # 5. ฤฤNG Kร Vร (Register)
    echo "   ๐ฐ ฤang ฤฤng kรฝ vรญ..."
    docker exec "$node" myst cli identities register "$MY_WALLET" >/dev/null 2>&1

    # 6. LIรN KแบพT DASHBOARD (Claim)
    echo "   ๐ ฤang liรชn kแบฟt API Dashboard..."
    CLAIM_LOG=$(docker exec "$node" myst cli mmn "$MYST_API_KEY" 2>&1)
    
    if echo "$CLAIM_LOG" | grep -q "Error"; then
        echo "      โ๏ธ  Kแบฟt quแบฃ Claim: $CLAIM_LOG"
    else
        echo "      โ Claim thรnh cรดng!"
    fi

    echo "   โ Xong node $node"
done

echo "--------------------------------------------------"
echo "๐ ฤร HOรN TแบคT!"
echo "๐ Hรฃy thแปญ truy cแบญp lแบกi IP:4449."
echo "๐ Nแบฟu nรณ hแปi mแบญt khแบฉu, hรฃy nhแบญp: $NODE_PASSWORD"
