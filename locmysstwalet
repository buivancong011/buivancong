#!/bin/bash

# =================================================================
# Cáº¤U HÃŒNH (Sá»¬A Láº I API VÃ€ VÃ Cá»¦A Báº N)
# =================================================================
# 1. API Key (Láº¥y táº¡i my.mystnodes.com/me)
MYST_API_KEY="nX51wlGwSBAmcZ6da2tKUqTf6kzDNRMCg1xIxCwT" 

# 2. VÃ­ nháº­n tiá»n (VÃ­ chÃ­nh Polygon/Metamask)
MY_WALLET="0x22cBdE4c61BA69374169eB9B1a49d62Db3beCC7f"
# =================================================================

echo "========================================================"
echo "   MYSTERIUM SMART SETUP (SKIP IF REGISTERED)"
echo "========================================================"

NODES=$(docker ps --format "{{.Names}}" | grep "myst")

if [ -z "$NODES" ]; then echo "âŒ KhÃ´ng tÃ¬m tháº¥y node."; exit 1; fi

# Táº¡o file danh sÃ¡ch náº¡p tiá»n (chá»‰ lÆ°u nhá»¯ng node chÆ°a active)
> myst_topup_needed.txt

printf "%-10s | %-15s | %-42s\n" "NODE" "TRáº NG THÃI" "HÃ€NH Äá»˜NG / CHANNEL ADDRESS"
echo "--------------------------------------------------------------------------------------------------------"

for node in $NODES; do
    # 1. Láº¤Y IDENTITY
    RAW_LIST=$(docker exec "$node" myst cli identities list)
    ID=$(echo "$RAW_LIST" | grep -oE '0x[a-fA-F0-9]{40}' | head -n 1)

    # Náº¿u chÆ°a cÃ³ ID thÃ¬ táº¡o má»›i
    if [ -z "$ID" ]; then
        docker exec "$node" myst cli identities new >/dev/null 2>&1
        ID=$(docker exec "$node" myst cli identities list | grep -oE '0x[a-fA-F0-9]{40}' | head -n 1)
    fi

    # 2. KIá»‚M TRA TRáº NG THÃI (BÆ°á»›c thÃ´ng minh má»›i thÃªm)
    INFO=$(docker exec "$node" myst cli identities get "$ID" 2>&1)
    
    if echo "$INFO" | grep -q "Registration Status: Registered"; then
        # === TRÆ¯á»œNG Há»¢P 1: ÄÃƒ ÄÄ‚NG KÃ XONG ===
        # Chá»‰ Ä‘áº£m báº£o service Ä‘ang cháº¡y, cÃ²n láº¡i bá» qua háº¿t
        docker exec "$node" myst cli service start "$ID" wireguard >/dev/null 2>&1
        printf "%-10s | \e[32mRegistered âœ…\e[0m  | Bá» qua cÃ i Ä‘áº·t (ÄÃ£ cháº¡y á»•n)\n" "$node"
        continue 
    fi

    # === TRÆ¯á»œNG Há»¢P 2: CHÆ¯A ÄÄ‚NG KÃ (LÃ m Ä‘á»§ quy trÃ¬nh) ===
    
    # A. Unlock
    docker exec "$node" myst cli identities unlock "$ID" >/dev/null 2>&1

    # B. MMN Connect
    docker exec "$node" myst cli mmn "$MYST_API_KEY" >/dev/null 2>&1

    # C. Register (KÃ¨m vÃ­)
    docker exec "$node" myst cli identities register "$ID" "$MY_WALLET" >/dev/null 2>&1

    # D. Force Set Beneficiary (Báº¥t cháº¥p lá»—i)
    docker exec "$node" myst cli identities beneficiary-set "$ID" "$MY_WALLET" >/dev/null 2>&1 || true

    # E. Start Wireguard
    docker exec "$node" myst cli service start "$ID" wireguard >/dev/null 2>&1

    # F. Láº¥y Channel Address Ä‘á»ƒ náº¡p tiá»n
    # Láº¥y láº¡i info má»›i nháº¥t sau khi register
    INFO_NEW=$(docker exec "$node" myst cli identities get "$ID")
    CHANNEL_ADDR=$(echo "$INFO_NEW" | grep "Channel address" | awk '{print $NF}')

    printf "%-10s | \e[31mUnregistered âŒ\e[0m | Cáº§n náº¡p tiá»n: %s\n" "$node" "$CHANNEL_ADDR"
    
    # LÆ°u vÃ o file
    echo "$CHANNEL_ADDR" >> myst_topup_needed.txt

done

echo "--------------------------------------------------------------------------------------------------------"
echo "ğŸ‰ HOÃ€N Táº¤T!"
echo "ğŸ‘‰ Nhá»¯ng node bÃ¡o 'Registered âœ…' lÃ  Ä‘Ã£ xong, khÃ´ng cáº§n lÃ m gÃ¬ thÃªm."
echo "ğŸ‘‰ Nhá»¯ng node bÃ¡o 'Unregistered âŒ' -> Copy Ä‘á»‹a chá»‰ Channel Address vÃ  náº¡p tiá»n (0.1 MYST)."
