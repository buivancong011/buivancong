#!/bin/bash

# ==== Cáº¤U HÃŒNH ====
# Danh sÃ¡ch tÃªn container cáº§n check
NODES=("tm1" "tm2" "tm")

# Tá»« khÃ³a xÃ¡c nháº­n lÃ  Ä‘ang cháº¡y á»•n (Viáº¿t thÆ°á»ng háº¿t)
KEYWORD="connected"

# ==== LOGIC CHECK ====
echo "Starting check at $(date)"

for node in "${NODES[@]}"; do
    # 1. Kiá»ƒm tra xem container cÃ³ Ä‘ang cháº¡y khÃ´ng
    if [ ! "$(docker ps -q -f name=^/${node}$)" ]; then
        echo "âŒ Node $node Ä‘ang táº¯t -> Khá»Ÿi Ä‘á»™ng láº¡i..."
        docker start "$node"
        continue
    fi

    # 2. Láº¥y dÃ²ng log cuá»‘i cÃ¹ng
    LAST_LOG=$(docker logs --tail 1 "$node" 2>&1 | tr '[:upper:]' '[:lower:]')

    # 3. Kiá»ƒm tra tá»« khÃ³a "connected"
    if [[ "$LAST_LOG" == *"$KEYWORD"* ]]; then
        echo "âœ… $node: á»”n Ä‘á»‹nh ($LAST_LOG)"
    else
        echo "âš ï¸  $node: DÃ²ng cuá»‘i láº¡ ('$LAST_LOG'). Chá» 10s Ä‘á»ƒ check láº¡i..."
        sleep 10
        
        # Check láº¡i láº§n 2 (Double check)
        LAST_LOG_2=$(docker logs --tail 1 "$node" 2>&1 | tr '[:upper:]' '[:lower:]')
        
        if [[ "$LAST_LOG_2" == *"$KEYWORD"* ]]; then
             echo "âœ… $node: ÄÃ£ tá»± phá»¥c há»“i ($LAST_LOG_2)"
        else
             echo "Mq $node: Váº«n lá»—i -> ğŸ”„ RESTARTING..."
             docker restart "$node"
             echo "   -> ÄÃ£ restart xong."
        fi
    fi
done
echo "---------------------------------"
