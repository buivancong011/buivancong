
#!/bin/bash
set -Eeuo pipefail

# ===================== CONFIG =====================
# Khai báo upstream proxy dạng URI. Có thể trộn nhiều loại:
# - HTTP(S):  http://user:pass@host:port
# - SOCKS5:   socks5://user:pass@host:port
# - Shadowsocks: ss://method:password@host:port
# - VMess/Trojan/VLESS/...: để glider -forward tương ứng (xem docs glider)
UPSTREAMS=(
"http://user45643:1759408234@s13.pxus.live:45643"
"http://user42560:1759408279@s13.pxus.live:42560"
"http://user53427:1759027512@s13.pxus.live:53427"
"http://user44464:1758955610@s13.pxus.live:44464"
"http://user51051:1759909541@s3.pxus.live:51051"
"http://user29147:1758163586@s13.pxus.live:29147"
"http://user21772:1759114887@s13.pxus.live:21772"
"http://user11689:1758163586@s3.pxus.live:11689"
"http://user17044:1759592711@s13.pxus.live:17044"
"http://user33846:1759040239@s13.pxus.live:33846"
"http://user48070:1759040270@s13.pxus.live:48070"
"http://user57610:1758955610@s13.pxus.live:57610"
"http://user10048:1758955640@s13.pxus.live:10048"
"http://user15487:1759408264@s13.pxus.live:15487"
"http://user22864:1759408279@s13.pxus.live:22864"
"http://user25491:1758163616@s13.pxus.live:25491"
"http://user17038:1759040194@s13.pxus.live:17038"
"http://user38616:1758591914@s13.pxus.live:38616"
"http://user16724:1758357040@s3.pxus.live:16724"
"http://user27339:1759889716@s13.pxus.live:27339"
"http://user44368:1759114857@s13.pxus.live:44368"
"http://user35315:1758477735@s11.pxus.live:35315"
"http://user47976:1759408249@s13.pxus.live:47976"
"http://user27543:1758906789@s11.pxus.live:27543"
"http://user33365:1759890377@s13.pxus.live:33365"
"http://user24857:1758906804@s11.pxus.live:24857"
"http://user15130:1759408279@s13.pxus.live:15130"
"http://user58560:1759889716@s13.pxus.live:58560"
"http://user27577:1759040224@s13.pxus.live:27577"
"http://user19946:1758163646@s11.pxus.live:19946"
"http://k98z:k98z@s1.pxus.live:38193"
"http://user14795:1759806349@s11.pxus.live:14795"
"http://user18126:1759256183@s11.pxus.live:18126"
"http://user17062:1758906744@s11.pxus.live:17062"
"http://user20154:1758772663@s2.pxus.live:20154"
"http://user39471:1759884674@s11.pxus.live:39471"
"http://user58369:1759040239@s13.pxus.live:58369"
"http://user21085:1759040270@s13.pxus.live:21085"
"http://user26763:1758477780@s11.pxus.live:26763"
"http://user46758:1759040300@s13.pxus.live:46758"
"http://user38905:1758906789@s11.pxus.live:38905"
"http://user35721:1759806334@s11.pxus.live:35721"
"http://user41764:1756578161@s1.pxus.live:41764"
"http://user40927:1759408234@s13.pxus.live:40927"
"http://user19215:1758897005@s11.pxus.live:19215"
"http://user19661:1758907029@s11.pxus.live:19661"
"http://user24482:1758163586@s3.pxus.live:24482"
"http://user20053:1758685535@s1.pxus.live:20053"
"http://user12293:1758259144@s13.pxus.live:12293"
"http://user18586:1759114857@s13.pxus.live:18586"
"http://user21015:1758906789@s11.pxus.live:21015"
"http://user43645:1758477675@s11.pxus.live:43645"
"http://user28690:1758955655@s13.pxus.live:28690"
"http://user25596:1758570304@s13.pxus.live:25596"
"http://user33219:1759851010@s13.pxus.live:33219"
"http://user26859:1758163586@s13.pxus.live:26859"
"http://user35833:1758477675@s11.pxus.live:35833"
"http://user19086:9kv6@s11.pxus.live:19086"
"http://user17940:1756576150@s11.pxus.live:17940"
"http://user32079:1759884674@s11.pxus.live:32079"
"http://user26235:1758477780@s11.pxus.live:26235"
"http://user19351:1758477690@s11.pxus.live:19351"
"http://user44903:1758283216@s11.pxus.live:44903"
"http://user38073:1758477765@s11.pxus.live:38073"
"http://user34482:1758477765@s11.pxus.live:34482"
"http://user38510:1759806349@s11.pxus.live:38510"
"http://user41783:1758433506@s3.pxus.live:41783"
"http://user55376:1758360642@s3.pxus.live:55376"





)


# Cổng SOCKS5 lắng nghe trên host cho từng tuyến (tuyến i dùng START_SOCKS+i)
START_SOCKS=1080

# Tên base cho container theo tuyến
GLIDER_NAME_BASE="glider"
TUN_NAME_BASE="tun"
DOH_NAME_BASE="doh"

# Phiên bản image
IMG_GLIDER="nadoo/glider:latest"
IMG_TUN="xjasonlyu/tun2socks:v2.6.0"
IMG_DOH="cloudflare/cloudflared:latest"

# Log level cho tun2socks
TUN_LOGLEVEL="info"   # debug|info|warn|error

# MTU tuỳ tuyến (để trống để mặc định). Ví dụ 1400 nếu gặp timeouts:
TUN_MTU=""            # ví dụ: "1400"

# ===================== PRECHECK =====================
command -v docker >/dev/null 2>&1 || { echo "[ERR] Cần Docker."; exit 1; }

# Linux cần /dev/net/tun
if [[ ! -e /dev/net/tun ]]; then
  echo "[INFO] Tạo /dev/net/tun..."
  sudo mkdir -p /dev/net || true
  sudo mknod /dev/net/tun c 10 200 || true
  sudo chmod 600 /dev/net/tun || true
fi

# ===================== FUNCTIONS =====================
cleanup_route() {
  local idx="$1"
  local g="${GLIDER_NAME_BASE}${idx}"
  local t="${TUN_NAME_BASE}${idx}"
  local d="${DOH_NAME_BASE}${idx}"
  docker rm -f "$d" "$t" "$g" >/dev/null 2>&1 || true
}

start_route() {
  local idx="$1"
  local upstream="$2"
  local socks_port=$((START_SOCKS + idx - 1))

  local g="${GLIDER_NAME_BASE}${idx}"
  local t="${TUN_NAME_BASE}${idx}"
  local d="${DOH_NAME_BASE}${idx}"
  local resolv_file="resolv_${idx}.conf"

  echo "------------------------------------------------------------"
  echo "[ROUTE $idx] Upstream: $upstream"
  echo "[ROUTE $idx] SOCKS5 listen on host: ${socks_port}"

  # 1) Cleanup cũ
  cleanup_route "$idx"

  # 2) Tạo glider: chuyển mọi upstream -> SOCKS5 cục bộ
  echo "[ROUTE $idx] Khởi chạy glider -> socks5://0.0.0.0:${socks_port}"
  docker run -d --name "$g" --restart=always --network host "$IMG_GLIDER" \
    -verbose \
    -listen "socks5://0.0.0.0:${socks_port}" \
    -forward "$upstream"

  # 3) resolv.conf cục bộ (DNS sẽ hỏi 127.0.0.1 trong namespace tun)
  cat > "$resolv_file" <<EOF
options ndots:0
nameserver 127.0.0.1
EOF

  # 4) tun2socks
  #   PROXY trỏ tới SOCKS5 trên host qua địa chỉ bridge 172.17.0.1 (Linux Docker)
  #   Nếu hệ khác, có thể đổi sang host.docker.internal:PORT (Docker Desktop)
  echo "[ROUTE $idx] Khởi chạy tun2socks..."
  docker run -d --name "$t" --restart=always \
    --cap-add=NET_ADMIN \
    -v /dev/net/tun:/dev/net/tun \
    -v "$PWD/$resolv_file":/etc/resolv.conf:ro \
    -e PROXY="socks5://172.17.0.1:${socks_port}" \
    -e LOGLEVEL="$TUN_LOGLEVEL" \
    -e EXTRA_COMMANDS="ip rule add iif lo ipproto udp dport 53 lookup main;" \
    "$IMG_TUN"

  # Tuỳ chọn set MTU nếu cấu hình
  if [[ -n "${TUN_MTU}" ]]; then
    echo "[ROUTE $idx] Set MTU=${TUN_MTU} (best-effort)"
    docker exec -it "$t" sh -c "ip link set dev tun0 mtu ${TUN_MTU} || true"
  fi

  # 5) Cloudflared DoH trong cùng namespace với tun
  echo "[ROUTE $idx] Khởi chạy cloudflared DoH..."
  docker run -d --name "$d" --restart=always \
    --network=container:"$t" \
    --user root \
    "$IMG_DOH" \
    proxy-dns --address 127.0.0.1 --port 53

  # 6) Kiểm tra IP qua tuyến
  echo "[ROUTE $idx] Kiểm tra IP egress..."
  docker run --rm --network=container:"$t" curlimages/curl:latest -s https://ifconfig.me || true
  echo
  echo "[ROUTE $idx] SẴN SÀNG. Gắn container vào tuyến này bằng:"
  echo "  docker run ... --network=container:${t} <image> ..."
}

down_all() {
  echo "[CLEANUP] Xoá toàn bộ tuyến..."
  local i=1
  for _ in "${UPSTREAMS[@]}"; do
    cleanup_route "$i"
    rm -f "resolv_${i}.conf" || true
    ((i++))
  done
  echo "[DONE] Đã xoá."
}

status_all() {
  local i=1
  for _ in "${UPSTREAMS[@]}"; do
    local t="${TUN_NAME_BASE}${i}"
    if docker ps --format '{{.Names}}' | grep -qx "$t"; then
      printf "[STATUS] %s " "$t"
      docker run --rm --network=container:"$t" curlimages/curl:latest -s https://ifconfig.me || true
    else
      echo "[STATUS] $t: not running"
    fi
    ((i++))
  done
}

# ===================== CLI =====================
# ./script.sh          -> khởi chạy tất cả tuyến
# ./script.sh status   -> in IP từng tuyến
# ./script.sh down     -> xoá toàn bộ tuyến
case "${1:-up}" in
  up)
    i=1
    for up in "${UPSTREAMS[@]}"; do
      start_route "$i" "$up"
      ((i++))
    done
    echo
    echo "✅ ĐÃ KHỞI TẠO ${#UPSTREAMS[@]} TUYẾN."
    echo "👉 Gắn container client vào tuyến N:  --network=container:tunN"
    ;;
  status)
    status_all
    ;;
  down)
    down_all
    ;;
  *)
    echo "Usage: $0 [up|status|down]"
    exit 1
    ;;
esac
