#!/bin/bash
set -e

# ==== C·∫§U H√åNH ====
TOKEN_EARNFM="50f04bbe-94d9-4f6a-82b9-b40016bd4bbb"
IMG_EARN="earnfm/earnfm-client:latest"

# M√†u s·∫Øc
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m'

log() { echo -e "${GREEN}[INFO] $1${NC}"; }
warn() { echo -e "${YELLOW}[WARN] $1${NC}"; }

# ==== 1. D·ªåN D·∫∏P EARNFM C≈® ====
log "ƒêang d·ªçn d·∫πp c√°c container EarnFM c≈©..."
# T√¨m v√† x√≥a t·∫•t c·∫£ container c√≥ t√™n b·∫Øt ƒë·∫ßu b·∫±ng 'earnfm'
CONTAINERS=$(docker ps -a --filter "name=earnfm" --format "{{.Names}}")

if [ -n "$CONTAINERS" ]; then
    for c in $CONTAINERS; do
        log "X√≥a container: $c"
        docker rm -f "$c" >/dev/null 2>&1
    done
else
    warn "Kh√¥ng t√¨m th·∫•y container EarnFM n√†o ƒëang ch·∫°y."
fi

# ==== 2. KH·ªûI CH·∫†Y L·∫†I TR√äN C√ÅC NETWORK ====
# H√†m ch·∫°y node cho t·ª´ng network
run_earnfm() {
    local ID=$1
    local NET="my_network_$ID"

    # Ki·ªÉm tra xem network c√≥ t·ªìn t·∫°i kh√¥ng tr∆∞·ªõc khi ch·∫°y
    if docker network inspect "$NET" >/dev/null 2>&1; then
        log "üöÄ ƒêang kh·ªüi t·∫°o earnfm$ID tr√™n $NET..."
        docker run -d \
            --name "earnfm$ID" \
            --network "$NET" \
            --restart always \
            --dns 1.1.1.1 \
            --dns 1.0.0.1 \
            -e EARNFM_TOKEN="$TOKEN_EARNFM" \
            "$IMG_EARN" >/dev/null
        log "‚úÖ earnfm$ID ƒë√£ s·∫µn s√†ng."
    else
        echo -e "${RED}[ERROR] Network $NET kh√¥ng t·ªìn t·∫°i. B·ªè qua node $ID.${NC}"
    fi
}

# Th·ª±c thi cho IP 1 v√† IP 2 (√îng c√≥ th·ªÉ th√™m 3, 4... n·∫øu mu·ªën)
run_earnfm 1
run_earnfm 2

# ==== 3. T·ªîNG K·∫æT ====
echo "----------------------------------------------------"
log "HO√ÄN T·∫§T: To√†n b·ªô node EarnFM ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t DNS & Token."
docker ps --filter "name=earnfm" --format "table {{.Names}}\t{{.Status}}\t{{.Image}}"
