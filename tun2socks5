#!/bin/bash
set -Eeuo pipefail

# ===================== CONFIG =====================
# Khuyến nghị dùng socks5h:// để chắc chắn DNS qua proxy
# Có thể là:
#  - socks5h://IP:PORT
#  - socks5h://user:pass@IP:PORT
UPSTREAMS=(
"socks5h://156.239.215.254:1339"
"socks5h://156.239.204.25:1339"
"socks5h://156.239.201.49:1339"
"socks5h://156.239.202.151:1339"
"socks5h://156.239.201.0:1339"
"socks5h://156.239.196.11:1339"
"socks5h://156.239.203.251:1339"
"socks5h://156.239.205.107:1339"
"socks5h://156.239.198.52:1339"
"socks5h://156.239.195.73:1339"
"socks5h://156.239.197.103:1339"
"socks5h://156.239.199.213:1339"
"socks5h://156.239.199.167:1339"
"socks5h://156.239.204.52:1339"
"socks5h://156.239.202.70:1339"
"socks5h://156.239.205.75:1339"
"socks5h://156.239.204.206:1339"
"socks5h://156.239.200.103:1339"
"socks5h://156.239.193.62:1339"
"socks5h://156.239.197.99:1339"
"socks5h://156.239.198.0:1339"
"socks5h://156.239.203.195:1339"
"socks5h://156.239.197.224:1339"
"socks5h://156.239.199.24:1339"
"socks5h://156.239.193.140:1339"
"socks5h://156.239.194.142:1339"
"socks5h://156.239.207.106:1339"
"socks5h://156.239.207.0:1339"
"socks5h://156.239.203.225:1339"
"socks5h://156.239.205.187:1339"
"socks5h://156.239.200.202:1339"
"socks5h://156.239.194.91:1339"
"socks5h://156.239.203.182:1339"
"socks5h://156.239.192.94:1339"
"socks5h://156.239.198.202:1339"
"socks5h://156.239.200.17:1339"
"socks5h://156.239.205.239:1339"
"socks5h://156.239.194.215:1339"
"socks5h://156.239.200.138:1339"
"socks5h://156.239.195.69:1339"
"socks5h://156.239.192.177:1339"
"socks5h://156.239.201.64:1339"
"socks5h://156.239.205.121:1339"
"socks5h://156.239.201.114:1339"
"socks5h://156.239.192.11:1339"
"socks5h://156.239.206.200:1339"
"socks5h://156.239.199.234:1339"
"socks5h://156.239.195.189:1339"
"socks5h://156.239.207.222:1339"
"socks5h://156.239.199.103:1339"
"socks5h://156.239.197.3:1339"
"socks5h://156.239.223.107:1339"
"socks5h://156.239.213.44:1339"
"socks5h://156.239.221.33:1339"
"socks5h://156.239.220.58:1339"
"socks5h://156.239.218.103:1339"
"socks5h://156.239.212.135:1339"
"socks5h://156.239.211.246:1339"
"socks5h://156.239.217.126:1339"
"socks5h://156.239.212.18:1339"
"socks5h://156.239.219.82:1339"
"socks5h://156.239.219.113:1339"
"socks5h://156.239.215.30:1339"
"socks5h://156.239.209.42:1339"
"socks5h://156.239.216.53:1339"
"socks5h://156.239.212.140:1339"
"socks5h://156.239.215.254:1339"
"socks5h://156.239.221.183:1339"
"socks5h://156.239.211.102:1339"
"socks5h://156.239.217.246:1339"
"socks5h://156.239.213.129:1339"
"socks5h://156.239.222.188:1339"
"socks5h://156.239.216.106:1339"
"socks5h://156.239.210.1:1339"
"socks5h://156.239.209.140:1339"
"socks5h://156.239.218.68:1339"
"socks5h://156.239.216.147:1339"
"socks5h://156.239.222.133:1339"  # <-- NOTE: original line had port 1338 at end, kept IP and changed to 1339
"socks5h://156.239.213.255:1339"
"socks5h://156.239.211.114:1339"
"socks5h://156.239.215.101:1339"
"socks5h://156.239.223.9:1339"
"socks5h://156.239.221.24:1339"
"socks5h://156.239.217.162:1339"
"socks5h://156.239.220.207:1339"
"socks5h://156.239.222.138:1339"
"socks5h://156.239.221.166:1339"
"socks5h://156.239.219.45:1339"
"socks5h://156.239.217.172:1339"
"socks5h://156.239.223.220:1339"
"socks5h://156.239.215.54:1339"
"socks5h://156.239.220.5:1339"
"socks5h://156.239.214.6:1339"
"socks5h://156.239.221.23:1339"
"socks5h://156.239.221.105:1339"
"socks5h://156.239.218.63:1339"
"socks5h://156.239.222.201:1339"
"socks5h://156.239.212.73:1339"
"socks5h://156.239.219.187:1339"
"socks5h://156.239.214.181:1339"
"socks5h://156.239.217.223:1339"
"socks5h://156.239.217.246:1339"
)


# Tên base cho container theo tuyến
TUN_NAME_BASE="tun"

# Ảnh tun2socks
IMG_TUN="xjasonlyu/tun2socks:v2.6.0"

# Log level: debug | info | warn | error
TUN_LOGLEVEL="info"

# MTU (để trống = mặc định). Nếu hay timeout, thử 1400.
TUN_MTU=""

# DNS resolver bên trong namespace của tun.
# Do đã ép TCP (use-vc), truy vấn DNS sẽ đi qua proxy an toàn.
TUN_RESOLVER="1.1.1.1"     # có thể đổi 8.8.8.8 / 9.9.9.9

# Probe để lọc proxy chết trước khi khởi chạy tuyến
PROBE_MAX_RETRY=1          # số lần thử lại (tổng 1+ lần)
PROBE_TIMEOUT=8            # giây

# ===================== PRECHECK =====================
command -v docker >/dev/null 2>&1 || { echo "[ERR] Cần Docker."; exit 1; }

if [[ ! -e /dev/net/tun ]]; then
  echo "[INFO] Tạo /dev/net/tun..."
  sudo mkdir -p /dev/net || true
  sudo mknod /dev/net/tun c 10 200 || true
  sudo chmod 600 /dev/net/tun || true
fi

# ===================== HELPERS =====================
validate_socks() {
  local u="$1"
  # Hỗ trợ socks5:// hoặc socks5h://, có/không user:pass
  [[ "$u" =~ ^socks5(h)?://([^/@:]+:[^/@]+@)?([0-9]{1,3}\.){3}[0-9]{1,3}:[0-9]+$ ]]
}

probe_proxy_once() {
  local u="$1"
  # Với socks5h sẽ test cả DNS qua proxy
  curl -sSx "$u" -I "https://www.google.com" --max-time "$PROBE_TIMEOUT" >/dev/null 2>&1
}

probe_proxy() {
  local u="$1"
  local i
  for ((i=0; i<=PROBE_MAX_RETRY; i++)); do
    if probe_proxy_once "$u"; then return 0; fi
    sleep 1
  done
  return 1
}

wait_until_running() {
  local name="$1"
  local timeout="${2:-25}"   # giây
  local i=0 st="missing"
  while (( i < timeout )); do
    st="$(docker inspect -f '{{.State.Status}}' "$name" 2>/dev/null || echo "missing")"
    if [[ "$st" == "running" ]]; then return 0; fi
    sleep 1; ((i++))
  done
  echo "[WAIT] $name chưa running (status: $st)"
  return 1
}

cleanup_route() {
  local idx="$1"
  docker rm -f "${TUN_NAME_BASE}${idx}" >/dev/null 2>&1 || true
  rm -f "resolv_${idx}.conf" || true
}

start_route() {
  local idx="$1"
  local upstream="$2"
  local t="${TUN_NAME_BASE}${idx}"
  local resolv_file="resolv_${idx}.conf"

  echo "------------------------------------------------------------"
  echo "[ROUTE $idx] Upstream: $upstream"

  # 0) Validate URL
  if ! validate_socks "$upstream"; then
    echo "[ROUTE $idx] ❌ URL không hợp lệ → bỏ qua."
    return 0
  fi

  # 1) Probe proxy (lọc upstream chết)
  if ! probe_proxy "$upstream"; then
    echo "[ROUTE $idx] ❌ Proxy không phản hồi (probe fail) → bỏ qua."
    return 0
  fi

  # 2) Cleanup cũ
  cleanup_route "$idx"

  # 3) resolv.conf trong namespace tun — ép DNS dùng TCP (use-vc)
  cat > "$resolv_file" <<EOF
options ndots:0
options use-vc
options attempts:2
options timeout:3
nameserver ${TUN_RESOLVER}
EOF

  # 4) Chạy tun2socks
  # LƯU Ý: EXTRA_COMMANDS="" để KHÔNG bypass UDP/53 → toàn bộ DNS của namespace vẫn đi qua tun (và do use-vc
