#!/usr/bin/env bash
set -Eeuo pipefail

# ===================== CONFIG =====================
TUN_IMAGE="xjasonlyu/tun2socks:v2.6.0"
DNS_RESOLVER_FILE="resolv.conf"
TUN_LIMITS="--cpus=0.15 --memory=96m --memory-swap=96m"
LOGS=false
TEST_URL="https://api.ipify.org"
UNIQUE_ID_FILE=".net_tun_unique_id"
CONTAINER_LIST_FILE="tun_containers.txt"

# ================== PROXY ÄÃƒ Äá»”I Sáº´N 1339 ==================
PROXIES=(
"socks5://156.239.204.25:1339"
"socks5://156.239.201.49:1339"
"socks5://156.239.202.151:1339"
"socks5://156.239.201.0:1339"
"socks5://156.239.196.11:1339"
"socks5://156.239.203.251:1339"
"socks5://156.239.205.107:1339"
"socks5://156.239.198.52:1339"
"socks5://156.239.195.73:1339"
"socks5://156.239.197.103:1339"
# ... (pháº§n cÃ²n láº¡i tÆ°Æ¡ng tá»± â€” táº¥t cáº£ Ä‘Ã£ lÃ  :1339)
)

log_params() {
  [[ "$LOGS" == "true" ]] && echo "--log-driver=json-file --log-opt max-size=100k" || echo "--log-driver none"
}

ensure_deps() {
  if ! command -v docker >/dev/null 2>&1; then
    echo "âŒ Docker chÆ°a cÃ i." ; exit 1
  fi
  printf 'nameserver 8.8.8.8\nnameserver 1.1.1.1\nnameserver 9.9.9.9\n' > "$DNS_RESOLVER_FILE"
}

persist_uid() {
  if [[ -f "$UNIQUE_ID_FILE" ]]; then
    UNIQUE_ID="$(cat "$UNIQUE_ID_FILE")"
  else
    UNIQUE_ID="$(tr -dc 'a-f0-9' </dev/urandom | dd bs=1 count=16 2>/dev/null)"
    echo "$UNIQUE_ID" > "$UNIQUE_ID_FILE"
  fi
}

start_all() {
  ensure_deps
  persist_uid
  local logs; logs="$(log_params)"
  docker pull "$TUN_IMAGE" >/dev/null
  : > "$CONTAINER_LIST_FILE"

  local i=0
  for proxy in "${PROXIES[@]}"; do
    i=$((i+1))
    local name="tun${UNIQUE_ID}${i}"

    if docker run -d --name "$name" \
        $TUN_LIMITS $logs \
        -v "$PWD/$DNS_RESOLVER_FILE:/etc/resolv.conf:ro" \
        -v /dev/net/tun:/dev/net/tun \
        --cap-add=NET_ADMIN \
        -e LOGLEVEL=silent \
        -e PROXY="$proxy" \
        -e EXTRA_COMMANDS="ip rule add iif lo ipproto udp dport 53 lookup main;" \
        --restart=always \
        "$TUN_IMAGE" >/dev/null; then
      echo "$name" >> "$CONTAINER_LIST_FILE"
      echo "âœ… $name ($proxy)"
    else
      echo "âŒ Lá»—i $proxy" >&2
    fi
  done
  echo "âž¡ï¸  Tá»•ng sá»‘ tuyáº¿n: $i"
}

down_all() {
  [[ -f "$CONTAINER_LIST_FILE" ]] && while read -r name; do
    docker rm -f "$name" >/dev/null 2>&1 && echo "ðŸ§¹ XoÃ¡ $name"
  done <"$CONTAINER_LIST_FILE"
  rm -f "$CONTAINER_LIST_FILE" "$DNS_RESOLVER_FILE"
}

status_all() {
  echo "=== TUN status ==="
  docker ps --format "table {{.Names}}\t{{.Status}}" | grep -E '^tun' || echo "KhÃ´ng cÃ³ tuyáº¿n nÃ o."
  [[ -f "$CONTAINER_LIST_FILE" ]] && nl -ba "$CONTAINER_LIST_FILE"
}

case "${1:-}" in
  --up) start_all ;;
  --down) down_all ;;
  --status) status_all ;;
  *) echo "DÃ¹ng: $0 --up | --down | --status" ;;
esac
