#!/bin/bash
set -Eeuo pipefail

# ===================== CONFIG =====================
# Danh sách SOCKS5 dạng "ip:port:user:pass"
PROXIES=(
"156.239.204.25:1339:cao_nAEfN2:g2Bawi4kkDZyztX"
"156.239.201.49:1339:cao_nAEfN2:g2Bawi4kkDZyztX"
"156.239.202.151:1339:cao_nAEfN2:g2Bawi4kkDZyztX"
"156.239.201.0:1339:cao_nAEfN2:g2Bawi4kkDZyztX"
"156.239.196.11:1339:cao_nAEfN2:g2Bawi4kkDZyztX"
"156.239.203.251:1339:cao_nAEfN2:g2Bawi4kkDZyztX"
"156.239.205.107:1339:cao_nAEfN2:g2Bawi4kkDZyztX"
"156.239.198.52:1339:cao_nAEfN2:g2Bawi4kkDZyztX"
"156.239.195.73:1339:cao_nAEfN2:g2Bawi4kkDZyztX"
"156.239.197.103:1339:cao_nAEfN2:g2Bawi4kkDZyztX"
)

IMG_SBOX="ghcr.io/sagernet/sing-box:latest"  # image sing-box
SBOX_BASE="sbox"                             # prefix tên container
MTU="1400"                                   # MTU cho TUN
DNS_MODE="${DNS_MODE:-doh}"                  # doh | direct53

# /etc/resolv.conf trong netns sbox (app dùng khi --network=container:sboxN)
RESOLV_CONTENT=$'nameserver 8.8.8.8\nnameserver 1.1.1.1\noptions ndots:0'

# ===================== PRECHECK RẤT NHẸ =====================
command -v docker >/dev/null 2>&1 || { echo "[ERR] Cần Docker."; exit 1; }
if [[ ! -e /dev/net/tun ]]; then
  sudo mkdir -p /dev/net || true
  sudo mknod /dev/net/tun c 10 200 || true
  sudo chmod 666 /dev/net/tun || true
fi

# ===================== FUNCS =====================
mk_sbox_config() {
  # $1: file, $2: ip, $3: port, $4: user, $5: pass
  local cfg="$1" ip="$2" port="$3" user="$4" pass="$5"
  local dns_block route_rule_block

  if [[ "$DNS_MODE" == "doh" ]]; then
    # DoH (HTTPS) đi qua outbound "proxy" + hijack-dns + block UDP còn lại
    dns_block='
  "dns": {
    "servers": [
      { "address": "https://1.1.1.1/dns-query", "strategy": "ipv4_only", "detour": "proxy" },
      { "address": "https://dns.google/dns-query", "strategy": "ipv4_only", "detour": "proxy" }
    ],
    "strategy": "ipv4_only"
  },'
    route_rule_block='
      { "action": "hijack-dns" },
      { "network": "udp", "outbound": "block" }'
  else
    # DNS 53 direct (giữ hành vi cũ, format DNS mới)
    dns_block='
  "dns": {
    "servers": [
      { "address": "udp://8.8.8.8", "strategy": "ipv4_only" },
      { "address": "udp://1.1.1.1", "strategy": "ipv4_only" }
    ],
    "strategy": "ipv4_only"
  },'
    route_rule_block='
      { "port": 53, "outbound": "direct" }'
  fi

  cat > "$cfg" <<JSON
{
  "log": { "level": "warn" },

${dns_block}

  "inbounds": [
    {
      "type": "tun",
      "interface_name": "tun0",
      "address": ["172.19.0.1/30"],
      "auto_route": true,
      "strict_route": false,
      "sniff": true,
      "mtu": ${MTU}
    }
  ],

  "outbounds": [
    {
      "tag": "proxy",
      "type": "socks",
      "server": "${ip}",
      "server_port": ${port},
      "version": "5",
      "username": "${user}",
      "password": "${pass}"
    },
    { "tag": "direct", "type": "direct" },
    { "tag": "block",  "type": "block" }
  ],

  "route": {
    "auto_detect_interface": true,
    "rules": [${route_rule_block}
    ],
    "final": "proxy"
  }
}
JSON
}

cleanup_one() {
  local idx="$1"
  local s="${SBOX_BASE}${idx}"
  docker rm -f "$s" >/dev/null 2>&1 || true
  rm -f "sbox_${idx}.json" "resolv_${idx}.conf" >/dev/null 2>&1 || true
}

start_one() {
  local idx="$1"; IFS=':' read -r ip port user pass <<<"$2"
  local s="${SBOX_BASE}${idx}"
  local cfg="sbox_${idx}.json"
  local rsv="resolv_${idx}.conf"

  echo "------------------------------------------------------------"
  echo "[ROUTE $idx] SOCKS5: ${user}:${pass}@${ip}:${port}   (DNS_MODE=${DNS_MODE})"

  cleanup_one "$idx"
  mk_sbox_config "$cfg" "$ip" "$port" "$user" "$pass"
  printf "%s\n" "$RESOLV_CONTENT" > "$rsv"

  docker run -d --name "$s" --restart=always \
    --cap-add=NET_ADMIN --device /dev/net/tun \
    -v "$PWD/$cfg":/etc/sing-box/config.json:ro \
    -v "$PWD/$rsv":/etc/resolv.conf:ro \
    "$IMG_SBOX" run -c /etc/sing-box/config.json >/dev/null || true

  echo "[ROUTE $idx] RUNNING (khởi chạy xong)."
  echo "→ Gắn app: docker run ... --network=container:${s} <image> ..."
}

status_min() {
  docker ps -a --format '{{.Names}}\t{{.Status}}' | grep -E "^${SBOX_BASE}[0-9]+\b" | sort -V || true
}

down_all() {
  echo "[CLEANUP] stopping all routes..."
  local i=1
  for _ in "${PROXIES[@]}"; do cleanup_one "$i"; ((i++)); done
  echo "[DONE]"
}

pull_images() {
  docker pull "$IMG_SBOX" >/dev/null || true
}

# ===================== CLI =====================
case "${1:-up}" in
  up)
    pull_images
    i=1
    for spec in "${PROXIES[@]}"; do
      start_one "$i" "$spec"
      ((i++))
    done
    echo
    if [[ "$DNS_MODE" == "doh" ]]; then
      echo "✅ TẠO ${#PROXIES[@]} ROUTES (DoH qua proxy bằng hijack-dns; format DNS mới)."
    else
      echo "✅ TẠO ${#PROXIES[@]} ROUTES (DNS 53 direct; format DNS mới)."
    fi
    echo "ℹ️ Kiểm tra thủ công: docker logs sbox1 | tail -n 100"
    ;;
  status)
    status_min
    ;;
  down)
    down_all
    ;;
  *)
    echo "Usage: $0 [up|status|down]"
    exit 1
    ;;
esac
