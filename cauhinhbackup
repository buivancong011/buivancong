#!/bin/bash

# ==============================================================================
# MASTER SCRIPT: CÃ€I Äáº¶T RCLONE & AUTO BACKUP MYSTERIUM
# ==============================================================================

# MÃ u sáº¯c
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m'

echo "========================================================================"
echo "   MYSTERIUM BACKUP SETUP - ALL IN ONE"
echo "========================================================================"

# --- BÆ¯á»šC 1: Sá»¬A Lá»–I THIáº¾U UNZIP & CÃ€I Äáº¶T ---
echo -e "${YELLOW}[1/4] Äang cÃ i Ä‘áº·t cÃ¡c cÃ´ng cá»¥ cáº§n thiáº¿t (unzip, curl)...${NC}"
sudo apt-get update -qq >/dev/null 2>&1
sudo apt-get install -y unzip curl >/dev/null 2>&1

if command -v unzip >/dev/null; then
    echo -e "${GREEN}âœ… ÄÃ£ cÃ i xong unzip.${NC}"
else
    echo -e "${RED}âŒ Lá»—i cÃ i Ä‘áº·t unzip. Kiá»ƒm tra láº¡i máº¡ng VPS.${NC}"
    exit 1
fi

# --- BÆ¯á»šC 2: CÃ€I Äáº¶T RCLONE ---
echo -e "${YELLOW}[2/4] Äang táº£i vÃ  cÃ i Ä‘áº·t Rclone...${NC}"
curl https://rclone.org/install.sh | sudo bash >/dev/null 2>&1

if command -v rclone >/dev/null; then
    echo -e "${GREEN}âœ… Rclone Ä‘Ã£ Ä‘Æ°á»£c cÃ i Ä‘áº·t thÃ nh cÃ´ng.${NC}"
else
    echo -e "${RED}âŒ Lá»—i cÃ i Ä‘áº·t Rclone.${NC}"
    exit 1
fi

# --- BÆ¯á»šC 3: Táº O SCRIPT BACKUP Tá»° Äá»˜NG ---
echo -e "${YELLOW}[3/4] Äang táº¡o script backup thÃ´ng minh...${NC}"

# Táº¡o ná»™i dung file backup
cat << 'EOF' > /root/auto_backup.sh
#!/bin/bash
RCLONE_REMOTE="gdrive"
GDRIVE_FOLDER="Mysterium_Backups"
LOCAL_TEMP="/tmp/myst_backups"
NODE_IDS=(1 2) # Tá»± Ä‘á»™ng quÃ©t ID 1 vÃ  2

# Check Rclone
if ! command -v rclone &> /dev/null; then echo "Rclone chÆ°a cÃ i!"; exit 1; fi
mkdir -p "$LOCAL_TEMP"

backup_node() {
    local ID=$1
    local VOL="myst-data$ID"
    local NET="my_network_$ID"
    
    echo "ğŸ“¦ Backup Node $ID ($VOL)..."
    if ! docker volume inspect "$VOL" >/dev/null 2>&1; then echo "Volume $VOL khÃ´ng tá»“n táº¡i."; return; fi

    # Check IP
    PUBLIC_IP=$(docker run --rm --network "$NET" curlimages/curl:latest -s --max-time 10 https://api.ipify.org)
    [ -z "$PUBLIC_IP" ] && PREFIX="Unknown_myst$ID" || PREFIX="${PUBLIC_IP}_myst$ID"
    
    FILENAME="${PREFIX}_$(date +%F).tar.gz"
    
    # NÃ©n & Upload
    docker run --rm -v "$VOL":/data:ro -v "$LOCAL_TEMP":/backup alpine tar czf "/backup/$FILENAME" -C /data .
    if rclone copy "$LOCAL_TEMP/$FILENAME" "$RCLONE_REMOTE:$GDRIVE_FOLDER"; then
        echo "âœ… Upload OK: $FILENAME"
        rm -f "$LOCAL_TEMP/$FILENAME"
    else
        echo "âŒ Upload Fail!"
    fi
}

for id in "${NODE_IDS[@]}"; do backup_node "$id"; done
EOF

chmod +x /root/auto_backup.sh
echo -e "${GREEN}âœ… ÄÃ£ táº¡o file /root/auto_backup.sh${NC}"

# --- BÆ¯á»šC 4: CÃ€I Äáº¶T CRONJOB (Lá»ŠCH Tá»° Äá»˜NG) ---
echo -e "${YELLOW}[4/4] Äang cÃ i Ä‘áº·t lá»‹ch cháº¡y tá»± Ä‘á»™ng (3h sÃ¡ng hÃ ng ngÃ y)...${NC}"
(crontab -l 2>/dev/null; echo "0 3 * * * /bin/bash /root/auto_backup.sh >> /var/log/myst_backup.log 2>&1") | sort -u | crontab -
echo -e "${GREEN}âœ… ÄÃ£ thÃªm lá»‹ch vÃ o Crontab.${NC}"

echo "========================================================================"
echo -e "${GREEN}ğŸ‰ CÃ€I Äáº¶T HOÃ€N Táº¤T 99%!${NC}"
echo "========================================================================"
echo -e "${YELLOW}ğŸ‘‰ BÆ¯á»šC CUá»I CÃ™NG (QUAN TRá»ŒNG):${NC}"
echo "Ã”ng pháº£i cáº¥u hÃ¬nh káº¿t ná»‘i Google Drive thá»§ cÃ´ng ngay bÃ¢y giá»."
echo "HÃ£y lÃ m theo hÆ°á»›ng dáº«n trÃªn mÃ n hÃ¬nh sau Ä‘Ã¢y:"
echo "1. GÃµ 'n' (New remote)"
echo "2. Äáº·t tÃªn lÃ : gdrive"
echo "3. Chá»n sá»‘ cá»§a 'Google Drive' (thÆ°á»ng lÃ  18)"
echo "4. CÃ¡c bÆ°á»›c tiáº¿p theo cá»© Ä‘á»ƒ trá»‘ng (Enter) cho Ä‘áº¿n khi nÃ³ hiá»‡n Link."
echo "------------------------------------------------------------------------"
read -p "Nháº¥n Enter Ä‘á»ƒ báº¯t Ä‘áº§u cáº¥u hÃ¬nh Rclone..."

rclone config
