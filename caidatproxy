#!/bin/bash
set -e

# ==== CONFIG ====
PROXY_USER="user37243"
PROXY_PASS="1757566426"
PROXY_HOST="103.82.26.44"
PROXY_PORT="37243"

# ==== 1. Cleanup containers náº¿u cÃ³ ====
docker rm -f glider tun1 doh >/dev/null 2>&1 || true

# ==== 2. Táº¡o glider SOCKS5 tá»« HTTP proxy ====
echo "[INFO] Khá»Ÿi táº¡o glider SOCKS5 proxy..."
docker run -d --name glider --restart=always --network host nadoo/glider \
  -verbose \
  -listen "socks5://0.0.0.0:1080" \
  -forward "http://$PROXY_USER:$PROXY_PASS@$PROXY_HOST:$PROXY_PORT"

# ==== 3. Táº¡o resolv.conf dÃ¹ng DNS ná»™i bá»™ ====
echo "[INFO] Táº¡o resolv.conf cá»¥c bá»™..."
cat > resolv.conf <<EOF
options ndots:0
nameserver 127.0.0.1
EOF

# ==== 4. Khá»Ÿi cháº¡y tun2socks container ====
echo "[INFO] Khá»Ÿi cháº¡y tun2socks..."
docker run -d --name tun1 --restart=always \
  --cap-add=NET_ADMIN \
  -v /dev/net/tun:/dev/net/tun \
  -v $PWD/resolv.conf:/etc/resolv.conf:ro \
  -e PROXY="socks5://172.17.0.1:1080" \
  -e EXTRA_COMMANDS="ip rule add iif lo ipproto udp dport 53 lookup main;" \
  -e LOGLEVEL=debug \
  xjasonlyu/tun2socks:v2.6.0

# ==== 5. Khá»Ÿi cháº¡y DNS-over-HTTPS vá»›i Cloudflare ====
echo "[INFO] Khá»Ÿi cháº¡y cloudflared DoH..."
docker run -d --name doh --restart=always \
  --network=container:tun1 \
  --user root \
  cloudflare/cloudflared:latest \
  proxy-dns --address 127.0.0.1 --port 53

# ==== 6. Kiá»ƒm tra IP qua tun1 ====
echo "[INFO] Kiá»ƒm tra IP qua tun1..."
docker run --rm --network=container:tun1 curlimages/curl:latest ifconfig.me

echo ""
echo "âœ… Proxy container Ä‘Ã£ sáºµn sÃ ng!"
echo "ðŸ‘‰ Má»i container muá»‘n dÃ¹ng proxy chá»‰ cáº§n thÃªm:"
echo "   --network=container:tun1"
