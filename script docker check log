#!/bin/bash

# ==== C·∫§U H√åNH M√ÄU S·∫ÆC ====
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

echo -e "${BLUE}=================================================${NC}"
echo -e "${BLUE}   C√îNG C·ª§ KI·ªÇM TRA TR·∫†NG TH√ÅI NODE (LOG CHECK)  ${NC}"
echo -e "${BLUE}=================================================${NC}"
echo ""

# Danh s√°ch c√°c app prefix
APPS=("tm" "myst" "urnetwork" "earnfm" "repocket" "antgain")
IDS=("1" "2")

# H√†m ki·ªÉm tra t·ª´ng container
check_container() {
    local NAME=$1
    
    # 1. Ki·ªÉm tra xem container c√≥ t·ªìn t·∫°i kh√¥ng
    if ! docker inspect "$NAME" > /dev/null 2>&1; then
        return # B·ªè qua n·∫øu kh√¥ng t√¨m th·∫•y (v√≠ d·ª• antgain kh√¥ng c√†i)
    fi

    echo -e "-------------------------------------------------"
    
    # 2. L·∫•y tr·∫°ng th√°i (Up/Restarting/Exited)
    STATUS=$(docker inspect --format '{{.State.Status}}' "$NAME")
    UPTIME=$(docker ps -f "name=^/${NAME}$" --format "{{.Status}}")
    
    # 3. ƒê·ªïi m√†u tr·∫°ng th√°i
    if [[ "$STATUS" == "running" ]]; then
        STATUS_COLOR="${GREEN}RUNNING${NC}"
    else
        STATUS_COLOR="${RED}$STATUS${NC}"
    fi

    echo -e "Node: ${YELLOW}$NAME${NC} | Tr·∫°ng th√°i: $STATUS_COLOR | ($UPTIME)"

    # 4. L·∫•y th·ªëng k√™ t√†i nguy√™n (CPU/RAM) - C·∫ßn c√†i ƒë·∫∑t format
    STATS=$(docker stats --no-stream --format "CPU: {{.CPUPerc}} | RAM: {{.MemUsage}}" "$NAME")
    echo -e "Resource: $STATS"

    # 5. In ra 3 d√≤ng log cu·ªëi c√πng
    echo -e "üìù ${BLUE}Logs m·ªõi nh·∫•t:${NC}"
    
    # L·∫•y logs, n·∫øu log tr·ªëng th√¨ b√°o tr·ªëng
    LOGS=$(docker logs --tail 3 "$NAME" 2>&1)
    if [ -z "$LOGS" ]; then
        echo -e "   (Kh√¥ng c√≥ log)"
    else
        # In logs v√† t√¥ ƒë·ªè n·∫øu c√≥ t·ª´ kh√≥a l·ªói
        echo "$LOGS" | while read -r line; do
            if [[ "$line" == *"error"* ]] || [[ "$line" == *"Error"* ]] || [[ "$line" == *"Failed"* ]] || [[ "$line" == *"refused"* ]]; then
                echo -e "   ${RED}$line${NC}"
            else
                echo -e "   $line"
            fi
        done
    fi
}

# ==== CH·∫†Y V√íNG L·∫∂P KI·ªÇM TRA ====

# Check nhanh IP Public hi·ªán t·∫°i c·ªßa 2 m·∫°ng
echo -e "${YELLOW}[Network Check]${NC}"
IP1=$(docker run --rm --network my_network_1 curlimages/curl:latest -s --max-time 5 https://api.ipify.org || echo "Error")
IP2=$(docker run --rm --network my_network_2 curlimages/curl:latest -s --max-time 5 https://api.ipify.org || echo "Error")

if [ "$IP1" == "$IP2" ]; then
    echo -e "‚ö†Ô∏è  ${RED}C·∫¢NH B√ÅO: TR√ôNG IP ($IP1). Node c√≥ th·ªÉ b·ªã ban!${NC}"
else
    echo -e "‚úÖ Net 1: $IP1"
    echo -e "‚úÖ Net 2: $IP2"
fi
echo ""

echo -e "${YELLOW}[Container Check]${NC}"

# Duy·ªát qua c√°c nh√≥m 1 v√† 2
for id in "${IDS[@]}"; do
    for app in "${APPS[@]}"; do
        CONTAINER_NAME="${app}${id}"
        check_container "$CONTAINER_NAME"
    done
done

echo -e "\n${BLUE}==== HO√ÄN T·∫§T ====${NC}"
