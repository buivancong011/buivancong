#!/bin/bash

# ==============================================================================
# C·∫§U H√åNH C·∫¢NH B√ÅO
# ==============================================================================
THRESHOLD=80  # Ng∆∞·ª°ng c·∫£nh b√°o (80%)

# N·∫øu √¥ng mu·ªën nh·∫≠n tin nh·∫Øn v·ªÅ Telegram, ƒëi·ªÅn Token v√† ChatID v√†o ƒë√¢y
# N·∫øu kh√¥ng d√πng th√¨ ƒë·ªÉ tr·ªëng, script s·∫Ω ch·ªâ hi·ªán ra m√†n h√¨nh console.
TELEGRAM_TOKEN=""
CHAT_ID=""

# ==============================================================================
# 1. KI·ªÇM TRA RAM
# ==============================================================================
# L·∫•y t·ªïng RAM v√† RAM ƒë√£ d√πng (ƒë∆°n v·ªã MB)
TOTAL_RAM=$(free -m | grep Mem | awk '{print $2}')
USED_RAM=$(free -m | grep Mem | awk '{print $3}')
# T√≠nh ph·∫ßn trƒÉm
RAM_PERCENT=$(( 100 * USED_RAM / TOTAL_RAM ))

# ==============================================================================
# 2. KI·ªÇM TRA ·ªî C·ª®NG (Disk Usage)
# ==============================================================================
# L·∫•y % s·ª≠ d·ª•ng c·ªßa th∆∞ m·ª•c g·ªëc /
DISK_PERCENT=$(df -h / | awk 'NR==2 {print $5}' | sed 's/%//')

# ==============================================================================
# 3. X·ª¨ L√ù C·∫¢NH B√ÅO
# ==============================================================================
ALERT_MSG=""
HAS_ALERT=false

# Check RAM
if [ "$RAM_PERCENT" -ge "$THRESHOLD" ]; then
    HAS_ALERT=true
    ALERT_MSG="${ALERT_MSG}‚ö†Ô∏è [C·∫¢NH B√ÅO] RAM ƒêANG CAO: ${RAM_PERCENT}% ($USED_RAM/${TOTAL_RAM}MB)%0A"
    # L·∫•y top 3 ti·∫øn tr√¨nh ƒÉn RAM nhi·ªÅu nh·∫•t
    TOP_MEM=$(ps -eo pid,ppid,cmd,%mem,%cpu --sort=-%mem | head -n 4)
    ALERT_MSG="${ALERT_MSG}Top th·ªß ph·∫°m:%0A${TOP_MEM}%0A-----------------%0A"
else
    echo "‚úÖ RAM ·ªïn ƒë·ªãnh: ${RAM_PERCENT}%"
fi

# Check Disk
if [ "$DISK_PERCENT" -ge "$THRESHOLD" ]; then
    HAS_ALERT=true
    ALERT_MSG="${ALERT_MSG}‚ö†Ô∏è [C·∫¢NH B√ÅO] ·ªî C·ª®NG S·∫ÆP ƒê·∫¶Y: ${DISK_PERCENT}%%0A"
    ALERT_MSG="${ALERT_MSG}G·ª£i √Ω: Ch·∫°y l·ªánh 'docker system prune -a' ƒë·ªÉ x√≥a r√°c."
else
    echo "‚úÖ ·ªî c·ª©ng tho·∫£i m√°i: ${DISK_PERCENT}%"
fi

# ==============================================================================
# 4. G·ª¨I TH√îNG B√ÅO (Telegram)
# ==============================================================================
if [ "$HAS_ALERT" = true ]; then
    echo -e "\nüî• PH√ÅT HI·ªÜN V·∫§N ƒê·ªÄ! ƒêang g·ª≠i c·∫£nh b√°o..."
    
    # N·∫øu c√≥ c·∫•u h√¨nh Telegram th√¨ g·ª≠i
    if [ ! -z "$TELEGRAM_TOKEN" ] && [ ! -z "$CHAT_ID" ]; then
        curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage" \
            -d chat_id="${CHAT_ID}" \
            -d text="${ALERT_MSG}" \
            -d parse_mode="HTML" > /dev/null
        echo "-> ƒê√£ g·ª≠i tin nh·∫Øn Telegram."
    else
        echo "-> Ch∆∞a c·∫•u h√¨nh Telegram. H√£y check log tr√™n m√†n h√¨nh."
        echo -e "${ALERT_MSG}"
    fi
fi
