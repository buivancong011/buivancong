#!/usr/bin/env bash
set -Eeuo pipefail

# ===================== CONFIG =====================
SBOX_PREFIX="${SBOX_PREFIX:-csbox}"
UR_PREFIX="${UR_PREFIX:-ur-}"

# GHIM ẢNH CỤ THỂ (sẽ không tự thay đổi)
UR_IMAGE="ghcr.io/techroy23/docker-urnetwork@sha256:a1e97597b06904594b8977d493f9d07866714cd423685f5cea370467c5dcf547"

USER_AUTH="${USER_AUTH:-buivancong012@gmail.com}"
PASSWORD="${PASSWORD:-buivancong012}"

PROXY_FILE="${PROXY_FILE:-}"  # ví dụ: /root/proxy.txt
PULL_ON_START=false            # ❌ không tự pull
RECREATE_MODE="none"           # ❌ không recreate
WAIT_TIMEOUT=25
LOG_MAX_SIZE="10m"
LOG_MAX_FILE="3"
DEVICE_NAME_MODE="sbox"

command -v docker >/dev/null 2>&1 || { echo "[ERR] Cần Docker."; exit 1; }

if [[ -n "$PROXY_FILE" && ! -f "$PROXY_FILE" ]]; then
  echo "[ERR] PROXY_FILE đã đặt nhưng không tồn tại: $PROXY_FILE"
  exit 1
fi

discover_sbox() {
  docker ps -a --format '{{.Names}}' | awk -v pfx="^${SBOX_PREFIX}[0-9]+$" '$0 ~ pfx' | sort -V
}

wait_running_sbox() {
  local name="$1" timeout="${2:-$WAIT_TIMEOUT}" t=0
  while :; do
    local st
    st="$(docker inspect -f '{{.State.Status}}' "$name" 2>/dev/null || true)"
    [[ "$st" == "running" ]] && return 0
    ((t++ >= timeout)) && { echo "[WARN] $name chưa running sau ${timeout}s."; return 1; }
    sleep 1
  done
}

mk_device_name() {
  local sbox="$1"
  case "$DEVICE_NAME_MODE" in
    sbox) echo "$sbox" ;;
    ur) echo "ur${sbox#${SBOX_PREFIX}}" ;;
  esac
}

probe_network() {
  local s="$1"
  docker run --rm --network=container:"$s" curlimages/curl:latest -s --connect-timeout 5 https://1.1.1.1 >/dev/null 2>&1 || {
    echo "⚠ ${s} không ra Internet."; return 1; }
}

start_ur_for_sbox() {
  local sbox="$1" ur_name="${UR_PREFIX}${sbox}"
  local device_name; device_name="$(mk_device_name "$sbox")"
  echo "→ Chuẩn bị ${ur_name} (net=${sbox})"

  probe_network "$sbox" || { echo "⚠ Bỏ qua ${ur_name} vì mạng ${sbox} chưa thông."; return; }

  if docker ps -a --format '{{.Names}}' | grep -qx "$ur_name"; then
    echo "   ✓ ${ur_name} đã tồn tại, giữ nguyên (không recreate)"
    return
  fi

  local vnstat_vol="vnstat_${sbox}"
  docker volume create "${vnstat_vol}" >/dev/null 2>&1 || true

  docker run -d --name "${ur_name}" \
    --network="container:${sbox}" \
    --restart=unless-stopped \
    --log-opt "max-size=${LOG_MAX_SIZE}" --log-opt "max-file=${LOG_MAX_FILE}" \
    -e USER_AUTH="${USER_AUTH}" \
    -e PASSWORD="${PASSWORD}" \
    -e ENABLE_IP_CHECKER=false \
    -e TZ=Asia/Ho_Chi_Minh \
    -e DEVICE_NAME="${device_name}" \
    -v "${vnstat_vol}:/var/lib/vnstat" \
    ${PROXY_FILE:+-v "$PROXY_FILE:/app/proxy.txt:ro"} \
    "${UR_IMAGE}" >/dev/null

  echo "   ✓ ${ur_name} đã tạo mới (image cố định, không auto update)"
}

stop_ur_for_sbox() {
  local sbox="$1"
  docker rm -f "${UR_PREFIX}${sbox}" >/dev/null 2>&1 && echo "✗ ${UR_PREFIX}${sbox} đã xoá"
}

cmd_up() {
  local list; list="$(discover_sbox)"
  [[ -z "$list" ]] && { echo "[ERR] Không thấy ${SBOX_PREFIX}N nào."; exit 1; }

  echo "[INFO] Phát hiện routes:"
  echo "$list" | xargs -I{} echo " - {}"

  echo "[INFO] Chạy UR cố định cho từng route:"
  while read -r s; do
    [[ "$(docker inspect -f '{{.State.Status}}' "$s" 2>/dev/null || true)" == "running" ]] && start_ur_for_sbox "$s"
  done <<< "$list"

  echo "✅ Hoàn tất."
}

cmd_down() {
  docker ps -a --format '{{.Names}}' | awk -v pfx="^${UR_PREFIX}${SBOX_PREFIX}[0-9]+$" '$0 ~ pfx' |
  while read -r ur; do docker rm -f "$ur" >/dev/null 2>&1 && echo "✗ $ur đã xoá"; done
}

cmd_status() {
  local list; list="$(discover_sbox)"
  [[ -z "$list" ]] && { echo "[INFO] Không thấy ${SBOX_PREFIX}N nào."; exit 0; }

  echo "[STATUS] sbox & ur-sbox:"
  while read -r s; do
    local st; st="$(docker inspect -f '{{.State.Status}}' "$s" 2>/dev/null || echo "unknown")"
    printf "%-8s: %s\n" "$s" "$st"
    docker ps -a --format '{{.Names}}\t{{.Status}}' | grep "^${UR_PREFIX}${s}\b" || echo "  (chưa có UR)"
  done <<< "$list"
}

cmd_logs() {
  local list; list="$(discover_sbox)"
  while read -r s; do
    echo "===== ${UR_PREFIX}${s} ====="
    docker logs --tail 100 "${UR_PREFIX}${s}" 2>/dev/null || echo "(no logs)"
  done <<< "$list"
}

case "${1:-up}" in
  up) cmd_up ;;
  down) cmd_down ;;
  status) cmd_status ;;
  logs) cmd_logs ;;
  *) echo "Usage: $0 [up|down|status|logs]" ;;
esac
