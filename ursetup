#!/bin/bash
set -euo pipefail

# ==============================================================================
# ğŸ”´ Cáº¤U HÃŒNH (CHá»ˆ Cáº¦N Sá»¬A ÄÃšNG 1 DÃ’NG NÃ€Y)
# ==============================================================================

# DÃ¡n "Authentication Code" (MÃ£ dÃ i háº¡n dÃ¹ng 100 láº§n) vÃ o giá»¯a 2 dáº¥u ngoáº·c ""
# VÃ­ dá»¥: UR_AUTH_CODE="RJvonPyBdtMwy3..."
UR_AUTH_CODE="RJvonPyBdtmWy30JRHcwgeM57RLuEz3vs9Fp-UEZoEO3YZyzNirsWZmNlwCZQ1U5CdNUTS3qptztEivGrN-IJkR-CEvB0G0I4KX0fR4Bk_DkDFzkuJ6wpiSKKBJmi0sPcCMxMerATEoCseeoWJTqkEBm7yR2lhQakyqlcJkEK1DuqsTRz_ERa07oTntyxe2EdWvD4irQfXz_gKizoHdRoJ4nlQlDl7gZ_8mNVPUfO1tlCzBzH9PlPqgT4s0jo8Txwut3CDTgH3wX2eDNlbqBzXYW7JEK_0AR0Y0gQrN-vmIrcBJqeg93ysBs4vKbUd0U-QUMJGOzVxYqX7iNK0DHdbJ9IfMNlLiwBTRxiI3TEktCg6aD12VMep9RtTXUgG1rZIscH1LWPbREDfb6b8k6Allqgucv_pbtACeqSJKrDLfFXGvGv3x0JbxzzArYQX_VNqjy4rrvp8VbK09b-GGaambElhnSOcpbyGwpiEeIQVZQ9m9hCTKnlo9eNck1CxgiPBX9HNd__1PldgyC-UbMDwxbm2NmB7LgU3ryc01bisnyCSfAd8iNhOhjCWKiyK97pChyY84rUrYUHcLeyvO1YOHo9AVov2MGoC03gxrDlii-EfFRyhdK-CfMNyjDRk1KMY-LMM_KZh_b-aOvc02275_HHRt2_BFpaVIHXWFea1s="

# ==============================================================================
# â›” KHÃ”NG Cáº¦N Sá»¬A GÃŒ BÃŠN DÆ¯á»šI DÃ’NG NÃ€Y
# ==============================================================================

IMAGE="bringyour/community-provider:g4-latest"
NODE1_DIR="$HOME/.urnetwork-node1"
NODE2_DIR="$HOME/.urnetwork-node2"
NODE1_NAME="ur-provider1"
NODE2_NAME="ur-provider2"
NETWORK1="my_network_1"
NETWORK2="my_network_2"

# 1. KIá»‚M TRA Máº NG DUAL-IP
if ! docker network inspect $NETWORK1 >/dev/null 2>&1 || ! docker network inspect $NETWORK2 >/dev/null 2>&1; then
  echo "âŒ [Lá»–I] ChÆ°a cÃ³ máº¡ng $NETWORK1 hoáº·c $NETWORK2. Cháº¡y script táº¡o IP trÆ°á»›c!"
  exit 1
fi

# 2. Dá»ŒN Dáº¸P
echo "=== [CLEANUP] Dá»n dáº¹p container cÅ©..."
docker rm -f ur1 ur2 $NODE1_NAME $NODE2_NAME >/dev/null 2>&1 || true
docker rmi -f ghcr.io/techroy23/docker-urnetwork:latest >/dev/null 2>&1 || true
mkdir -p "$NODE1_DIR" "$NODE2_DIR"

# 3. CHáº Y NODE 1
echo "ğŸš€ [NODE 1] Äang xÃ¡c thá»±c..."

# CHá»ˆ Báº®N AUTH CODE VÃ€O (KhÃ´ng cáº§n Email)
printf "${UR_AUTH_CODE}\n" | docker run --rm -i --network $NETWORK1 \
  -v "$NODE1_DIR:/root/.urnetwork" \
  $IMAGE auth

if [ ! -s "$NODE1_DIR/jwt" ]; then
  echo "âŒ [Lá»–I] Node 1 Ä‘Äƒng nháº­p tháº¥t báº¡i."
  exit 1
fi

echo "âœ… Node 1 OK! Äang cháº¡y..."
docker run -d --restart=always --network $NETWORK1 --cap-add NET_ADMIN \
  -v "$NODE1_DIR:/root/.urnetwork" --name $NODE1_NAME $IMAGE provide

# 4. CHáº Y NODE 2
echo "ğŸš€ [NODE 2] Äang xÃ¡c thá»±c..."

# CHá»ˆ Báº®N AUTH CODE VÃ€O
printf "${UR_AUTH_CODE}\n" | docker run --rm -i --network $NETWORK2 \
  -v "$NODE2_DIR:/root/.urnetwork" \
  $IMAGE auth

if [ ! -s "$NODE2_DIR/jwt" ]; then
  echo "âŒ [Lá»–I] Node 2 Ä‘Äƒng nháº­p tháº¥t báº¡i."
  exit 1
fi

echo "âœ… Node 2 OK! Äang cháº¡y..."
docker run -d --restart=always --network $NETWORK2 --cap-add NET_ADMIN \
  -v "$NODE2_DIR:/root/.urnetwork" --name $NODE2_NAME $IMAGE provide

echo "ğŸ‰ HOÃ€N Táº¤T!"
