#!/bin/bash
set -euo pipefail

# ==============================================================================
# ğŸ”´ Cáº¤U HÃŒNH (CHá»ˆ Cáº¦N Sá»¬A ÄÃšNG 1 DÃ’NG NÃ€Y)
# ==============================================================================

# DÃ¡n "Authentication Code" (MÃ£ dÃ i háº¡n dÃ¹ng 100 láº§n) vÃ o giá»¯a 2 dáº¥u ngoáº·c ""
# VÃ­ dá»¥: UR_AUTH_CODE="RJvonPyBdtMwy3..."
UR_AUTH_CODE="gmwTThkwmzHeEiFSwe-u7RHYEhso819SwDlUpRoZQpon-STF6Q6qs0yVb4izpVdMkPhDZhXB80VTd_3ECyPfQx8pi9xWir5MoOW-hwSOT6mZ1Zo0gLh4H_VbVB7HhI80B_3cwa85akdfOeJ8fhfatsi_1GT063ApKL3_jrq_M-IYpUhzEotzDu76Gu8dNqigWcsurY7eRbSZD2UYPKIBOLQbLIqlrw1WAHD2Pbusx0m2zdJyw0kTiSkjuQt6WHkXskR-wS7vbYS82nGeTZkWkqNeyJyLT70VquCi0NJcqs1BLG54PWZMYIz9vp32q0tMDx2X0VmWf6EVNM-LSi-C58p9ZZpkciQjaFtQf1dn8YI4-5IXidchA2oKyl1FG9P9prFcRl-tD94bxYsswkSH9Jy1DMmpoP7yRB_pq7XFKLh4NeEMf__g0osLSQI47sRcOL3o8yq51lz13s9vC32J4Zxsm60bvk2C184KTPAgW_w_a_TVcWo0qtXeC3sN77yTrXWJ95d2JCCNJIhMBjuiZYywYFZXr3ZBjiA3cmoxCGmsDdZEBqWaokhRNR006uwyTP1nKFuuojMmIwadZYnfYzT9xhorxELMeJc0RYeCFwk4lnfeMuhuqmebzto-Awpxjf2ID3GhaZcnoRi3pB8T9aVhHgAqDGjWu91DFU99xpM="

# ==============================================================================
# â›” KHÃ”NG Cáº¦N Sá»¬A GÃŒ BÃŠN DÆ¯á»šI DÃ’NG NÃ€Y
# ==============================================================================

IMAGE="bringyour/community-provider:g4-latest"
NODE1_DIR="$HOME/.urnetwork-node1"
NODE2_DIR="$HOME/.urnetwork-node2"
NODE1_NAME="ur-provider1"
NODE2_NAME="ur-provider2"
NETWORK1="my_network_1"
NETWORK2="my_network_2"

# 1. KIá»‚M TRA Máº NG DUAL-IP
if ! docker network inspect $NETWORK1 >/dev/null 2>&1 || ! docker network inspect $NETWORK2 >/dev/null 2>&1; then
  echo "âŒ [Lá»–I] ChÆ°a cÃ³ máº¡ng $NETWORK1 hoáº·c $NETWORK2. Cháº¡y script táº¡o IP trÆ°á»›c!"
  exit 1
fi

# 2. Dá»ŒN Dáº¸P
echo "=== [CLEANUP] Dá»n dáº¹p container cÅ©..."
docker rm -f ur1 ur2 $NODE1_NAME $NODE2_NAME >/dev/null 2>&1 || true
docker rmi -f ghcr.io/techroy23/docker-urnetwork:latest >/dev/null 2>&1 || true
mkdir -p "$NODE1_DIR" "$NODE2_DIR"

# 3. CHáº Y NODE 1
echo "ğŸš€ [NODE 1] Äang xÃ¡c thá»±c..."

# CHá»ˆ Báº®N AUTH CODE VÃ€O (KhÃ´ng cáº§n Email)
printf "${UR_AUTH_CODE}\n" | docker run --rm -i --network $NETWORK1 \
  -v "$NODE1_DIR:/root/.urnetwork" \
  $IMAGE auth

if [ ! -s "$NODE1_DIR/jwt" ]; then
  echo "âŒ [Lá»–I] Node 1 Ä‘Äƒng nháº­p tháº¥t báº¡i."
  exit 1
fi

echo "âœ… Node 1 OK! Äang cháº¡y..."
docker run -d --restart=always --network $NETWORK1 --cap-add NET_ADMIN \
  -v "$NODE1_DIR:/root/.urnetwork" --name $NODE1_NAME $IMAGE provide

# 4. CHáº Y NODE 2
echo "ğŸš€ [NODE 2] Äang xÃ¡c thá»±c..."

# CHá»ˆ Báº®N AUTH CODE VÃ€O
printf "${UR_AUTH_CODE}\n" | docker run --rm -i --network $NETWORK2 \
  -v "$NODE2_DIR:/root/.urnetwork" \
  $IMAGE auth

if [ ! -s "$NODE2_DIR/jwt" ]; then
  echo "âŒ [Lá»–I] Node 2 Ä‘Äƒng nháº­p tháº¥t báº¡i."
  exit 1
fi

echo "âœ… Node 2 OK! Äang cháº¡y..."
docker run -d --restart=always --network $NETWORK2 --cap-add NET_ADMIN \
  -v "$NODE2_DIR:/root/.urnetwork" --name $NODE2_NAME $IMAGE provide

echo "ğŸ‰ HOÃ€N Táº¤T!"
