#!/bin/bash
set -euo pipefail

IMAGE="bringyour/community-provider:g4-latest"

# Khai b√°o danh s√°ch node: t√™n_container:th∆∞_m·ª•c_d·ªØ_li·ªáu:container_VPN
NODES=(
  "ur1:$HOME/.urnetwork-node1:tun1"
  "ur2:$HOME/.urnetwork-node2:tun2"
  "ur3:$HOME/.urnetwork-node3:tun3"
  "ur4:$HOME/.urnetwork-node4:tun4"
  "ur5:$HOME/.urnetwork-node5:tun5"
  "ur6:$HOME/.urnetwork-node6:tun6"
  "ur7:$HOME/.urnetwork-node7:tun7"
  "ur8:$HOME/.urnetwork-node8:tun8"
  "ur9:$HOME/.urnetwork-node9:tun9"
  "ur10:$HOME/.urnetwork-node10:tun10"
  "ur11:$HOME/.urnetwork-node11:tun11"
  "ur12:$HOME/.urnetwork-node12:tun12"
  "ur13:$HOME/.urnetwork-node13:tun13"
  "ur14:$HOME/.urnetwork-node14:tun14"
  "ur15:$HOME/.urnetwork-node15:tun15"
  "ur16:$HOME/.urnetwork-node16:tun16"
  "ur17:$HOME/.urnetwork-node17:tun17"
  "ur18:$HOME/.urnetwork-node18:tun18"
  "ur19:$HOME/.urnetwork-node19:tun19"
  "ur20:$HOME/.urnetwork-node20:tun20"
  "ur21:$HOME/.urnetwork-node21:tun21"
  "ur22:$HOME/.urnetwork-node22:tun22"
)

echo "=== [CLEANUP] Xo√° container c≈© (n·∫øu c√≥) ==="
for node in "${NODES[@]}"; do
  IFS=':' read -r name dir tun <<< "$node"
  docker rm -f "$name" >/dev/null 2>&1 || true
done

echo "[INFO] B·∫Øt ƒë·∫ßu setup nhi·ªÅu node UR..."
for node in "${NODES[@]}"; do
  IFS=':' read -r name dir tun <<< "$node"

  mkdir -p "$dir"

  echo "[AUTH] Auth cho $name (qua $tun) - d√°n Auth Code:"
  docker run --rm -it \
    --network=container:"$tun" \
    -v "$dir:/root/.urnetwork" \
    "$IMAGE" auth

  if [ ! -s "$dir/jwt" ]; then
    echo "[ERROR] Node $name ch∆∞a c√≥ JWT -> d·ª´ng setup"
    exit 1
  fi

  echo "[RUN] Kh·ªüi ch·∫°y $name..."
  docker run -d --restart=always \
    --network=container:"$tun" \
    -v "$dir:/root/.urnetwork" \
    --name "$name" \
    "$IMAGE" provide

done

echo "[OK] Ho√†n t·∫•t setup t·∫•t c·∫£ node!"

echo
echo "üì° Ki·ªÉm tra IP t·ª´ng tuy·∫øn:"
for node in "${NODES[@]}"; do
  IFS=':' read -r name dir tun <<< "$node"
  echo "  $name -> docker run --rm --network=container:$tun curlimages/curl:latest -s ifconfig.me"
done
