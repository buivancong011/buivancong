#!/bin/bash
set -Eeuo pipefail
IMAGE="bringyour/community-provider:g4-latest"

# Khai báo tuyến bạn đã dựng sẵn từ script proxy
TUNS=(tun1 tun2 )   # muốn bao nhiêu tuyến thì thêm bấy nhiêu

# Khai báo node muốn chạy (tên & thư mục dữ liệu)
NODES=(
  "ur1:$HOME/.urnetwork-node1"
  "ur2:$HOME/.urnetwork-node2"
  
)

auth_if_needed () {
  local datadir="$1"
  [ -s "$datadir/jwt" ] && return 0
  echo "[AUTH] Paste Auth Code cho $datadir:"
  docker run --rm -it -v "$datadir:/root/.urnetwork" "$IMAGE" auth
  [ -s "$datadir/jwt" ] || { echo "[ERROR] Thiếu JWT ở $datadir"; exit 1; }
}

i=0
for pair in "${NODES[@]}"; do
  name="${pair%%:*}"; datadir="${pair#*:}"
  tun="${TUNS[$i]}"
  mkdir -p "$datadir"

  docker rm -f "$name" >/dev/null 2>&1 || true
  auth_if_needed "$datadir"

  echo "[RUN] $name → $tun"
  docker run -d --restart=always \
    --network=container:"$tun" \
    -v "$datadir:/root/.urnetwork" \
    --name "$name" "$IMAGE" provide

  ((i++))
  # nếu node nhiều hơn tuyến, quay vòng lại từ đầu
  if [ "$i" -ge "${#TUNS[@]}" ]; then i=0; fi
done

echo "✅ Đã khởi chạy ${#NODES[@]} node với ${#TUNS[@]} tuyến."
