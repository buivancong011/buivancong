#!/bin/bash
set -euo pipefail

IMAGE="bringyour/community-provider:g4-latest"

# Khai b√°o danh s√°ch node: t√™n_container:th∆∞_m·ª•c_d·ªØ_li·ªáu:container_VPN
NODES=(

  "ur22:$HOME/.urnetwork-node22:tun22"
)

echo "=== [CLEANUP] Xo√° container c≈© (n·∫øu c√≥) ==="
for node in "${NODES[@]}"; do
  IFS=':' read -r name dir tun <<< "$node"
  docker rm -f "$name" >/dev/null 2>&1 || true
done

echo "[INFO] B·∫Øt ƒë·∫ßu setup nhi·ªÅu node UR..."
for node in "${NODES[@]}"; do
  IFS=':' read -r name dir tun <<< "$node"

  mkdir -p "$dir"

  echo "[AUTH] Auth cho $name (qua $tun) - d√°n Auth Code:"
  docker run --rm -it \
    --network=container:"$tun" \
    -v "$dir:/root/.urnetwork" \
    "$IMAGE" auth

  if [ ! -s "$dir/jwt" ]; then
    echo "[ERROR] Node $name ch∆∞a c√≥ JWT -> d·ª´ng setup"
    exit 1
  fi

  echo "[RUN] Kh·ªüi ch·∫°y $name..."
  docker run -d --restart=always \
    --network=container:"$tun" \
    -v "$dir:/root/.urnetwork" \
    --name "$name" \
    "$IMAGE" provide

done

echo "[OK] Ho√†n t·∫•t setup t·∫•t c·∫£ node!"

echo
echo "üì° Ki·ªÉm tra IP t·ª´ng tuy·∫øn:"
for node in "${NODES[@]}"; do
  IFS=':' read -r name dir tun <<< "$node"
  echo "  $name -> docker run --rm --network=container:$tun curlimages/curl:latest -s ifconfig.me"
done
