#!/bin/bash
set -euo pipefail

# ===================== Load .env nếu có =====================
if [[ -f .env ]]; then
  # shellcheck disable=SC1091
  source .env
fi

# ===================== CONFIG =====================
TOKEN="${TOKEN:-}"                # Traffmonetizer
UR_USER="${UR_USER:-}"            # URNetwork
UR_PASS="${UR_PASS:-}"            # URNetwork

UR_ENABLE_IP_CHECKER="${UR_ENABLE_IP_CHECKER:-false}"
UR_PROXY_FILE="${UR_PROXY_FILE:-}"

# ===================== CONFIG CỨNG =====================
TOKEN='/PfkwR8qQMfbsCMrSaaDhsX96E9w2PeHH2bcGeyFBno='
UR_USER='nguyenvinhcao123@gmail.com'
UR_PASS='CAOcao123CAO@'

# Tùy chọn
UR_ENABLE_IP_CHECKER=false
UR_PROXY_FILE=""
MYST_PORT=4449

PURGE_CONTAINERS="${PURGE_CONTAINERS:-true}"
PURGE_IMAGES="${PURGE_IMAGES:-true}"
PURGE_NETWORKS="${PURGE_NETWORKS:-true}"
PURGE_CONTAINERS=true
PURGE_IMAGES=true
PURGE_NETWORKS=true

# Tên & CIDR networks
NET1_NAME="my_network_1"
NET2_NAME="my_network_2"
NET1_CIDR="192.168.33.0/24"
NET2_CIDR="192.168.34.0/24"

# ===================== Phát hiện kiến trúc =====================
arch=$(uname -m)
case "$arch" in
  x86_64)          TM_IMAGE="traffmonetizer/cli_v2:latest" ;;
  aarch64|arm64)   TM_IMAGE="traffmonetizer/cli_v2:arm64v8" ;;
  *)               TM_IMAGE="traffmonetizer/cli_v2:latest"  ;;
esac

UR_IMAGE_AMD64="ghcr.io/techroy23/docker-urnetwork:latest"
UR_IMAGE_ARM64="techroy23/docker-urnetwork:latest"
if [[ "$arch" == "aarch64" || "$arch" == "arm64" ]]; then
  UR_IMAGE="$UR_IMAGE_ARM64"
  UR_PLATFORM="--platform linux/arm64"
else
  UR_IMAGE="$UR_IMAGE_AMD64"
  UR_PLATFORM="--platform linux/amd64"
fi

# ===================== Hàm cài đặt =====================
install_pkgs() {
  if need_cmd apt-get; then sudo apt-get update && sudo apt-get install -y "$@";
  elif need_cmd yum; then sudo yum install -y "$@";
  else echo "[WARN] Cài tay: $*"; fi
}

need_cmd() { command -v "$1" &>/dev/null; }

if ! need_cmd docker; then
  echo "[INFO] Cài Docker..."
  install_pkgs docker docker.io || true
  sudo systemctl enable docker
  sudo systemctl start docker
fi

# ===================== Kiểm tra biến =====================
if [[ -z "$TOKEN" || -z "$UR_USER" || -z "$UR_PASS" ]]; then
  echo "[ERROR] Thiếu biến môi trường."
  exit 1
fi

# ===================== Dọn dẹp =====================
if [[ "${PURGE_CONTAINERS}" == "true" ]]; then
  if [[ "$(docker ps -aq | wc -l)" -gt 0 ]]; then
    echo "[WARN] Xoá containers..."
    docker rm -f $(docker ps -aq) || true
  fi
fi

if [[ "${PURGE_IMAGES}" == "true" ]]; then
  if [[ "$(docker images -q | wc -l)" -gt 0 ]]; then
    echo "[WARN] Xoá images..."
    docker rmi -f $(docker images -q) || true
  fi
fi

if [[ "${PURGE_NETWORKS}" == "true" ]]; then
  while read -r net; do
    [[ -n "$net" ]] && docker network rm "$net" || true
  done < <(docker network ls --format '{{.Name}}' | grep -vE '^(bridge|host|none)$' || true)
fi

docker network create "${NET1_NAME}" --driver bridge --subnet "${NET1_CIDR}" >/dev/null 2>&1 || true
docker network create "${NET2_NAME}" --driver bridge --subnet "${NET2_CIDR}" >/dev/null 2>&1 || true

# ===================== Phát hiện IP (AWS Mode) =====================
for bin in ip awk cut grep iptables; do
  need_cmd "$bin" || install_pkgs "$bin" || true
done

DEV="$(ip route show default 2>/dev/null | awk '{for(i=1;i<=NF;i++) if($i=="dev"){print $(i+1); exit}}')"
if [[ -z "${DEV:-}" ]]; then DEV="ens5"; fi

echo "[INFO] Interface: $DEV"

IP_STATIC=$(ip -4 -o addr show dev "$DEV" | grep "noprefixroute" | awk '{print $4}' | cut -d/ -f1 | head -n1)
IP_DYNAMIC=$(ip -4 -o addr show dev "$DEV" | grep "dynamic" | awk '{print $4}' | cut -d/ -f1 | head -n1)

if [[ -n "$IP_STATIC" ]] && [[ -n "$IP_DYNAMIC" ]]; then
  IP1="$IP_STATIC"
  IP2="$IP_DYNAMIC"
else
  echo "[FATAL] Không tìm thấy đủ 2 IP (noprefixroute & dynamic)."
  exit 1
fi

echo "[INFO] IP1=$IP1 | IP2=$IP2"

# ===================== Bật Forward & SNAT =====================
sudo sysctl -w net.ipv4.ip_forward=1 >/dev/null
echo 'net.ipv4.ip_forward=1' | sudo tee /etc/sysctl.d/99-ipforward.conf >/dev/null || true
sudo sysctl --system >/dev/null || true

# Reset Rules cũ
sudo iptables -t nat -D POSTROUTING -s "$NET1_CIDR" -o "$DEV" -j SNAT --to-source "$IP1" 2>/dev/null || true
sudo iptables -t nat -D POSTROUTING -s "$NET1_CIDR" -o "$DEV" -j SNAT --to-source "$IP2" 2>/dev/null || true
sudo iptables -t nat -D POSTROUTING -s "$NET2_CIDR" -o "$DEV" -j SNAT --to-source "$IP1" 2>/dev/null || true
sudo iptables -t nat -D POSTROUTING -s "$NET2_CIDR" -o "$DEV" -j SNAT --to-source "$IP2" 2>/dev/null || true

# === Áp dụng Rule (Priority High) ===
echo "[INFO] Đang áp dụng SNAT Priority..."
sudo iptables -t nat -I POSTROUTING 1 -s "$NET1_CIDR" -o "$DEV" -j SNAT --to-source "$IP1"
sudo iptables -t nat -I POSTROUTING 1 -s "$NET2_CIDR" -o "$DEV" -j SNAT --to-source "$IP2"

# ===================== TIME WAIT (AN TOÀN) =====================
echo "----------------------------------------------------"
echo "[WAIT] Đang đợi 10 giây để hệ thống mạng ổn định..."
sleep 10
echo "[OK] Đã ổn định. Bắt đầu chạy Containers!"
echo "----------------------------------------------------"

# ===================== Pull & Run =====================
echo "[INFO] Pulling images..."
set +e
timeout 300 docker pull "${TM_IMAGE}"
timeout 300 docker pull mysteriumnetwork/myst:latest
timeout 300 docker pull "$UR_IMAGE"
set -e
docker pull "${TM_IMAGE}" || true
docker pull mysteriumnetwork/myst:latest || true
docker pull "$UR_IMAGE" || true

# --- Traffmonetizer ---
echo "[INFO] Run Traffmonetizer..."
docker run -d --network "${NET1_NAME}" --restart always --name tm1 "${TM_IMAGE}" start accept --token "${TOKEN}"
docker run -d --network "${NET2_NAME}" --restart always --name tm2 "${TM_IMAGE}" start accept --token "${TOKEN}"

# --- Mysterium ---
echo "[INFO] Run Myst..."
docker run -d --network "${NET1_NAME}" --cap-add NET_ADMIN \
  -p "${IP1}:${MYST_PORT}:${MYST_PORT}" \
  -v myst-data1:/var/lib/mysterium-node \
  --restart always --name myst1 mysteriumnetwork/myst:latest service --agreed-terms-and-conditions

docker run -d --network "${NET2_NAME}" --cap-add NET_ADMIN \
  -p "${IP2}:${MYST_PORT}:${MYST_PORT}" \
  -v myst-data2:/var/lib/mysterium-node \
  --restart always --name myst2 mysteriumnetwork/myst:latest service --agreed-terms-and-conditions

# --- URNetwork ---
echo "[INFO] Run URNetwork..."
UR_VOL1="vnstat_data_ur1"
UR_VOL2="vnstat_data_ur2"
docker volume create "$UR_VOL1" >/dev/null 2>&1 || true
docker volume create "$UR_VOL2" >/dev/null 2>&1 || true

UR_PROXY_MOUNT=()
if [[ -n "$UR_PROXY_FILE" && -f "$UR_PROXY_FILE" ]]; then
  UR_PROXY_MOUNT=( -v "$UR_PROXY_FILE:/app/proxy.txt" )
fi

docker run -d $UR_PLATFORM --name "ur1" --network "${NET1_NAME}" --restart always \
  -e UPROCK_USER="$UR_USER" -e UPROCK_PASS="$UR_PASS" -e ENABLE_IP_CHECKER="$UR_ENABLE_IP_CHECKER" \
  -v "$UR_VOL1:/var/lib/vnstat" "${UR_PROXY_MOUNT[@]}" "$UR_IMAGE"

docker run -d $UR_PLATFORM --name "ur2" --network "${NET2_NAME}" --restart always \
  -e UPROCK_USER="$UR_USER" -e UPROCK_PASS="$UR_PASS" -e ENABLE_IP_CHECKER="$UR_ENABLE_IP_CHECKER" \
  -v "$UR_VOL2:/var/lib/vnstat" "${UR_PROXY_MOUNT[@]}" "$UR_IMAGE"

echo ""
echo "================= DONE ================="
echo "Interface: $DEV"
echo "IP1: $IP1"
echo "IP2: $IP2"
echo "========================================"
