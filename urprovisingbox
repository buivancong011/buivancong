#!/usr/bin/env bash
set -Eeuo pipefail

# ===================== CONFIG =====================
UR_API="${UR_API:-https://api.bringyour.com}"
IMAGE="${IMAGE:-bringyour/community-provider:g4-latest}"

# Ph√°t hi·ªán csboxN v√† g·∫Øn net=container:csboxN
SBOX_PREFIX="${SBOX_PREFIX:-csbox}"
# T√™n container UR t∆∞∆°ng ·ª©ng: ur-csboxN
UR_PREFIX="${UR_PREFIX:-ur-}"

# Th∆∞ m·ª•c l∆∞u JWT (m·ªói sbox 1 th∆∞ m·ª•c): ~/.urnetwork-csboxN/jwt
JWT_DIR_BASE="${JWT_DIR_BASE:-$HOME}"

# KH√îNG auto pull khi up (b·∫°n c·∫≠p nh·∫≠t th·ªß c√¥ng b·∫±ng l·ªánh `update`)
PULL_ON_START="${PULL_ON_START:-false}"

# Log & recreate
LOG_MAX_SIZE="${LOG_MAX_SIZE:-10m}"
LOG_MAX_FILE="${LOG_MAX_FILE:-3}"
RECREATE_DELAY="${RECREATE_DELAY:-3}"

# Ng∆∞·ª°ng coi l√† "s·∫Øp h·∫øt h·∫°n"
ADMIN_JWT_RENEW_BEFORE="${ADMIN_JWT_RENEW_BEFORE:-600}"     # 10 ph√∫t
CLIENT_JWT_RENEW_BEFORE="${CLIENT_JWT_RENEW_BEFORE:-86400}" # 24 gi·ªù

# ==== T√†i kho·∫£n m·∫∑c ƒë·ªãnh c·ªßa b·∫°n (c√≥ th·ªÉ override b·∫±ng env) ====
# C√°ch A: d√πng AUTH_CODE (n·∫øu c√≥)
AUTH_CODE="${AUTH_CODE:-}"
# C√°ch B: d√πng USER_AUTH + PASSWORD
USER_AUTH="${USER_AUTH:-buivancong012@gmail.com}"
PASSWORD="${PASSWORD:-buivancong012}"

# Cache admin JWT
ADMIN_JWT_FILE="${ADMIN_JWT_FILE:-$HOME/.urnetwork-admin.jwt}"

# ===================== UTILS =====================
die(){ echo "[ERR] $*" >&2; exit 1; }
info(){ echo "[INFO] $*"; }
warn(){ echo "‚ö† $*"; }

need_bin(){ command -v "$1" >/dev/null 2>&1 || die "Thi·∫øu l·ªánh '$1'."; }
docker_ok(){ need_bin docker; }
jq_ok(){ need_bin jq; }
curl_ok(){ need_bin curl; }
b64_ok(){ need_bin base64; }

now_ts(){ date +%s; }

# Decode ph·∫ßn payload c·ªßa JWT (base64url)
jwt_payload_json(){
  local jwt="$1" p pad
  p="$(printf '%s' "$jwt" | cut -d. -f2)"
  pad=$(( (4 - (${#p} % 4)) % 4 ))
  p="${p}$(printf '=%.0s' $(seq 1 $pad))"
  printf '%s' "$p" | tr '_-' '/+' | base64 -d 2>/dev/null || true
}
jwt_exp_ts(){ jwt_payload_json "$1" | jq -r '.exp // empty'; }
jwt_about_to_expire(){
  local jwt="$1" th="$2" exp now
  exp="$(jwt_exp_ts "$jwt")"
  [[ -z "$exp" ]] && return 0
  now="$(now_ts)"
  (( exp - now <= th ))
}

discover_sboxes(){
  docker ps -a --format '{{.Names}}' | awk -v pfx="^${SBOX_PREFIX}[0-9]+$" '$0 ~ pfx' | sort -V
}

pull_image(){
  [[ "$PULL_ON_START" != true ]] && return 0
  info "Pull image $IMAGE ..."
  for i in 1 2 3; do
    if docker pull "$IMAGE" >/dev/null 2>&1; then
      info "Pull OK ($i/3)"; return 0
    fi
    warn "Pull th·∫•t b·∫°i l·∫ßn $i ‚Äî th·ª≠ l·∫°i..."; sleep $((i*2))
  done
  die "Kh√¥ng th·ªÉ pull $IMAGE."
}

api_post(){ # body t·ª´ stdin
  local path="$1"
  curl -sS --fail --connect-timeout 8 --max-time 30 \
    -H 'Content-Type: application/json' -d @- "${UR_API}${path}"
}
api_post_auth(){ # body t·ª´ stdin
  local path="$1" jwt="$2"
  curl -sS --fail --connect-timeout 8 --max-time 30 \
    -H 'Content-Type: application/json' -H "Authorization: Bearer ${jwt}" \
    -d @- "${UR_API}${path}"
}

# ===================== ADMIN JWT =====================
admin_jwt_from_cache(){ [[ -s "$ADMIN_JWT_FILE" ]] && tr -d '\r\n' < "$ADMIN_JWT_FILE"; }
save_admin_jwt(){ printf '%s' "$1" >"$ADMIN_JWT_FILE"; chmod 600 "$ADMIN_JWT_FILE" || true; }

fetch_admin_jwt_with_auth_code(){
  local out by
  out="$(jq -nc --arg c "$AUTH_CODE" '{auth_code:$c}' | api_post "/auth/code-login" || true)"
  by="$(echo "$out" | jq -r '.by_jwt // empty')"
  [[ -n "$by" ]] || die "ƒê·ªïi AUTH_CODE th·∫•t b·∫°i: $out"
  printf '%s' "$by"
}
fetch_admin_jwt_with_password(){
  local out by
  out="$(jq -nc --arg u "$USER_AUTH" --arg p "$PASSWORD" \
        '{user_auth:$u, password:$p}' | api_post "/auth/login-with-password" || true)"
  by="$(echo "$out" | jq -r '.by_jwt // .network.by_jwt // empty')"
  [[ -n "$by" ]] || die "login-with-password ch∆∞a ra JWT (c√≥ th·ªÉ c·∫ßn verify 2FA): $out"
  printf '%s' "$by"
}

get_fresh_admin_jwt(){
  local cached; cached="$(admin_jwt_from_cache || true)"
  if [[ -n "$cached" ]] && ! jwt_about_to_expire "$cached" "$ADMIN_JWT_RENEW_BEFORE"; then
    printf '%s' "$cached"; return 0
  fi
  local new
  if [[ -n "$AUTH_CODE" ]]; then
    info "L√†m m·ªõi ADMIN_JWT t·ª´ AUTH_CODE ..."; new="$(fetch_admin_jwt_with_auth_code)"
  else
    info "L√†m m·ªõi ADMIN_JWT b·∫±ng USER_AUTH/PASSWORD ..."; new="$(fetch_admin_jwt_with_password)"
  fi
  save_admin_jwt "$new"; printf '%s' "$new"
}

# ===================== CLIENT JWT (per sbox) =====================
jwt_dir_for_sbox(){ echo "${JWT_DIR_BASE}/.urnetwork-$1"; }
jwt_file_for_sbox(){ echo "$(jwt_dir_for_sbox "$1")/jwt"; }
container_name_for_sbox(){ echo "${UR_PREFIX}$1"; }

issue_client_jwt(){
  local desc="$1" spec="${2:-docker-ur:g4}" admin="$3" payload out
  payload="$(jq -nc --arg d "$desc" --arg s "$spec" '{description:$d, device_spec:$s}')"
  out="$(printf '%s' "$payload" | api_post_auth "/network/auth-client" "$admin" || true)"
  echo "$out" | jq -r '.by_client_jwt // empty'
}

ensure_client_jwt_valid(){
  local s="$1" dir jwt_file admin jwt
  dir="$(jwt_dir_for_sbox "$s")"; jwt_file="$(jwt_file_for_sbox "$s")"
  mkdir -p "$dir"

  if [[ -s "$jwt_file" ]]; then
    jwt="$(tr -d '\r\n' < "$jwt_file")"
    if ! jwt_about_to_expire "$jwt" "$CLIENT_JWT_RENEW_BEFORE"; then
      echo "OK"; return 0
    fi
    info "$s: JWT s·∫Øp h·∫øt h·∫°n ‚Üí gia h·∫°n‚Ä¶"
  else
    info "$s: Ch∆∞a c√≥ JWT ‚Üí c·∫•p m·ªõi‚Ä¶"
  fi

  admin="$(get_fresh_admin_jwt)"
  local new; new="$(issue_client_jwt "$s" "docker-ur:g4" "$admin")"
  [[ -n "$new" ]] || die "$s: Kh√¥ng c·∫•p ƒë∆∞·ª£c client JWT."
  printf '%s' "$new" >"$jwt_file"; chmod 600 "$jwt_file" || true
  echo "RENEWED"
}

run_or_restart_for_sbox(){
  local s="$1" cname jwt_dir st
  cname="$(container_name_for_sbox "$s")"
  jwt_dir="$(jwt_dir_for_sbox "$s")"
  st="$(docker inspect -f '{{.State.Status}}' "$s" 2>/dev/null || true)"
  if [[ "$st" != "running" ]]; then warn "$s kh√¥ng running ‚Üí b·ªè qua."; return 0; fi

  docker rm -f "$cname" >/dev/null 2>&1 || true
  sleep "$RECREATE_DELAY"

  docker run -d --name "$cname" \
    --restart=always \
    --log-opt "max-size=${LOG_MAX_SIZE}" --log-opt "max-file=${LOG_MAX_FILE}" \
    --network "container:${s}" \
    -v "${jwt_dir}:/root/.urnetwork" \
    "$IMAGE" provide >/dev/null

  info "‚úî $cname (net=container:$s) ƒë√£ start"
  sleep "$RECREATE_DELAY"
}

# ===================== COMMANDS =====================
cmd_auth(){
  docker_ok; curl_ok; jq_ok; b64_ok
  get_fresh_admin_jwt >/dev/null
  info "‚úî ADMIN_JWT OK (cache: $ADMIN_JWT_FILE)"
}
cmd_up(){
  docker_ok; curl_ok; jq_ok; b64_ok
  pull_image
  local sboxes; sboxes="$(discover_sboxes)"
  [[ -n "$sboxes" ]] || die "Kh√¥ng t√¨m th·∫•y ${SBOX_PREFIX}N n√†o."
  get_fresh_admin_jwt >/dev/null

  info "Ph√°t hi·ªán routes:"; echo "$sboxes" | xargs -I{} echo " - {}"
  while read -r s; do
    local res; res="$(ensure_client_jwt_valid "$s")"
    [[ "$res" == "RENEWED" ]] && info "$s: JWT ƒë√£ gia h·∫°n."
    run_or_restart_for_sbox "$s"
  done <<< "$sboxes"
  info "‚úÖ Ho√†n t·∫•t. D√πng: $0 status | $0 logs"
}
cmd_down(){
  docker_ok
  docker ps -a --format '{{.Names}}' \
    | awk -v pfx="^${UR_PREFIX}${SBOX_PREFIX}[0-9]+$" '$0 ~ pfx' \
    | while read -r n; do docker rm -f "$n" >/dev/null 2>&1 && echo "‚úó $n ƒë√£ xo√°" || true; done
  info "[DONE] ƒê√£ d·ª´ng to√†n b·ªô UR containers."
}
cmd_status(){
  docker_ok; jq_ok; b64_ok
  local sboxes; sboxes="$(discover_sboxes)"
  [[ -n "$sboxes" ]] || { info "Kh√¥ng th·∫•y ${SBOX_PREFIX}N n√†o."; exit 0; }
  printf "%-10s | %-14s | %-10s | %-25s\n" "SBOX" "CONTAINER" "STATUS" "JWT TR·∫†NG TH√ÅI"
  echo "-----------------------------------------------------------------------"
  while read -r s; do
    local cname; cname="$(container_name_for_sbox "$s")"
    local jwt_file; jwt_file="$(jwt_file_for_sbox "$s")"
    local st; st="$(docker inspect -f '{{.State.Status}}' "$cname" 2>/dev/null || echo '-')"
    local status="MISSING"
    if [[ -s "$jwt_file" ]]; then
      local jwt; jwt="$(tr -d '\r\n' < "$jwt_file")"
      local exp; exp="$(jwt_exp_ts "$jwt")"
      if [[ -n "$exp" ]]; then
        local now; now="$(now_ts)"
        local left=$(( exp - now ))
        if (( left > 31536000 )); then
          status="vƒ©nh vi·ªÖn (exp xa >1y)"
        elif (( left > 0 )); then
          status="c√≤n ${left}s (~$((left/86400)) ng√†y)"
        else
          status="H·∫æT H·∫†N!"
        fi
      else
        status="vƒ©nh vi·ªÖn (kh√¥ng c√≥ exp)"
      fi
    fi
    printf "%-10s | %-14s | %-10s | %-25s\n" "$s" "$cname" "$st" "$status"
  done <<< "$sboxes"
}
cmd_logs(){
  docker_ok
  docker ps -a --format '{{.Names}}' \
    | awk -v pfx="^${UR_PREFIX}${SBOX_PREFIX}[0-9]+$" '$0 ~ pfx' \
    | while read -r n; do
        echo "===== $n ====="
        docker logs --since=30m -n 200 "$n" || true
      done
}
cmd_renew(){
  docker_ok; curl_ok; jq_ok; b64_ok
  local force="${1:-}"
  local sboxes; sboxes="$(discover_sboxes)"
  [[ -n "$sboxes" ]] || die "Kh√¥ng t√¨m th·∫•y ${SBOX_PREFIX}N n√†o."
  get_fresh_admin_jwt >/dev/null

  while read -r s; do
    local jwt_file; jwt_file="$(jwt_file_for_sbox "$s")"
    local need=false
    if [[ "$force" == "--force" ]]; then
      need=true
    elif [[ -s "$jwt_file" ]]; then
      jwt_about_to_expire "$(tr -d '\r\n' < "$jwt_file")" "$CLIENT_JWT_RENEW_BEFORE" && need=true
    else
      need=true
    fi
    if $need; then
      info "$s: gia h·∫°n client JWT..."
      local admin new
      admin="$(get_fresh_admin_jwt)"
      new="$(issue_client_jwt "$s" "docker-ur:g4" "$admin")"
      [[ -n "$new" ]] || { warn "$s: c·∫•p JWT th·∫•t b·∫°i, b·ªè qua."; continue; }
      printf '%s' "$new" >"$jwt_file"; chmod 600 "$jwt_file" || true
      run_or_restart_for_sbox "$s"
    else
      info "$s: JWT c√≤n h·∫°n ƒë·ªß d√†i ‚Üí b·ªè qua"
    fi
  done <<< "$sboxes"
  info "‚úÖ Renew xong."
}
cmd_update(){
  docker_ok
  info "ƒêang ki·ªÉm tra v√† t·∫£i image m·ªõi nh·∫•t: $IMAGE ..."
  if docker pull "$IMAGE"; then
    local new_id
    new_id="$(docker image inspect "$IMAGE" -f '{{.Id}}' 2>/dev/null || true)"
    info "‚úÖ ƒê√£ c·∫≠p nh·∫≠t image: $IMAGE"
    [[ -n "$new_id" ]] && echo "‚Üí Image ID m·ªõi: $new_id"
    echo
    echo "üëâ Gi·ªù b·∫°n ch·∫°y:  $0 up   ƒë·ªÉ kh·ªüi ƒë·ªông l·∫°i containers v·ªõi image m·ªõi."
  else
    die "‚ùå Kh√¥ng th·ªÉ pull image. Ki·ªÉm tra m·∫°ng/registry."
  fi
}

usage(){
  cat <<'EOF'
Usage:
  # ƒêƒÉng nh·∫≠p (l·∫•y/l√†m m·ªõi ADMIN_JWT, c√≥ cache):
  ./urprovisingbox auth

  # Kh·ªüi ch·∫°y ho·∫∑c c·∫≠p nh·∫≠t containers (m·ªói csboxN 1 JWT ri√™ng):
  ./urprovisingbox up

  # D·ª´ng & xo√° to√†n b·ªô ur-csboxN (kh√¥ng xo√° JWT tr√™n ƒëƒ©a):
  ./urprovisingbox down

  # Tr·∫°ng th√°i + JWT c√≤n h·∫°n hay vƒ©nh vi·ªÖn:
  ./urprovisingbox status

  # Xem logs 30 ph√∫t g·∫ßn nh·∫•t:
  ./urprovisingbox logs

  # Gia h·∫°n JWT khi g·∫ßn h·∫øt h·∫°n (ho·∫∑c √©p gia h·∫°n to√†n b·ªô):
  ./urprovisingbox renew
  ./urprovisingbox renew --force

  # C·∫≠p nh·∫≠t image th·ªß c√¥ng:
  ./urprovisingbox update

Env tu·ª≥ ch·ªçn:
  UR_API, IMAGE, SBOX_PREFIX, UR_PREFIX, JWT_DIR_BASE
  PULL_ON_START=true|false (m·∫∑c ƒë·ªãnh false ƒë·ªÉ update th·ªß c√¥ng)
  LOG_MAX_SIZE, LOG_MAX_FILE, RECREATE_DELAY
  ADMIN_JWT_RENEW_BEFORE, CLIENT_JWT_RENEW_BEFORE
  # ƒêƒÉng nh·∫≠p:
  AUTH_CODE="XXXX-XXXX"
  ho·∫∑c: USER_AUTH="email" PASSWORD="pass" (m·∫∑c ƒë·ªãnh ƒë√£ l√† t√†i kho·∫£n c·ªßa b·∫°n)
EOF
}

# ===================== MAIN =====================
case "${1:-}" in
  auth)    docker_ok; curl_ok; jq_ok; b64_ok; cmd_auth ;;
  up)      docker_ok; curl_ok; jq_ok; b64_ok; cmd_up ;;
  down)    cmd_down ;;
  status)  cmd_status ;;
  logs)    cmd_logs ;;
  renew)   shift || true; cmd_renew "${1:-}" ;;
  update)  cmd_update ;;
  ""|help|-h|--help) usage ;;
  *) die "L·ªánh kh√¥ng h·ª£p l·ªá. Xem: $0 help" ;;
esac
