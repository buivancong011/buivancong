#!/bin/bash
set -e

# ==== Cáº¤U HÃŒNH ====
IMG_MYST="mysteriumnetwork/myst:latest"

# MÃ u sáº¯c thÃ´ng bÃ¡o
GREEN='\033[0;32m'
RED='\033[0;31m'
NC='\033[0m'

log() { echo -e "${GREEN}[INFO] $1${NC}"; }
err() { echo -e "${RED}[ERROR] $1${NC}"; exit 1; }

# ==== 1. Láº¤Y IP PRIVATE Äá»‚ BIND PORT (Báº¯t buá»™c cho Multi-IP) ====
# Cáº§n láº¥y IP nÃ y Ä‘á»ƒ map port 4449 chÃ­nh xÃ¡c, trÃ¡nh xung Ä‘á»™t giá»¯a 2 node
IP_PRIVATE_A=$(/sbin/ip -4 -o addr show scope global noprefixroute ens5 | awk '{gsub(/\/.*/,"",$4); print $4}')
IP_PRIVATE_B=$(/sbin/ip -4 -o addr show scope global dynamic ens5 | awk '{gsub(/\/.*/,"",$4); print $4}')

if [ -z "$IP_PRIVATE_A" ] || [ -z "$IP_PRIVATE_B" ]; then 
    err "KhÃ´ng láº¥y Ä‘Æ°á»£c IP Private trÃªn ens5! Kiá»ƒm tra láº¡i máº¡ng."
fi

log "IP Private detected: A=$IP_PRIVATE_A | B=$IP_PRIVATE_B"

# ==== 2. HÃ€M Táº O Láº I MYSTERIUM ====
recreate_myst() {
    local ID=$1
    local BIND_IP=$2
    local NAME="myst$ID"
    local NET="my_network_$ID"
    local VOL="myst-data$ID"  # TÃªn volume cÅ© chá»©a dá»¯ liá»‡u

    log "------------------------------------------------"
    log "ğŸ›   Äang xá»­ lÃ½ node: $NAME (Network: $NET)"

    # BÆ°á»›c 1: XÃ³a container cÅ©
    if docker ps -a --format '{{.Names}}' | grep -q "^${NAME}$"; then
        log "ğŸ—‘  XÃ³a container cÅ©..."
        docker rm -f "$NAME" >/dev/null 2>&1
    else
        log "â„¹ï¸  Container $NAME khÃ´ng tá»“n táº¡i, sáº½ táº¡o má»›i."
    fi

    # BÆ°á»›c 2: Táº¡o láº¡i vá»›i DNS má»›i + Giá»¯ Volume
    log "ğŸš€ Khá»Ÿi cháº¡y láº¡i vá»›i DNS 1.1.1.1..."
    
    docker run -d \
        --name "$NAME" \
        --network "$NET" \
        --restart unless-stopped \
        --cap-add NET_ADMIN \
        --dns 1.1.1.1 \
        --dns 1.0.0.1 \
        -p "${BIND_IP}:4449:4449" \
        -v "${VOL}:/var/lib/mysterium-node" \
        "$IMG_MYST" service --agreed-terms-and-conditions >/dev/null

    log "âœ… $NAME Ä‘Ã£ cháº¡y thÃ nh cÃ´ng!"
}

# ==== 3. THá»°C THI ====
# Pull image má»›i nháº¥t Ä‘á»ƒ Ä‘áº£m báº£o update pháº§n má»m
log "ğŸ“¥ Äang táº£i image Mysterium má»›i nháº¥t..."
docker pull "$IMG_MYST" >/dev/null

# Cháº¡y cho Node 1 vÃ  Node 2
recreate_myst 1 "$IP_PRIVATE_A"
recreate_myst 2 "$IP_PRIVATE_B"

log "------------------------------------------------"
log "ğŸ‰ HOÃ€N Táº¤T! Dá»¯ liá»‡u (Identity/Tiá»n) Ä‘Ã£ Ä‘Æ°á»£c giá»¯ nguyÃªn."
# Kiá»ƒm tra nhanh xem ID cÅ© cÃ²n khÃ´ng
log "ğŸ” Kiá»ƒm tra ID cá»§a myst1:"
docker exec myst1 myst cli identities list | grep "0x" || echo "KhÃ´ng tÃ¬m tháº¥y ID (CÃ³ thá»ƒ do lá»—i Volume)"
