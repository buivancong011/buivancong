#!/bin/bash

# =================================================================
# C·∫§U H√åNH V√ç CHU·∫®N ƒê·ªÇ SO S√ÅNH
# =================================================================
TARGET_WALLET="0x22cBdE4c61BA69374169eB9B1a49d62Db3beCC7f"
# =================================================================

# M√†u s·∫Øc
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

echo "========================================================================================================================"
echo "   MYSTERIUM AUDIT V4 (HI·ªÜN V√ç - FIX L·ªñI HI·ªÇN TH·ªä)"
echo "   V√≠ chu·∫©n: $TARGET_WALLET"
echo "========================================================================================================================"

NODES=$(docker ps --format "{{.Names}}" | grep "myst")

if [ -z "$NODES" ]; then echo "‚ùå Kh√¥ng t√¨m th·∫•y node."; exit 1; fi

# Header b·∫£ng (M·ªü r·ªông c·ªôt V√≠)
printf "%-8s | %-12s | %-10s | %-48s | %-20s\n" "NODE" "TR·∫†NG TH√ÅI" "VPN SVC" "ƒê·ªäA CH·ªà V√ç TR√äN NODE (Beneficiary)" "T√ÄI CH√çNH (Bal/Tot)"
echo "------------------------------------------------------------------------------------------------------------------------"

for node in $NODES; do
    # 1. L·∫§Y IDENTITY
    RAW_LIST=$(docker exec "$node" myst cli identities list 2>/dev/null)
    ID=$(echo "$RAW_LIST" | grep -oE '0x[a-fA-F0-9]{40}' | head -n 1)

    if [ -z "$ID" ]; then
        printf "%-8s | %b | %s | %s | %s\n" "$node" "${RED}No ID ‚ùå${NC}" "-" "-" "C·∫ßn t·∫°o ID m·ªõi"
        continue
    fi

    # 2. UNLOCK (B·∫Øt bu·ªôc ƒë·ªÉ l·ªánh get kh√¥ng b·ªã l·ªói)
    docker exec "$node" myst cli identities unlock "$ID" >/dev/null 2>&1

    # 3. L·∫§Y TH√îNG TIN CHUNG (Fix c·ªôt c·∫Øt chu·ªói)
    INFO=$(docker exec "$node" myst cli identities get "$ID" 2>&1)

    # Log m·∫´u: [INFO] Registration Status: Registered (C·ªôt 4)
    STATUS_RAW=$(echo "$INFO" | grep "Registration Status" | awk '{print $4}')
    
    # Log m·∫´u: [INFO] Balance: 0.001705 MYST (C·ªôt 3)
    BALANCE=$(echo "$INFO" | grep "Balance:" | awk '{print $3}')
    
    # Log m·∫´u: [INFO] Earnings total: 7.960643 (C·ªôt 4)
    TOTAL_EARN=$(echo "$INFO" | grep "Earnings total:" | awk '{print $4}')

    # X·ª≠ l√Ω m√†u tr·∫°ng th√°i
    if [[ "$STATUS_RAW" == "Registered" ]]; then
        STATUS_TXT="${GREEN}Registered${NC}"
    elif [[ "$STATUS_RAW" == "InProgress" ]]; then
        STATUS_TXT="${YELLOW}Pending...${NC}"
    else
        STATUS_TXT="${RED}Unregistered${NC}"
    fi

    # 4. KI·ªÇM TRA WIREGUARD
    SVC_LIST=$(docker exec "$node" myst cli service list 2>&1)
    if echo "$SVC_LIST" | grep -q "Type: wireguard"; then
        WG_TXT="${GREEN}B·∫≠t üöÄ${NC}"
    else
        WG_TXT="${RED}T·∫Øt üõë${NC}"
    fi

    # 5. L·∫§Y ƒê·ªäA CH·ªà V√ç (HI·ªÜN NGUY√äN VƒÇN)
    BEN_LOG=$(docker exec "$node" myst cli identities beneficiary-status "$ID" 2>&1)
    
    # Log m·∫´u: [INFO] Current beneficiary: 0x... (C·ªôt 4)
    CURRENT_WALLET=$(echo "$BEN_LOG" | grep "Current beneficiary" | awk '{print $4}')

    # So s√°nh v√≠
    if [ "$CURRENT_WALLET" == "$TARGET_WALLET" ]; then
        # N·∫øu ƒë√∫ng: Hi·ªán v√≠ m√†u xanh
        WALLET_DISPLAY="${GREEN}${CURRENT_WALLET} ‚úÖ${NC}"
    else
        # N·∫øu sai ho·∫∑c r·ªóng
        if [ -z "$CURRENT_WALLET" ] || [ "$CURRENT_WALLET" == "None" ]; then
             WALLET_DISPLAY="${RED}CH∆ØA C√ÄI V√ç ‚ùå${NC}"
        else
             WALLET_DISPLAY="${RED}${CURRENT_WALLET} (SAI) ‚ö†Ô∏è${NC}"
        fi
    fi

    # 6. IN RA M√ÄN H√åNH
    # N·∫øu balance r·ªóng th√¨ ƒëi·ªÅn s·ªë 0
    if [ -z "$BALANCE" ]; then BALANCE="0"; fi
    if [ -z "$TOTAL_EARN" ]; then TOTAL_EARN="0"; fi

    FINANCE_TXT="${BLUE}$BALANCE${NC} / ${YELLOW}$TOTAL_EARN${NC}"
    
    printf "%-8s | %b | %b | %b | %b\n" "$node" "$STATUS_TXT" "$WG_TXT" "$WALLET_DISPLAY" "$FINANCE_TXT"

done

echo "------------------------------------------------------------------------------------------------------------------------"
