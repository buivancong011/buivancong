#!/bin/bash

# =================================================================
# C·∫§U H√åNH V√ç CHU·∫®N (ƒê·ªÇ SO S√ÅNH)
# =================================================================
TARGET_WALLET="0x22cBdE4c61BA69374169eB9B1a49d62Db3beCC7f"
# =================================================================

# M√†u s·∫Øc
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

echo "========================================================================================================================"
echo "   MYSTERIUM WALLET AUDIT & STATUS"
echo "   V√≠ chu·∫©n h·ªá th·ªëng: $TARGET_WALLET"
echo "========================================================================================================================"

NODES=$(docker ps --format "{{.Names}}" | grep "myst")

if [ -z "$NODES" ]; then echo "‚ùå Kh√¥ng t√¨m th·∫•y node."; exit 1; fi

# Header b·∫£ng (M·ªü r·ªông c·ªôt V√≠ ƒë·ªÉ hi·ªÉn th·ªã full ƒë·ªãa ch·ªâ)
printf "%-8s | %-12s | %-10s | %-55s | %-20s\n" "NODE" "TR·∫†NG TH√ÅI" "VPN SVC" "ƒê·ªäA CH·ªà V√ç TR√äN NODE (Beneficiary)" "T√ÄI CH√çNH (Bal/Tot)"
echo "------------------------------------------------------------------------------------------------------------------------"

for node in $NODES; do
    # 1. L·∫§Y IDENTITY
    RAW_LIST=$(docker exec "$node" myst cli identities list 2>/dev/null)
    ID=$(echo "$RAW_LIST" | grep -oE '0x[a-fA-F0-9]{40}' | head -n 1)

    if [ -z "$ID" ]; then
        printf "%-8s | %b | %s | %s | %s\n" "$node" "${RED}No ID ‚ùå${NC}" "-" "-" "C·∫ßn t·∫°o ID m·ªõi"
        continue
    fi

    # 2. QUAN TR·ªåNG: UNLOCK ƒê·ªÇ L·∫§Y D·ªÆ LI·ªÜU
    docker exec "$node" myst cli identities unlock "$ID" >/dev/null 2>&1

    # 3. L·∫§Y TH√îNG TIN CHUNG
    INFO=$(docker exec "$node" myst cli identities get "$ID" 2>&1)

    # Parse Tr·∫°ng th√°i
    if echo "$INFO" | grep -q "Registered"; then
        STATUS_TXT="${GREEN}Registered${NC}"
    elif echo "$INFO" | grep -q "InProgress"; then
        STATUS_TXT="${YELLOW}Pending...${NC}"
    else
        STATUS_TXT="${RED}Unregistered${NC}"
    fi

    # Parse T√†i ch√≠nh
    BALANCE=$(echo "$INFO" | grep "Balance:" | awk '{print $3}')
    TOTAL_EARN=$(echo "$INFO" | grep "Earnings total:" | awk '{print $4}')
    if [ -z "$BALANCE" ]; then BALANCE="0"; fi

    # 4. KI·ªÇM TRA WIREGUARD
    SVC_LIST=$(docker exec "$node" myst cli service list 2>&1)
    if echo "$SVC_LIST" | grep -q "Type: wireguard"; then
        WG_TXT="${GREEN}B·∫≠t üöÄ${NC}"
    else
        WG_TXT="${RED}T·∫Øt üõë${NC}"
    fi

    # 5. KI·ªÇM TRA V√ç (PH·∫¶N QUAN TR·ªåNG NH·∫§T)
    BEN_LOG=$(docker exec "$node" myst cli identities beneficiary-status "$ID" 2>&1)
    
    # L·∫•y ƒë·ªãa ch·ªâ v√≠ th·ª±c t·∫ø ƒëang c√†i tr√™n node
    CURRENT_WALLET=$(echo "$BEN_LOG" | grep "Current beneficiary" | awk '{print $NF}')

    # So s√°nh v√† t√¥ m√†u
    if [ "$CURRENT_WALLET" == "$TARGET_WALLET" ]; then
        # N·∫øu kh·ªõp: In v√≠ m√†u xanh + d·∫•u t√≠ch
        WALLET_DISPLAY="${GREEN}${CURRENT_WALLET} ‚úÖ${NC}"
    else
        # N·∫øu l·ªách: In v√≠ m√†u ƒë·ªè + c·∫£nh b√°o
        if [ -z "$CURRENT_WALLET" ] || [ "$CURRENT_WALLET" == "None" ]; then
             WALLET_DISPLAY="${RED}CH∆ØA C√ÄI V√ç! ‚ùå${NC}"
        else
             WALLET_DISPLAY="${RED}${CURRENT_WALLET} (SAI) ‚ö†Ô∏è${NC}"
        fi
    fi

    # 6. IN RA M√ÄN H√åNH
    FINANCE_TXT="${BLUE}$BALANCE${NC} / ${YELLOW}$TOTAL_EARN${NC}"
    printf "%-8s | %b | %b | %b | %b\n" "$node" "$STATUS_TXT" "$WG_TXT" "$WALLET_DISPLAY" "$FINANCE_TXT"

done

echo "------------------------------------------------------------------------------------------------------------------------"
echo "üëâ Ki·ªÉm tra c·ªôt 'ƒê·ªäA CH·ªà V√ç TR√äN NODE':"
echo "   - N·∫øu th·∫•y m√†u XANH l√° c√¢y v√† c√≥ d·∫•u ‚úÖ -> Tuy·ªát ƒë·ªëi an to√†n."
echo "   - N·∫øu th·∫•y m√†u ƒê·ªé -> C·∫ßn set l·∫°i v√≠ ngay."
