#!/bin/bash

# =================================================================
# C·∫§U H√åNH V√ç CHU·∫®N (ƒê·ªÇ SO S√ÅNH)
# =================================================================
TARGET_WALLET="0x22cBdE4c61BA69374169eB9B1a49d62Db3beCC7f"
# =================================================================

# M√†u s·∫Øc
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

echo "========================================================================================================================"
echo "   MYSTERIUM AUDIT V6 (CHECK V√ç & WIREGUARD CHU·∫®N LOG)"
echo "   V√≠ chu·∫©n: $TARGET_WALLET"
echo "========================================================================================================================"

NODES=$(docker ps --format "{{.Names}}" | grep "myst")

if [ -z "$NODES" ]; then echo "‚ùå Kh√¥ng t√¨m th·∫•y node."; exit 1; fi

# Header b·∫£ng
printf "%-8s | %-12s | %-12s | %-48s | %-20s\n" "NODE" "TR·∫†NG TH√ÅI" "WIREGUARD" "ƒê·ªäA CH·ªà V√ç HI·ªÜN T·∫†I (Current Beneficiary)" "T√ÄI CH√çNH (Bal/Tot)"
echo "------------------------------------------------------------------------------------------------------------------------"

for node in $NODES; do
    # 1. L·∫§Y IDENTITY
    RAW_LIST=$(docker exec "$node" myst cli identities list 2>/dev/null)
    ID=$(echo "$RAW_LIST" | grep -oE '0x[a-fA-F0-9]{40}' | head -n 1)

    if [ -z "$ID" ]; then
        printf "%-8s | %b | %s | %s | %s\n" "$node" "${RED}No ID ‚ùå${NC}" "-" "-" "C·∫ßn t·∫°o ID m·ªõi"
        continue
    fi

    # 2. UNLOCK (QUAN TR·ªåNG: ƒê·ªÉ l·∫•y d·ªØ li·ªáu ch√≠nh x√°c)
    docker exec "$node" myst cli identities unlock "$ID" >/dev/null 2>&1

    # 3. L·∫§Y TH√îNG TIN T√ÄI CH√çNH & TR·∫†NG TH√ÅI (L·ªánh: identities get)
    INFO=$(docker exec "$node" myst cli identities get "$ID" 2>&1)
    
    # [INFO] Registration Status: Registered (C·ªôt 4)
    STATUS_RAW=$(echo "$INFO" | grep "Registration Status" | awk '{print $4}')
    
    # [INFO] Balance: 0.001705 MYST (C·ªôt 3)
    BALANCE=$(echo "$INFO" | grep "Balance:" | awk '{print $3}')
    
    # [INFO] Earnings total: 7.960643 (C·ªôt 4)
    TOTAL_EARN=$(echo "$INFO" | grep "Earnings total:" | awk '{print $4}')

    # M√†u tr·∫°ng th√°i
    if [[ "$STATUS_RAW" == "Registered" ]]; then
        STATUS_TXT="${GREEN}Registered${NC}"
    elif [[ "$STATUS_RAW" == "InProgress" ]]; then
        STATUS_TXT="${YELLOW}Pending...${NC}"
    else
        STATUS_TXT="${RED}Unreg...${NC}"
    fi

    # 4. CHECK WIREGUARD (L·ªánh: service list)
    # T√¨m d√≤ng ch·ª©a "[Running]" V√Ä "Type: wireguard"
    SVC_LIST=$(docker exec "$node" myst cli service list 2>&1)
    
    if echo "$SVC_LIST" | grep -q "Type: wireguard"; then
        if echo "$SVC_LIST" | grep "Type: wireguard" | grep -q "Running"; then
            WG_TXT="${GREEN}Running üöÄ${NC}"
        else
            WG_TXT="${YELLOW}Stopped ‚ö†Ô∏è${NC}"
        fi
    else
        WG_TXT="${RED}Missing ‚ùå${NC}"
    fi

    # 5. CHECK V√ç (L·ªánh: identities beneficiary-status) - PH·∫¶N QUAN TR·ªåNG NH·∫§T
    BEN_LOG=$(docker exec "$node" myst cli identities beneficiary-status "$ID" 2>&1)
    
    # Log m·∫´u: [INFO] Current beneficiary: 0x22c... (C·ªôt 4)
    CURRENT_WALLET=$(echo "$BEN_LOG" | grep "Current beneficiary" | awk '{print $4}')

    # So s√°nh v·ªõi v√≠ chu·∫©n
    if [ "$CURRENT_WALLET" == "$TARGET_WALLET" ]; then
        # N·∫øu tr√πng kh·ªõp: In m√†u xanh + tick
        WALLET_DISPLAY="${GREEN}${CURRENT_WALLET} ‚úÖ${NC}"
    else
        # N·∫øu kh√°c ho·∫∑c r·ªóng
        if [ -z "$CURRENT_WALLET" ] || [ "$CURRENT_WALLET" == "None" ] || [ "$CURRENT_WALLET" == "not_found" ]; then
             WALLET_DISPLAY="${RED}CH∆ØA C√ÄI V√ç ‚ùå${NC}"
        else
             WALLET_DISPLAY="${RED}${CURRENT_WALLET} (SAI) ‚ö†Ô∏è${NC}"
        fi
    fi

    # 6. HI·ªÇN TH·ªä K·∫æT QU·∫¢
    if [ -z "$BALANCE" ]; then BALANCE="0"; fi
    if [ -z "$TOTAL_EARN" ]; then TOTAL_EARN="0"; fi

    FINANCE_TXT="${BLUE}$BALANCE${NC} / ${YELLOW}$TOTAL_EARN${NC}"

    printf "%-8s | %b | %b | %b | %b\n" "$node" "$STATUS_TXT" "$WG_TXT" "$WALLET_DISPLAY" "$FINANCE_TXT"

done

echo "------------------------------------------------------------------------------------------------------------------------"
