#!/bin/bash

# =================================================================
# C·∫§U H√åNH V√ç CHU·∫®N ƒê·ªÇ SO S√ÅNH
# =================================================================
TARGET_WALLET="0x22cBdE4c61BA69374169eB9B1a49d62Db3beCC7f"
# =================================================================

# M√†u s·∫Øc
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

echo "=========================================================================================================="
echo "   MYSTERIUM ULTIMATE CHECK (STATUS - WIREGUARD - WALLET - BALANCE)"
echo "   V√≠ chu·∫©n: $TARGET_WALLET"
echo "=========================================================================================================="

NODES=$(docker ps --format "{{.Names}}" | grep "myst")

if [ -z "$NODES" ]; then echo "‚ùå Kh√¥ng t√¨m th·∫•y node."; exit 1; fi

# Header b·∫£ng (Canh l·ªÅ cho ƒë·∫πp)
printf "%-8s | %-15s | %-15s | %-15s | %-30s\n" "NODE" "TR·∫†NG TH√ÅI" "WIREGUARD" "CHECK V√ç" "T√ÄI CH√çNH (Balance/Total)"
echo "----------------------------------------------------------------------------------------------------------"

for node in $NODES; do
    # 1. L·∫§Y IDENTITY
    RAW_LIST=$(docker exec "$node" myst cli identities list 2>/dev/null)
    ID=$(echo "$RAW_LIST" | grep -oE '0x[a-fA-F0-9]{40}' | head -n 1)

    if [ -z "$ID" ]; then
        printf "%-8s | %b | %s | %s | %s\n" "$node" "${RED}No ID ‚ùå${NC}" "-" "-" "C·∫ßn t·∫°o ID m·ªõi"
        continue
    fi

    # 2. L·∫§Y TH√îNG TIN C∆† B·∫¢N (Status, Balance, Earnings)
    INFO=$(docker exec "$node" myst cli identities get "$ID" 2>&1)
    STATUS_RAW=$(echo "$INFO" | grep "Registration Status" | awk '{print $3}')
    BALANCE=$(echo "$INFO" | grep "Balance" | awk '{print $2}')
    TOTAL_EARN=$(echo "$INFO" | grep "Earnings total" | awk '{print $3}')

    # M√†u tr·∫°ng th√°i
    if [[ "$STATUS_RAW" == "Registered" ]]; then
        STATUS_TXT="${GREEN}Registered ‚úÖ${NC}"
    elif [[ "$STATUS_RAW" == "InProgress" ]]; then
        STATUS_TXT="${YELLOW}ƒêang ƒêK... ‚è≥${NC}"
    else
        STATUS_TXT="${RED}Ch∆∞a ƒêK ‚ùå${NC}"
    fi

    # 3. KI·ªÇM TRA WIREGUARD (Service List)
    SVC_LIST=$(docker exec "$node" myst cli service list 2>&1)
    if echo "$SVC_LIST" | grep -q "Type: wireguard"; then
        WG_TXT="${GREEN}ƒêang B·∫≠t üöÄ${NC}"
    else
        WG_TXT="${RED}ƒêang T·∫Øt üõë${NC}"
    fi

    # 4. KI·ªÇM TRA V√ç R√öT TI·ªÄN (Beneficiary Status)
    BEN_LOG=$(docker exec "$node" myst cli identities beneficiary-status "$ID" 2>&1)
    CURRENT_WALLET=$(echo "$BEN_LOG" | grep "Current beneficiary" | awk '{print $NF}')

    # So s√°nh v√≠
    if [ "$CURRENT_WALLET" == "$TARGET_WALLET" ]; then
        WALLET_TXT="${GREEN}V√≠ Chu·∫©n ‚úÖ${NC}"
    else
        if [[ "$CURRENT_WALLET" == *"0x"* ]]; then
            WALLET_TXT="${RED}Sai V√≠ ‚ö†Ô∏è${NC}" # C√≥ v√≠ nh∆∞ng kh√°c v√≠ chu·∫©n
        else
            WALLET_TXT="${RED}Ch∆∞a Set ‚ùå${NC}" # Ch∆∞a c√≥ v√≠
        fi
    fi

    # 5. HI·ªÇN TH·ªä D√íNG K·∫æT QU·∫¢
    # Format t√†i ch√≠nh: Balance / Total
    FINANCE_TXT="${BLUE}$BALANCE${NC} / ${YELLOW}$TOTAL_EARN${NC}"

    printf "%-8s | %b | %b | %b | %b\n" "$node" "$STATUS_TXT" "$WG_TXT" "$WALLET_TXT" "$FINANCE_TXT"

done

echo "----------------------------------------------------------------------------------------------------------"
echo "üëâ Gi·∫£i th√≠ch:"
echo "   - TR·∫†NG TH√ÅI: Ph·∫£i l√† Registered ‚úÖ (M√†u xanh)."
echo "   - WIREGUARD: Ph·∫£i l√† ƒêang B·∫≠t üöÄ (M√†u xanh)."
echo "   - CHECK V√ç: Ph·∫£i l√† V√≠ Chu·∫©n ‚úÖ (Kh·ªõp ƒëu√¥i ...CC7f)."
echo "   - T√ÄI CH√çNH: S·ªë d∆∞ hi·ªán t·∫°i / T·ªïng ki·∫øm ƒë∆∞·ª£c."
