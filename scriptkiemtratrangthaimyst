#!/bin/bash

# =================================================================
# C·∫§U H√åNH V√ç CHU·∫®N (ƒê·ªÇ SO S√ÅNH)
# =================================================================
TARGET_WALLET="0x22cBdE4c61BA69374169eB9B1a49d62Db3beCC7f"
# =================================================================

# M√†u s·∫Øc
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

echo "========================================================================================================================================"
echo "   MYSTERIUM AUDIT V10 (AUTO-RESTART IF FAILED)"
echo "   V√≠ chu·∫©n: $TARGET_WALLET"
echo "========================================================================================================================================"

NODES=$(docker ps --format "{{.Names}}" | grep "myst")

if [ -z "$NODES" ]; then echo "‚ùå Kh√¥ng t√¨m th·∫•y node."; exit 1; fi

# Header b·∫£ng
printf "%-8s | %-12s | %-12s | %-12s | %-48s | %-20s\n" "NODE" "TR·∫†NG TH√ÅI" "MONITOR" "WIREGUARD" "ƒê·ªäA CH·ªà V√ç HI·ªÜN T·∫†I" "T√ÄI CH√çNH (Bal/Tot)"
echo "----------------------------------------------------------------------------------------------------------------------------------------"

for node in $NODES; do
    # Bi·∫øn c·ªù ƒë·ªÉ ƒë√°nh d·∫•u c√≥ c·∫ßn restart kh√¥ng (M·∫∑c ƒë·ªãnh l√† Kh√¥ng)
    NEED_RESTART=0

    # 1. L·∫§Y IDENTITY
    RAW_LIST=$(docker exec "$node" myst cli identities list 2>/dev/null)
    ID=$(echo "$RAW_LIST" | grep -oE '0x[a-fA-F0-9]{40}' | head -n 1)

    if [ -z "$ID" ]; then
        printf "%-8s | %b | %-12s | %s | %s | %s\n" "$node" "${RED}No ID ‚ùå${NC}" "-" "-" "-" "C·∫ßn t·∫°o ID m·ªõi"
        continue
    fi

    # 2. UNLOCK
    docker exec "$node" myst cli identities unlock "$ID" >/dev/null 2>&1

    # 3. CHECK MONITORING STATUS (L·ªánh: nat)
    NAT_INFO=$(docker exec "$node" myst cli nat 2>&1)
    MON_STATUS=$(echo "$NAT_INFO" | grep "Node Monitoring Status" | awk -F': ' '{print $2}' | tr -d '"')
    
    if [[ "$MON_STATUS" == "success" ]]; then
        MON_TXT="${GREEN}Success ‚úÖ${NC}"
    else
        MON_TXT="${RED}Failed ‚ùå${NC}"
        NEED_RESTART=1  # <--- ƒê√°nh d·∫•u c·∫ßn Restart
    fi

    # 4. L·∫§Y TH√îNG TIN T√ÄI CH√çNH
    INFO=$(docker exec "$node" myst cli identities get "$ID" 2>&1)
    STATUS_RAW=$(echo "$INFO" | grep "Registration Status" | awk '{print $4}')
    BALANCE=$(echo "$INFO" | grep "Balance:" | awk '{print $3}')
    TOTAL_EARN=$(echo "$INFO" | grep "Earnings total:" | awk '{print $4}')

    if [[ "$STATUS_RAW" == "Registered" ]]; then
        STATUS_TXT="${GREEN}Registered${NC}"
    elif [[ "$STATUS_RAW" == "InProgress" ]]; then
        STATUS_TXT="${YELLOW}Pending...${NC}"
    else
        STATUS_TXT="${RED}Unreg...${NC}"
    fi

    # 5. CHECK WIREGUARD
    SVC_LIST=$(docker exec "$node" myst cli service list 2>&1)
    if echo "$SVC_LIST" | grep "Type: wireguard" | grep -q "Running"; then
        WG_TXT="${GREEN}Running üöÄ${NC}"
    else
        WG_TXT="${RED}Stopped ‚ö†Ô∏è${NC}"
    fi

    # 6. CHECK V√ç
    BEN_LOG=$(docker exec "$node" myst cli identities beneficiary-status "$ID" 2>&1)
    CURRENT_WALLET=$(echo "$BEN_LOG" | grep "Current beneficiary" | awk '{print $4}')

    if [ "$CURRENT_WALLET" == "$TARGET_WALLET" ]; then
        WALLET_DISPLAY="${GREEN}${CURRENT_WALLET} ‚úÖ${NC}"
    else
        if [ -z "$CURRENT_WALLET" ] || [ "$CURRENT_WALLET" == "None" ]; then
             WALLET_DISPLAY="${RED}CH∆ØA C√ÄI V√ç ‚ùå${NC}"
        else
             WALLET_DISPLAY="${RED}${CURRENT_WALLET} (SAI) ‚ö†Ô∏è${NC}"
        fi
    fi

    # 7. HI·ªÇN TH·ªä K·∫æT QU·∫¢
    FINANCE_TXT="${BLUE}${BALANCE:-0}${NC} / ${YELLOW}${TOTAL_EARN:-0}${NC}"

    printf "%-8s | %b | %b | %b | %b | %b\n" "$node" "$STATUS_TXT" "$MON_TXT" "$WG_TXT" "$WALLET_DISPLAY" "$FINANCE_TXT"

    # 8. TH·ª∞C HI·ªÜN AUTO-RESTART (N·∫øu c·ªù NEED_RESTART == 1)
    if [ "$NEED_RESTART" -eq 1 ]; then
        echo -e "         ‚îî‚îÄ‚îÄ ${YELLOW}‚ö†Ô∏è Ph√°t hi·ªán l·ªói Monitoring! ƒêang Restart container ${node}...${NC}"
        docker restart "$node" >/dev/null 2>&1
        echo -e "         ‚îî‚îÄ‚îÄ ${GREEN}‚úÖ ƒê√£ g·ª≠i l·ªánh Restart xong.${NC}"
    fi

done

echo "----------------------------------------------------------------------------------------------------------------------------------------"
