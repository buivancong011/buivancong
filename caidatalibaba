#!/bin/bash
set -e  # D·ª´ng ngay n·∫øu l·ªói

# ==========================================
# 1. C·∫§U H√åNH TOKEN & T√ÄI KHO·∫¢N
# ==========================================
TOKEN_TM="/PfkwR8qQMfbsCMrSaaDhsX96E9w2PeHH2bcGeyFBno="
TOKEN_EARNFM="50f04bbe-94d9-4f6a-82b9-b40016bd4bbb"
# Repocket
RP_EMAIL="nguyenvinhson000@gmail.com"
RP_API="cad6dcce-d038-4727-969b-d996ed80d3ef"
# UrNetwork
UR_USER="buivancong012@gmail.com"
UR_PASS="buivancong012"
# AntGain
ANT_KEY="ud0F9rj2KgAXWgJ20Dw6sogFOjJvytLyVSGtQUrfo4QJq3LAAvdh8XF5jUERcIeU"

# ==========================================
# 2. H√ÄM LOG
# ==========================================
log() { echo -e "\e[32m[INFO] $1\e[0m"; }

# ==========================================
# 3. C√ÄI ƒê·∫∂T DOCKER (ALIBABA/CENTOS)
# ==========================================
log "D·ªçn d·∫πp h·ªá th·ªëng..."
timeout 60 sudo yum remove -y squid httpd-tools >/dev/null 2>&1 || true

if ! command -v docker &> /dev/null; then
  log "ƒêang c√†i ƒë·∫∑t Docker..."
  sudo yum update -y -q
  sudo yum install -y -q docker
  sudo systemctl enable --now docker
  log "Docker ƒë√£ kh·ªüi ƒë·ªông."
fi

# ==========================================
# 4. D·ªåN D·∫∏P CONTAINER C≈®
# ==========================================
log "X√≥a container c≈© (n·∫øu c√≥)..."
# X√≥a c√°c container tr√πng t√™n ƒë·ªÉ tr√°nh l·ªói khi ch·∫°y l·∫°i
docker rm -f tm urnetwork antgain earnfm repocket >/dev/null 2>&1 || true
docker image prune -f >/dev/null 2>&1

# ==========================================
# 5. K√âO IMAGE (SONG SONG CHO NHANH)
# ==========================================
log "ƒêang t·∫£i Images..."
docker pull traffmonetizer/cli_v2:latest >/dev/null 2>&1 &
docker pull techroy23/docker-urnetwork:latest >/dev/null 2>&1 &
docker pull pinors/antgain-cli:latest >/dev/null 2>&1 &
docker pull earnfm/earnfm-client:latest >/dev/null 2>&1 &
docker pull repocket/repocket:latest >/dev/null 2>&1 &

wait # ƒê·ª£i t·∫£i xong h·∫øt m·ªõi ch·∫°y ti·∫øp
log "T·∫£i ·∫£nh ho√†n t·∫•t."

# ==========================================
# 6. CH·∫†Y CONTAINER (KH√îNG DNS)
# ==========================================
log "üöÄ Kh·ªüi ch·∫°y c√°c ·ª©ng d·ª•ng..."

# 1. Traffmonetizer
docker run -d --restart always --name tm traffmonetizer/cli_v2:latest start accept --token "$TOKEN_TM"

# 2. UrNetwork
docker run -d --name urnetwork --restart always --cap-add NET_ADMIN \
  -v ur_data:/var/lib/vnstat \
  -e USER_AUTH="$UR_USER" -e PASSWORD="$UR_PASS" \
  techroy23/docker-urnetwork:latest

# 3. AntGain
docker run -d --name antgain --restart always \
  -e ANTGAIN_API_KEY="$ANT_KEY" \
  pinors/antgain-cli:latest

# 4. EarnFM
docker run -d --name earnfm --restart always \
  -e EARNFM_TOKEN="$TOKEN_EARNFM" \
  earnfm/earnfm-client:latest

# 5. Repocket
docker run -d --name repocket --restart always \
  -e RP_EMAIL="$RP_EMAIL" -e RP_API_KEY="$RP_API" \
  repocket/repocket:latest

# ==========================================
# 7. HO√ÄN T·∫§T
# ==========================================
log "==== C√ÄI ƒê·∫∂T XONG ===="
docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
