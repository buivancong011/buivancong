#!/bin/bash
set -Eeuo pipefail

echo -e "\n=== [1] Danh sÃ¡ch container proxy Ä‘ang cháº¡y ==="
docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}" | grep -E '(^glider|^tun)' || echo "âŒ KhÃ´ng tháº¥y container proxy nÃ o"

ROUTES=$(docker ps --format '{{.Names}}' | grep -E '^glider[0-9]+$' | wc -l)
echo -e "\n=== [2] Sá»‘ tuyáº¿n phÃ¡t hiá»‡n: $ROUTES ===\n"

if [[ "$ROUTES" -eq 0 ]]; then
  echo "âŒ KhÃ´ng cÃ³ tuyáº¿n proxy nÃ o Ä‘ang cháº¡y. HÃ£y cháº¡y: ./proxy.sh up"
  exit 1
fi

for i in $(seq 1 "$ROUTES"); do
  echo "---------------- ROUTE $i ----------------"

  echo -n "[ðŸŒ Egress IP] "
  docker run --rm --network=container:"tun$i" curlimages/curl:latest -4 -s --max-time 6 https://api.ipify.org || echo "n/a"
  echo

  echo "[ðŸ“¡ DNS cáº¥u hÃ¬nh]"
  docker exec "tun$i" sh -c 'cat /etc/resolv.conf 2>/dev/null || echo "KhÃ´ng Ä‘á»c Ä‘Æ°á»£c resolv.conf"'

  echo "[ðŸ“¶ MTU tun0]"
  docker exec "tun$i" sh -c 'ip link show tun0 2>/dev/null | sed -n "1p" || echo "KhÃ´ng cÃ³ tun0"'

  echo "[ðŸ› ï¸ ip rule liÃªn quan DNS bypass]"
  docker exec "tun$i" sh -c "ip rule | grep -E 'dport 53|lookup main' || echo 'âŒ KhÃ´ng tháº¥y rule bypass DNS'"

  echo -n "[ðŸŒ HTTP test] (example/neverssl/httpbingo) â†’ "
  c1=$(docker run --rm --network=container:"tun$i" curlimages/curl:latest -4 -s -o /dev/null -w '%{http_code}' --max-time 6 http://example.com || echo 000)
  c2=$(docker run --rm --network=container:"tun$i" curlimages/curl:latest -4 -s -o /dev/null -w '%{http_code}' --max-time 6 http://neverssl.com || echo 000)
  c3=$(docker run --rm --network=container:"tun$i" curlimages/curl:latest -4 -s -o /dev/null -w '%{http_code}' --max-time 6 http://httpbingo.org/get || echo 000)
  echo "example:$c1 neverssl:$c2 httpbingo:$c3"

  echo -n "[ðŸ” HTTPS test] https://api.ipify.org â†’ code: "
  docker run --rm --network=container:"tun$i" curlimages/curl:latest -4 -s -o /dev/null -w '%{http_code}' --max-time 6 https://api.ipify.org || echo "n/a"
  echo

  echo "[ðŸ“œ Log glider$i (10 dÃ²ng cuá»‘i)]"
  docker logs --tail 10 "glider$i" 2>&1 || echo "KhÃ´ng láº¥y Ä‘Æ°á»£c log glider$i"
  echo
done

echo -e "\nâœ… Kiá»ƒm tra hoÃ n táº¥t. Náº¿u cÃ³ IP, code 200 (Ã­t nháº¥t 1 HTTP test) vÃ  rule DNS â†’ proxy á»•n Ä‘á»‹nh.\n"
