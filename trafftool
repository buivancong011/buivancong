#!/usr/bin/env bash
set -Eeuo pipefail

# ============== CONFIG ==============
IMAGE_TM="traffmonetizer/cli_v2:latest"
# Gáº¯n cá»‘ Ä‘á»‹nh token báº¡n Ä‘Æ°a:
TOKEN="JoaF9KjqyUjmIUCOMxx6W/6rKD0Q0XTHQ5zlqCEJlXM="
CONCURRENCY="${CONCURRENCY:-8}"   # sá»‘ job song song khi up/down
MAX_TUNS="${MAX_TUNS:-0}"         # 0 = khÃ´ng giá»›i háº¡n, >0 = chá»‰ láº¥y tá»‘i Ä‘a N tun Ä‘áº§u

# ============== HELPERS ==============
die() { echo "ERROR: $*" >&2; exit 1; }
need() { command -v "$1" >/dev/null 2>&1 || die "Thiáº¿u lá»‡nh: $1"; }

pull_image() {
  echo "[INFO] KÃ©o image $IMAGE_TM (náº¿u chÆ°a cÃ³)..."
  docker pull "$IMAGE_TM" >/dev/null || true
}

# Liá»‡t kÃª tunN Ä‘ang CHáº Y, sort theo N
list_up_tuns_sorted() {
  docker ps --format '{{.Names}}' \
  | grep -E '^tun[0-9]+$' \
  | sed -E 's/^tun([0-9]+)$/\1\t&/' \
  | sort -n -k1,1 \
  | cut -f2
}

# Táº¡o cáº·p tmN:tunN:device_tmN tá»« danh sÃ¡ch tunN
build_pairs_from_tuns() {
  local count=0
  local pairs=()
  while read -r tun; do
    [[ -n "$tun" ]] || continue
    local n; n=$(sed -E 's/^tun([0-9]+)$/\1/' <<<"$tun")
    [[ "$n" =~ ^[0-9]+$ ]] || continue
    pairs+=("tm${n}:${tun}:device_tm${n}")
    ((count++))
    if (( MAX_TUNS > 0 && count >= MAX_TUNS )); then
      break
    fi
  done < <(list_up_tuns_sorted)

  if (( ${#pairs[@]} == 0 )); then
    die "KhÃ´ng phÃ¡t hiá»‡n máº¡ng/container tunN nÃ o Ä‘ang cháº¡y. HÃ£y bring-up cÃ¡c tun trÆ°á»›c."
  fi

  CONTAINERS_EFFECTIVE=("${pairs[@]}")
  echo "[INFO] PhÃ¡t hiá»‡n ${#CONTAINERS_EFFECTIVE[@]} tun Ä‘ang cháº¡y â†’ sáº½ triá»ƒn khai báº¥y nhiÃªu tm."
}

have_container() { docker ps -a --format '{{.Names}}' | grep -Fxq "$1"; }
is_running()    { docker ps     --format '{{.Names}}' | grep -Fxq "$1"; }
have_ns()       { docker ps     --format '{{.Names}}' | grep -Fxq "$1"; }

run_one() {
  local pair="$1"
  local name="${pair%%:*}"                 # tmN
  local rest="${pair#*:}"                  # tunN:device_tmN
  local tun="${rest%%:*}"                  # tunN
  local dev="${rest#*:}"                   # device_tmN

  docker rm -f "$name" >/dev/null 2>&1 || true

  if ! have_ns "$tun"; then
    echo "âš ï¸  Bá» qua $name: '$tun' khÃ´ng cÃ²n cháº¡y."
    return 0
  fi

  docker run -d --restart=always \
    --network="container:$tun" \
    --name "$name" \
    "$IMAGE_TM" start accept \
      --device-name "$dev" \
      --token "$TOKEN" >/dev/null

  echo "âœ… RUN $name qua $tun (device=$dev)"
}

down_one() {
  local name="$1"
  if have_container "$name"; then
    docker rm -f "$name" >/dev/null && echo "ðŸ§¹ RM  $name"
  fi
}

status_one() {
  local pair="$1"
  local name="${pair%%:*}"
  if is_running "$name"; then
    local st; st=$(docker ps --filter "name=^${name}$" --format '{{.Status}}')
    echo "ðŸŸ¢ $name ($st)"
  elif have_container "$name"; then
    local st; st=$(docker ps -a --filter "name=^${name}$" --format '{{.Status}}')
    echo "ðŸŸ¡ $name (stopped: $st)"
  else
    echo "âšª $name (absent)"
  fi
}

test_one() {
  local pair="$1"
  local tun="${pair#*:}"; tun="${tun%%:*}"
  if have_ns "$tun"; then
    local ip
    ip=$(docker run --rm --network=container:"$tun" curlimages/curl:latest -4 -s --max-time 6 https://api.ipify.org || true)
    [[ -n "$ip" ]] && echo "ðŸŒ $tun -> $ip" || echo "âŒ $tun -> n/a"
  else
    echo "âš ï¸  $tun chÆ°a cháº¡y"
  fi
}

logs_one() {
  local pair="$1"
  local name="${pair%%:*}"
  if have_container "$name"; then
    echo "---------- logs: $name ----------"
    docker logs --tail=50 "$name" || true
  else
    echo "âšª $name (absent)"
  fi
}

# map with concurrency
par_map() {
  local fn="$1"; shift
  local -a items=("$@")
  (( ${#items[@]} > 0 )) || { echo "âš ï¸  KhÃ´ng cÃ³ tuyáº¿n nÃ o Ä‘á»ƒ xá»­ lÃ½."; return 0; }
  printf '%s\n' "${items[@]}" | xargs -I{} -P "${CONCURRENCY}" bash -c "$fn \"{}\""
}

# ============== COMMANDS ==============
cmd_up() {
  need docker
  [[ -n "$TOKEN" ]] || die "TOKEN trá»‘ng."
  pull_image
  build_pairs_from_tuns
  par_map 'run_one' "${CONTAINERS_EFFECTIVE[@]}"
}

# Gá»¡ táº¥t cáº£ tm[0-9]+
cmd_down() {
  local names
  names=$(docker ps -a --format '{{.Names}}' | grep -E '^tm[0-9]+$' || true)
  if [[ -z "$names" ]]; then
    echo "â„¹ï¸  KhÃ´ng cÃ³ container tmN nÃ o."
    return 0
  fi
  printf '%s\n' "$names" | xargs -r -n1 -P "${CONCURRENCY}" bash -c 'docker rm -f "$0" >/dev/null && echo "ðŸ§¹ RM  $0"'
}

cmd_status() { build_pairs_from_tuns; par_map 'status_one' "${CONTAINERS_EFFECTIVE[@]}"; }
cmd_test()   { build_pairs_from_tuns; par_map 'test_one'   "${CONTAINERS_EFFECTIVE[@]}"; }
cmd_logs()   { build_pairs_from_tuns; par_map 'logs_one'   "${CONTAINERS_EFFECTIVE[@]}"; }
cmd_restart(){ cmd_down; sleep 1; cmd_up; }

usage() {
  cat <<EOF
Usage: $0 {up|down|restart|status|test|logs}

ENV (tÃ¹y chá»n):
  CONCURRENCY=8        Sá»‘ job cháº¡y song song khi up/down
  MAX_TUNS=0           0 = dÃ¹ng háº¿t tun Ä‘ang cháº¡y; >0 = chá»‰ láº¥y tá»‘i Ä‘a N tun Ä‘áº§u
EOF
}

main() {
  local cmd="${1:-}"
  case "$cmd" in
    up)       cmd_up ;;
    down)     cmd_down ;;
    restart)  cmd_restart ;;
    status)   cmd_status ;;
    test)     cmd_test ;;
    logs)     cmd_logs ;;
    *)        usage; exit 1 ;;
  esac
}
main "$@"
