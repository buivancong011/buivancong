#!/bin/bash
set -Eeuo pipefail

# ===================== CONFIG =====================
# Danh sách SOCKS5: "ip:port:user:pass" (đã chuyển sang port 1339)
PROXIES=(
"156.239.204.25:1339:cao_nAEfN2:g2Bawi4kkDZyztX"
"156.239.201.49:1339:cao_nAEfN2:g2Bawi4kkDZyztX"
"156.239.202.151:1339:cao_nAEfN2:g2Bawi4kkDZyztX"
"156.239.201.0:1339:cao_nAEfN2:g2Bawi4kkDZyztX"
"156.239.196.11:1339:cao_nAEfN2:g2Bawi4kkDZyztX"
"156.239.203.251:1339:cao_nAEfN2:g2Bawi4kkDZyztX"
"156.239.205.107:1339:cao_nAEfN2:g2Bawi4kkDZyztX"
"156.239.198.52:1339:cao_nAEfN2:g2Bawi4kkDZyztX"
"156.239.195.73:1339:cao_nAEfN2:g2Bawi4kkDZyztX"
"156.239.197.103:1339:cao_nAEfN2:g2Bawi4kkDZyztX"
"156.239.199.213:1339:cao_nAEfN2:g2Bawi4kkDZyztX"
"156.239.199.167:1339:cao_nAEfN2:g2Bawi4kkDZyztX"
"156.239.204.52:1339:cao_nAEfN2:g2Bawi4kkDZyztX"
"156.239.202.70:1339:cao_nAEfN2:g2Bawi4kkDZyztX"
"156.239.205.75:1339:cao_nAEfN2:g2Bawi4kkDZyztX"
"156.239.204.206:1339:cao_nAEfN2:g2Bawi4kkDZyztX"
"156.239.200.103:1339:cao_nAEfN2:g2Bawi4kkDZyztX"
"156.239.193.62:1339:cao_nAEfN2:g2Bawi4kkDZyztX"
"156.239.197.99:1339:cao_nAEfN2:g2Bawi4kkDZyztX"
"156.239.198.0:1339:cao_nAEfN2:g2Bawi4kkDZyztX"
"156.239.203.195:1339:cao_nAEfN2:g2Bawi4kkDZyztX"
"156.239.197.224:1339:cao_nAEfN2:g2Bawi4kkDZyztX"
"156.239.199.24:1339:cao_nAEfN2:g2Bawi4kkDZyztX"
"156.239.193.140:1339:cao_nAEfN2:g2Bawi4kkDZyztX"
"156.239.194.142:1339:cao_nAEfN2:g2Bawi4kkDZyztX"
"156.239.207.106:1339:cao_nAEfN2:g2Bawi4kkDZyztX"
"156.239.207.0:1339:cao_nAEfN2:g2Bawi4kkDZyztX"
"156.239.203.225:1339:cao_nAEfN2:g2Bawi4kkDZyztX"
"156.239.205.187:1339:cao_nAEfN2:g2Bawi4kkDZyztX"
"156.239.200.202:1339:cao_nAEfN2:g2Bawi4kkDZyztX"
"156.239.194.91:1339:cao_nAEfN2:g2Bawi4kkDZyztX"
"156.239.203.182:1339:cao_nAEfN2:g2Bawi4kkDZyztX"
"156.239.192.94:1339:cao_nAEfN2:g2Bawi4kkDZyztX"
"156.239.198.202:1339:cao_nAEfN2:g2Bawi4kkDZyztX"
"156.239.200.17:1339:cao_nAEfN2:g2Bawi4kkDZyztX"
"156.239.205.239:1339:cao_nAEfN2:g2Bawi4kkDZyztX"
"156.239.194.215:1339:cao_nAEfN2:g2Bawi4kkDZyztX"
"156.239.200.138:1339:cao_nAEfN2:g2Bawi4kkDZyztX"
"156.239.195.69:1339:cao_nAEfN2:g2Bawi4kkDZyztX"
"156.239.192.177:1339:cao_nAEfN2:g2Bawi4kkDZyztX"
"156.239.201.64:1339:cao_nAEfN2:g2Bawi4kkDZyztX"
"156.239.205.121:1339:cao_nAEfN2:g2Bawi4kkDZyztX"
"156.239.201.114:1339:cao_nAEfN2:g2Bawi4kkDZyztX"
"156.239.192.11:1339:cao_nAEfN2:g2Bawi4kkDZyztX"
"156.239.206.200:1339:cao_nAEfN2:g2Bawi4kkDZyztX"
"156.239.199.234:1339:cao_nAEfN2:g2Bawi4kkDZyztX"
"156.239.195.189:1339:cao_nAEfN2:g2Bawi4kkDZyztX"
"156.239.207.222:1339:cao_nAEfN2:g2Bawi4kkDZyztX"
"156.239.199.103:1339:cao_nAEfN2:g2Bawi4kkDZyztX"
"156.239.197.3:1339:cao_nAEfN2:g2Bawi4kkDZyztX"
"156.239.223.107:1339:cao_nAEfN2:g2Bawi4kkDZyztX"
"156.239.213.44:1339:cao_nAEfN2:g2Bawi4kkDZyztX"
"156.239.221.33:1339:cao_nAEfN2:g2Bawi4kkDZyztX"
"156.239.220.58:1339:cao_nAEfN2:g2Bawi4kkDZyztX"
"156.239.218.103:1339:cao_nAEfN2:g2Bawi4kkDZyztX"
"156.239.212.135:1339:cao_nAEfN2:g2Bawi4kkDZyztX"
"156.239.211.246:1339:cao_nAEfN2:g2Bawi4kkDZyztX"
"156.239.217.126:1339:cao_nAEfN2:g2Bawi4kkDZyztX"
"156.239.212.18:1339:cao_nAEfN2:g2Bawi4kkDZyztX"
"156.239.219.82:1339:cao_nAEfN2:g2Bawi4kkDZyztX"
"156.239.219.113:1339:cao_nAEfN2:g2Bawi4kkDZyztX"
"156.239.215.30:1339:cao_nAEfN2:g2Bawi4kkDZyztX"
"156.239.209.42:1339:cao_nAEfN2:g2Bawi4kkDZyztX"
"156.239.216.53:1339:cao_nAEfN2:g2Bawi4kkDZyztX"
"156.239.212.140:1339:cao_nAEfN2:g2Bawi4kkDZyztX"
"156.239.215.254:1339:cao_nAEfN2:g2Bawi4kkDZyztX"
"156.239.221.183:1339:cao_nAEfN2:g2Bawi4kkDZyztX"
"156.239.211.102:1339:cao_nAEfN2:g2Bawi4kkDZyztX"
"156.239.217.246:1339:cao_nAEfN2:g2Bawi4kkDZyztX"
"156.239.213.129:1339:cao_nAEfN2:g2Bawi4kkDZyztX"
"156.239.222.188:1339:cao_nAEfN2:g2Bawi4kkDZyztX"
"156.239.216.106:1339:cao_nAEfN2:g2Bawi4kkDZyztX"
"156.239.210.1:1339:cao_nAEfN2:g2Bawi4kkDZyztX"
"156.239.209.140:1339:cao_nAEfN2:g2Bawi4kkDZyztX"
"156.239.218.68:1339:cao_nAEfN2:g2Bawi4kkDZyztX"
"156.239.216.147:1339:cao_nAEfN2:g2Bawi4kkDZyztX"
"156.239.222.133:1339:cao_nAEfN2:g2Bawi4kkDZyztX"
"156.239.213.255:1339:cao_nAEfN2:g2Bawi4kkDZyztX"
"156.239.211.114:1339:cao_nAEfN2:g2Bawi4kkDZyztX"
"156.239.215.101:1339:cao_nAEfN2:g2Bawi4kkDZyztX"
"156.239.223.9:1339:cao_nAEfN2:g2Bawi4kkDZyztX"
"156.239.221.24:1339:cao_nAEfN2:g2Bawi4kkDZyztX"
"156.239.217.162:1339:cao_nAEfN2:g2Bawi4kkDZyztX"
"156.239.220.207:1339:cao_nAEfN2:g2Bawi4kkDZyztX"
"156.239.222.138:1339:cao_nAEfN2:g2Bawi4kkDZyztX"
"156.239.221.166:1339:cao_nAEfN2:g2Bawi4kkDZyztX"
"156.239.219.45:1339:cao_nAEfN2:g2Bawi4kkDZyztX"
"156.239.217.172:1339:cao_nAEfN2:g2Bawi4kkDZyztX"
"156.239.223.220:1339:cao_nAEfN2:g2Bawi4kkDZyztX"
"156.239.215.54:1339:cao_nAEfN2:g2Bawi4kkDZyztX"
"156.239.220.5:1339:cao_nAEfN2:g2Bawi4kkDZyztX"
"156.239.214.6:1339:cao_nAEfN2:g2Bawi4kkDZyztX"
"156.239.221.23:1339:cao_nAEfN2:g2Bawi4kkDZyztX"
"156.239.221.105:1339:cao_nAEfN2:g2Bawi4kkDZyztX"
"156.239.218.63:1339:cao_nAEfN2:g2Bawi4kkDZyztX"
"156.239.222.201:1339:cao_nAEfN2:g2Bawi4kkDZyztX"
"156.239.212.73:1339:cao_nAEfN2:g2Bawi4kkDZyztX"
"156.239.219.187:1339:cao_nAEfN2:g2Bawi4kkDZyztX"
"156.239.214.181:1339:cao_nAEfN2:g2Bawi4kkDZyztX"
"156.239.217.223:1339:cao_nAEfN2:g2Bawi4kkDZyztX"
)

# Image
IMG_SBOX="ghcr.io/sagernet/sing-box:latest"
IMG_DOH="cloudflare/cloudflared:latest"

# Tên container base
SBOX_BASE="sbox"
DOH_BASE="doh"

# Tham số TUN
MTU="1400"                  # giảm fragment/timeouts
ENABLE_BBR=true             # bật BBR nhẹ
ENABLE_TFO=true             # bật TCP Fast Open

# ===================== PRECHECK =====================
command -v docker >/dev/null 2>&1 || { echo "[ERR] Cần Docker."; exit 1; }
if [[ ! -e /dev/net/tun ]]; then
  echo "[INFO] Tạo /dev/net/tun..."
  sudo mkdir -p /dev/net || true
  sudo mknod /dev/net/tun c 10 200 || true
  sudo chmod 666 /dev/net/tun || true
fi

# ===================== FUNCS =====================
mk_sbox_config() {
  # $1: file, $2: ip, $3: port, $4: user, $5: pass
  local cfg="$1" ip="$2" port="$3" user="$4" pass="$5"
  cat > "$cfg" <<JSON
{
  "log": { "level": "warn" },

  "dns": {
    "servers": [
      { "address": "https://1.1.1.1/dns-query", "detour": "proxy" },
      { "address": "https://8.8.8.8/dns-query", "detour": "proxy" }
    ],
    "strategy": "ipv4_only"
  },

  "inbounds": [
    {
      "type": "tun",
      "interface_name": "tun0",
      "inet4_address": "172.19.0.1/30",
      "auto_route": true,
      "strict_route": false,
      "sniff": true,
      "mtu": ${MTU}
    }
  ],

  "outbounds": [
    {
      "tag": "proxy",
      "type": "socks",
      "server": "${ip}",
      "server_port": ${port},
      "version": "5",
      "username": "${user}",
      "password": "${pass}"
    },
    { "tag": "direct", "type": "direct" },
    { "tag": "block",  "type": "block" }
  ],

  "route": {
    "auto_detect_interface": true,
    "final": "proxy"
  }
}
JSON
}

sysctl_optimize() {
  if [[ "${ENABLE_BBR}" == true ]]; then
    sudo sysctl -w net.core.default_qdisc=fq >/dev/null 2>&1 || true
    sudo sysctl -w net.ipv4.tcp_congestion_control=bbr >/dev/null 2>&1 || true
  fi
  if [[ "${ENABLE_TFO}" == true ]]; then
    sudo sysctl -w net.ipv4.tcp_fastopen=3 >/dev/null 2>&1 || true
  fi
}

cleanup_one() {
  local idx="$1"
  local s="${SBOX_BASE}${idx}"
  local d="${DOH_BASE}${idx}"
  docker rm -f "$d" "$s" >/dev/null 2>&1 || true
  rm -f "sbox_${idx}.json" || true
}

start_one() {
  local idx="$1"
  IFS=':' read -r ip port user pass <<<"$2"
  local s="${SBOX_BASE}${idx}"
  local d="${DOH_BASE}${idx}"
  local cfg="sbox_${idx}.json"

  echo "------------------------------------------------------------"
  echo "[ROUTE $idx] SOCKS5: ${user}:${pass}@${ip}:${port}"

  cleanup_one "$idx"
  mk_sbox_config "$cfg" "$ip" "$port" "$user" "$pass"

  # sing-box (namespace riêng)
  docker run -d --name "$s" --restart=always \
    --cap-add=NET_ADMIN --device /dev/net/tun \
    -v "$PWD/$cfg":/etc/sing-box/config.json:ro \
    "$IMG_SBOX" run -c /etc/sing-box/config.json >/dev/null

  # DoH (cloudflared) cùng namespace
  docker run -d --name "$d" --restart=always \
    --network=container:"$s" \
    --user root \
    "$IMG_DOH" proxy-dns --address 127.0.0.1 --port 53 >/dev/null

  # Kiểm tra nhanh độ trễ
  printf "[ROUTE %d] latency: " "$idx"
  docker run --rm --network=container:"$s" curlimages/curl:latest \
    -s -o /dev/null -w 'connect=%{time_connect}s ttfb=%{time_starttransfer}s total=%{time_total}s\n' \
    https://www.cloudflare.com/cdn-cgi/trace || echo "FAIL"

  echo "[ROUTE $idx] RUNNING: $s + $d"
  echo "→ Gắn app vào route này:  docker run ... --network=container:${s} <image> ..."
}

status_all() {
  local i=1
  for _ in "${PROXIES[@]}"; do
    local s="${SBOX_BASE}${i}"
    if docker ps --format '{{.Names}}' | grep -qx "$s"; then
      printf "[route%02d] " "$i"
      docker run --rm --network=container:"$s" curlimages/curl:latest \
        -s -o /dev/null -w 'connect=%{time_connect}s ttfb=%{time_starttransfer}s total=%{time_total}s\n' \
        https://www.cloudflare.com/cdn-cgi/trace || echo "FAIL"
    else
      echo "[route$(printf %02d "$i")] stopped"
    fi
    ((i++))
  done
}

down_all() {
  echo "[CLEANUP] stopping all routes..."
  local i=1
  for _ in "${PROXIES[@]}"; do
    cleanup_one "$i"
    ((i++))
  done
  echo "[DONE]"
}

pull_images() {
  docker pull "$IMG_SBOX" >/dev/null
  docker pull "$IMG_DOH"  >/dev/null
}

# ===================== CLI =====================
case "${1:-up}" in
  up)
    sysctl_optimize
    pull_images
    i=1
    for spec in "${PROXIES[@]}"; do
      start_one "$i" "$spec"
      ((i++))
    done
    echo
    echo "✅ ĐÃ KHỞI TẠO ${#PROXIES[@]} ROUTES (mỗi route: sing-box + DoH)."
    echo "ℹ️  Host không đổi route; chỉ container nào gắn --network=container:sboxN mới đi qua proxy tương ứng."
    ;;
  status)
    status_all
    ;;
  down)
    down_all
    ;;
  *)
    echo "Usage: $0 [up|status|down]"
    exit 1
    ;;
esac
