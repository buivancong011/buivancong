#!/bin/bash
set -Eeuo pipefail

# ===================== CONFIG =====================
# Khai bÃ¡o upstream proxy dáº¡ng URI. CÃ³ thá»ƒ trá»™n nhiá»u loáº¡i:
# - HTTP(S):  http://user:pass@host:port
# - SOCKS5:   socks5://user:pass@host:port
# - Shadowsocks: ss://method:password@host:port
# - VMess/Trojan/VLESS/...: Ä‘á»ƒ glider -forward tÆ°Æ¡ng á»©ng (xem docs glider)
UPSTREAMS=(
"http://cao_nAEfN2:g2Bawi4kkDZyztX@156.239.204.25:1338"
"http://cao_nAEfN2:g2Bawi4kkDZyztX@156.239.201.49:1338"
"http://cao_nAEfN2:g2Bawi4kkDZyztX@156.239.202.151:1338"
"http://cao_nAEfN2:g2Bawi4kkDZyztX@156.239.201.0:1338"
"http://cao_nAEfN2:g2Bawi4kkDZyztX@156.239.196.11:1338"
"http://cao_nAEfN2:g2Bawi4kkDZyztX@156.239.203.251:1338"
"http://cao_nAEfN2:g2Bawi4kkDZyztX@156.239.205.107:1338"
"http://cao_nAEfN2:g2Bawi4kkDZyztX@156.239.198.52:1338"
"http://cao_nAEfN2:g2Bawi4kkDZyztX@156.239.195.73:1338"
"http://cao_nAEfN2:g2Bawi4kkDZyztX@156.239.197.103:1338"
"http://cao_nAEfN2:g2Bawi4kkDZyztX@156.239.199.213:1338"
"http://cao_nAEfN2:g2Bawi4kkDZyztX@156.239.199.167:1338"
"http://cao_nAEfN2:g2Bawi4kkDZyztX@156.239.204.52:1338"
"http://cao_nAEfN2:g2Bawi4kkDZyztX@156.239.202.70:1338"
"http://cao_nAEfN2:g2Bawi4kkDZyztX@156.239.205.75:1338"
"http://cao_nAEfN2:g2Bawi4kkDZyztX@156.239.204.206:1338"
"http://cao_nAEfN2:g2Bawi4kkDZyztX@156.239.200.103:1338"
"http://cao_nAEfN2:g2Bawi4kkDZyztX@156.239.193.62:1338"
"http://cao_nAEfN2:g2Bawi4kkDZyztX@156.239.197.99:1338"
"http://cao_nAEfN2:g2Bawi4kkDZyztX@156.239.198.0:1338"
"http://cao_nAEfN2:g2Bawi4kkDZyztX@156.239.203.195:1338"
"http://cao_nAEfN2:g2Bawi4kkDZyztX@156.239.197.224:1338"
"http://cao_nAEfN2:g2Bawi4kkDZyztX@156.239.199.24:1338"
"http://cao_nAEfN2:g2Bawi4kkDZyztX@156.239.193.140:1338"
"http://cao_nAEfN2:g2Bawi4kkDZyztX@156.239.194.142:1338"
"http://cao_nAEfN2:g2Bawi4kkDZyztX@156.239.207.106:1338"
"http://cao_nAEfN2:g2Bawi4kkDZyztX@156.239.207.0:1338"
"http://cao_nAEfN2:g2Bawi4kkDZyztX@156.239.203.225:1338"
"http://cao_nAEfN2:g2Bawi4kkDZyztX@156.239.205.187:1338"
"http://cao_nAEfN2:g2Bawi4kkDZyztX@156.239.200.202:1338"
"http://cao_nAEfN2:g2Bawi4kkDZyztX@156.239.194.91:1338"
"http://cao_nAEfN2:g2Bawi4kkDZyztX@156.239.203.182:1338"
"http://cao_nAEfN2:g2Bawi4kkDZyztX@156.239.192.94:1338"
"http://cao_nAEfN2:g2Bawi4kkDZyztX@156.239.198.202:1338"
"http://cao_nAEfN2:g2Bawi4kkDZyztX@156.239.200.17:1338"
"http://cao_nAEfN2:g2Bawi4kkDZyztX@156.239.205.239:1338"
"http://cao_nAEfN2:g2Bawi4kkDZyztX@156.239.194.215:1338"
"http://cao_nAEfN2:g2Bawi4kkDZyztX@156.239.200.138:1338"
"http://cao_nAEfN2:g2Bawi4kkDZyztX@156.239.195.69:1338"
"http://cao_nAEfN2:g2Bawi4kkDZyztX@156.239.192.177:1338"
"http://cao_nAEfN2:g2Bawi4kkDZyztX@156.239.201.64:1338"
"http://cao_nAEfN2:g2Bawi4kkDZyztX@156.239.205.121:1338"
"http://cao_nAEfN2:g2Bawi4kkDZyztX@156.239.201.114:1338"
"http://cao_nAEfN2:g2Bawi4kkDZyztX@156.239.192.11:1338"
"http://cao_nAEfN2:g2Bawi4kkDZyztX@156.239.206.200:1338"
"http://cao_nAEfN2:g2Bawi4kkDZyztX@156.239.199.234:1338"
"http://cao_nAEfN2:g2Bawi4kkDZyztX@156.239.195.189:1338"
"http://cao_nAEfN2:g2Bawi4kkDZyztX@156.239.207.222:1338"
"http://cao_nAEfN2:g2Bawi4kkDZyztX@156.239.199.103:1338"
"http://cao_nAEfN2:g2Bawi4kkDZyztX@156.239.197.3:1338"
"http://cao_nAEfN2:g2Bawi4kkDZyztX@156.239.223.107:1338"
"http://cao_nAEfN2:g2Bawi4kkDZyztX@156.239.213.44:1338"
"http://cao_nAEfN2:g2Bawi4kkDZyztX@156.239.221.33:1338"
"http://cao_nAEfN2:g2Bawi4kkDZyztX@156.239.220.58:1338"
"http://cao_nAEfN2:g2Bawi4kkDZyztX@156.239.218.103:1338"
"http://cao_nAEfN2:g2Bawi4kkDZyztX@156.239.212.135:1338"
"http://cao_nAEfN2:g2Bawi4kkDZyztX@156.239.211.246:1338"
"http://cao_nAEfN2:g2Bawi4kkDZyztX@156.239.217.126:1338"
"http://cao_nAEfN2:g2Bawi4kkDZyztX@156.239.212.18:1338"
"http://cao_nAEfN2:g2Bawi4kkDZyztX@156.239.219.82:1338"
"http://cao_nAEfN2:g2Bawi4kkDZyztX@156.239.219.113:1338"
"http://cao_nAEfN2:g2Bawi4kkDZyztX@156.239.215.30:1338"
"http://cao_nAEfN2:g2Bawi4kkDZyztX@156.239.209.42:1338"
"http://cao_nAEfN2:g2Bawi4kkDZyztX@156.239.216.53:1338"
"http://cao_nAEfN2:g2Bawi4kkDZyztX@156.239.212.140:1338"
"http://cao_nAEfN2:g2Bawi4kkDZyztX@156.239.215.254:1338"
"http://cao_nAEfN2:g2Bawi4kkDZyztX@156.239.221.183:1338"
"http://cao_nAEfN2:g2Bawi4kkDZyztX@156.239.211.102:1338"
"http://cao_nAEfN2:g2Bawi4kkDZyztX@156.239.217.246:1338"
"http://cao_nAEfN2:g2Bawi4kkDZyztX@156.239.213.129:1338"
"http://cao_nAEfN2:g2Bawi4kkDZyztX@156.239.222.188:1338"
"http://cao_nAEfN2:g2Bawi4kkDZyztX@156.239.216.106:1338"
"http://cao_nAEfN2:g2Bawi4kkDZyztX@156.239.210.1:1338"
"http://cao_nAEfN2:g2Bawi4kkDZyztX@156.239.209.140:1338"
"http://cao_nAEfN2:g2Bawi4kkDZyztX@156.239.218.68:1338"
"http://cao_nAEfN2:g2Bawi4kkDZyztX@156.239.216.147:1338"
"http://cao_nAEfN2:g2Bawi4kkDZyztX@156.239.222.133:1338"
"http://cao_nAEfN2:g2Bawi4kkDZyztX@156.239.213.255:1338"
"http://cao_nAEfN2:g2Bawi4kkDZyztX@156.239.211.114:1338"
"http://cao_nAEfN2:g2Bawi4kkDZyztX@156.239.215.101:1338"
"http://cao_nAEfN2:g2Bawi4kkDZyztX@156.239.223.9:1338"
"http://cao_nAEfN2:g2Bawi4kkDZyztX@156.239.221.24:1338"
"http://cao_nAEfN2:g2Bawi4kkDZyztX@156.239.217.162:1338"
"http://cao_nAEfN2:g2Bawi4kkDZyztX@156.239.220.207:1338"
"http://cao_nAEfN2:g2Bawi4kkDZyztX@156.239.222.138:1338"
"http://cao_nAEfN2:g2Bawi4kkDZyztX@156.239.221.166:1338"
"http://cao_nAEfN2:g2Bawi4kkDZyztX@156.239.219.45:1338"
"http://cao_nAEfN2:g2Bawi4kkDZyztX@156.239.217.172:1338"
"http://cao_nAEfN2:g2Bawi4kkDZyztX@156.239.223.220:1338"
"http://cao_nAEfN2:g2Bawi4kkDZyztX@156.239.215.54:1338"
"http://cao_nAEfN2:g2Bawi4kkDZyztX@156.239.220.5:1338"
"http://cao_nAEfN2:g2Bawi4kkDZyztX@156.239.214.6:1338"
"http://cao_nAEfN2:g2Bawi4kkDZyztX@156.239.221.23:1338"
"http://cao_nAEfN2:g2Bawi4kkDZyztX@156.239.221.105:1338"
"http://cao_nAEfN2:g2Bawi4kkDZyztX@156.239.218.63:1338"
"http://cao_nAEfN2:g2Bawi4kkDZyztX@156.239.222.201:1338"
"http://cao_nAEfN2:g2Bawi4kkDZyztX@156.239.212.73:1338"
"http://cao_nAEfN2:g2Bawi4kkDZyztX@156.239.219.187:1338"
"http://cao_nAEfN2:g2Bawi4kkDZyztX@156.239.214.181:1338"
"http://cao_nAEfN2:g2Bawi4kkDZyztX@156.239.217.223:1338"
)





# Cá»•ng SOCKS5 láº¯ng nghe trÃªn host cho tá»«ng tuyáº¿n (tuyáº¿n i dÃ¹ng START_SOCKS+i)
START_SOCKS=1080

# TÃªn base cho container theo tuyáº¿n
GLIDER_NAME_BASE="glider"
TUN_NAME_BASE="tun"
DOH_NAME_BASE="doh"

# PhiÃªn báº£n image
IMG_GLIDER="nadoo/glider:latest"
IMG_TUN="xjasonlyu/tun2socks:v2.6.0"
IMG_DOH="cloudflare/cloudflared:latest"

# Log level cho tun2socks
TUN_LOGLEVEL="info"   # debug|info|warn|error

# MTU tuá»³ tuyáº¿n (Ä‘á»ƒ trá»‘ng Ä‘á»ƒ máº·c Ä‘á»‹nh). VÃ­ dá»¥ 1400 náº¿u gáº·p timeouts:
TUN_MTU=""            # vÃ­ dá»¥: "1400"

# ===================== PRECHECK =====================
command -v docker >/dev/null 2>&1 || { echo "[ERR] Cáº§n Docker."; exit 1; }

# Linux cáº§n /dev/net/tun
if [[ ! -e /dev/net/tun ]]; then
  echo "[INFO] Táº¡o /dev/net/tun..."
  sudo mkdir -p /dev/net || true
  sudo mknod /dev/net/tun c 10 200 || true
  sudo chmod 600 /dev/net/tun || true
fi

# ===================== FUNCTIONS =====================
cleanup_route() {
  local idx="$1"
  local g="${GLIDER_NAME_BASE}${idx}"
  local t="${TUN_NAME_BASE}${idx}"
  local d="${DOH_NAME_BASE}${idx}"
  docker rm -f "$d" "$t" "$g" >/dev/null 2>&1 || true
}

start_route() {
  local idx="$1"
  local upstream="$2"
  local socks_port=$((START_SOCKS + idx - 1))

  local g="${GLIDER_NAME_BASE}${idx}"
  local t="${TUN_NAME_BASE}${idx}"
  local d="${DOH_NAME_BASE}${idx}"
  local resolv_file="resolv_${idx}.conf"

  echo "------------------------------------------------------------"
  echo "[ROUTE $idx] Upstream: $upstream"
  echo "[ROUTE $idx] SOCKS5 listen on host: ${socks_port}"

  # 1) Cleanup cÅ©
  cleanup_route "$idx"

  # 2) Táº¡o glider: chuyá»ƒn má»i upstream -> SOCKS5 cá»¥c bá»™
  echo "[ROUTE $idx] Khá»Ÿi cháº¡y glider -> socks5://0.0.0.0:${socks_port}"
  docker run -d --name "$g" --restart=always --network host "$IMG_GLIDER" \
    -verbose \
    -listen "socks5://0.0.0.0:${socks_port}" \
    -forward "$upstream"

  # 3) resolv.conf cá»¥c bá»™ (DNS sáº½ há»i 127.0.0.1 trong namespace tun)
  cat > "$resolv_file" <<EOF
options ndots:0
nameserver 127.0.0.1
EOF

  # 4) tun2socks
  #   PROXY trá» tá»›i SOCKS5 trÃªn host qua Ä‘á»‹a chá»‰ bridge 172.17.0.1 (Linux Docker)
  #   Náº¿u há»‡ khÃ¡c, cÃ³ thá»ƒ Ä‘á»•i sang host.docker.internal:PORT (Docker Desktop)
  echo "[ROUTE $idx] Khá»Ÿi cháº¡y tun2socks..."
  docker run -d --name "$t" --restart=always \
    --cap-add=NET_ADMIN \
    -v /dev/net/tun:/dev/net/tun \
    -v "$PWD/$resolv_file":/etc/resolv.conf:ro \
    -e PROXY="socks5://172.17.0.1:${socks_port}" \
    -e LOGLEVEL="$TUN_LOGLEVEL" \
    -e EXTRA_COMMANDS="ip rule add iif lo ipproto udp dport 53 lookup main;" \
    "$IMG_TUN"

  # Tuá»³ chá»n set MTU náº¿u cáº¥u hÃ¬nh
  if [[ -n "${TUN_MTU}" ]]; then
    echo "[ROUTE $idx] Set MTU=${TUN_MTU} (best-effort)"
    docker exec -it "$t" sh -c "ip link set dev tun0 mtu ${TUN_MTU} || true"
  fi

  # 5) Cloudflared DoH trong cÃ¹ng namespace vá»›i tun
  echo "[ROUTE $idx] Khá»Ÿi cháº¡y cloudflared DoH..."
  docker run -d --name "$d" --restart=always \
    --network=container:"$t" \
    --user root \
    "$IMG_DOH" \
    proxy-dns --address 127.0.0.1 --port 53

  # 6) Kiá»ƒm tra IP qua tuyáº¿n
  echo "[ROUTE $idx] Kiá»ƒm tra IP egress..."
  docker run --rm --network=container:"$t" curlimages/curl:latest -s https://ifconfig.me || true
  echo
  echo "[ROUTE $idx] Sáº´N SÃ€NG. Gáº¯n container vÃ o tuyáº¿n nÃ y báº±ng:"
  echo "  docker run ... --network=container:${t} <image> ..."
}

down_all() {
  echo "[CLEANUP] XoÃ¡ toÃ n bá»™ tuyáº¿n..."
  local i=1
  for _ in "${UPSTREAMS[@]}"; do
    cleanup_route "$i"
    rm -f "resolv_${i}.conf" || true
    ((i++))
  done
  echo "[DONE] ÄÃ£ xoÃ¡."
}

status_all() {
  local i=1
  for _ in "${UPSTREAMS[@]}"; do
    local t="${TUN_NAME_BASE}${i}"
    if docker ps --format '{{.Names}}' | grep -qx "$t"; then
      printf "[STATUS] %s " "$t"
      docker run --rm --network=container:"$t" curlimages/curl:latest -s https://ifconfig.me || true
    else
      echo "[STATUS] $t: not running"
    fi
    ((i++))
  done
}

# ===================== CLI =====================
# ./script.sh          -> khá»Ÿi cháº¡y táº¥t cáº£ tuyáº¿n
# ./script.sh status   -> in IP tá»«ng tuyáº¿n
# ./script.sh down     -> xoÃ¡ toÃ n bá»™ tuyáº¿n
case "${1:-up}" in
  up)
    i=1
    for up in "${UPSTREAMS[@]}"; do
      start_route "$i" "$up"
      ((i++))
    done
    echo
    echo "âœ… ÄÃƒ KHá»I Táº O ${#UPSTREAMS[@]} TUYáº¾N."
    echo "ğŸ‘‰ Gáº¯n container client vÃ o tuyáº¿n N:  --network=container:tunN"
    ;;
  status)
    status_all
    ;;
  down)
    down_all
    ;;
  *)
    echo "Usage: $0 [up|status|down]"
    exit 1
    ;;
esac
