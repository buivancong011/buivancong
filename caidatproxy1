#!/bin/bash
set -Eeuo pipefail

# ===================== CONFIG =====================
# Khai báo upstream proxy dạng URI. Có thể trộn nhiều loại:
# - HTTP(S):  http://user:pass@host:port
# - SOCKS5:   socks5://user:pass@host:port
# - Shadowsocks: ss://method:password@host:port
# - VMess/Trojan/VLESS/...: để glider -forward tương ứng (xem docs glider)
UPSTREAMS=(
"http://user20578:1759040270@103.82.26.78:20578"
"http://user31580:1758772633@103.82.27.148:31580"
"http://user11987:1758247210@103.82.25.199:11987"
"http://user32913:1758163631@103.82.25.188:32913"
"http://user40991:1758907029@103.82.25.188:40991"
"http://user12443:1758163631@103.82.25.188:12443"
"http://user56904:1759114887@103.82.26.78:56904"
"http://user34817:1758189503@103.82.25.199:34817"
"http://user48716:1758265267@103.82.26.78:48716"
"http://user34076:1758477705@103.82.25.188:34076"
"http://user22035:1758163646@103.82.25.188:22035"
"http://user26763:1759162506@103.82.26.78:26763"
"http://user25597:1756577156@103.82.25.188:25597"
"http://user59791:1756576991@103.82.25.188:59791"
"http://user22093:1758477780@103.82.25.188:22093"
"http://user27373:1759040239@103.82.26.78:27373"
"http://user20898:1758177017@103.82.25.199:20898"
"http://user29983:1758774794@103.82.27.148:29983"
"http://user18577:1758906774@103.82.25.188:18577"
"http://user28537:1758906039@103.82.25.188:28537"
"http://user11541:1758796286@103.82.25.188:11541"
"http://user28507:1758907014@103.82.25.188:28507"
"http://user55068:1756577081@103.82.25.188:55068"
"http://user19214:1758960938@103.82.27.99:19214"
"http://user12651:1758163616@103.82.26.78:12651"
"http://user14396:1758906804@103.82.25.188:14396"
"http://user18315:1758772738@103.82.27.148:18315"
"http://user28448:1758477720@103.82.25.188:28448"
"http://user13181:1758906789@103.82.25.188:13181"
"http://user21093:1756577156@103.82.25.188:21093"
"http://user22243:1758906804@103.82.25.188:22243"
"http://user27167:1758163616@103.82.26.78:27167"
"http://user36444:1758179749@103.82.25.199:36444"
"http://user20419:1759040270@103.82.26.78:20419"
"http://user47308:1756576976@103.82.25.188:47308"
"http://user32876:1758772588@103.82.27.148:32876"
"http://user11375:1758244343@103.82.27.99:11375"
"http://user11852:1758265267@103.82.25.199:11852"
"http://user15753:1758163616@103.82.26.78:15753"
"http://user25597:1759201213@103.82.27.99:25597"
"http://user26235:1758189488@103.82.25.199:26235"
"http://user43410:1758357055@103.82.26.78:43410"
"http://user15619:1758518106@103.82.26.78:15619"
"http://user21704:1758179733@103.82.27.99:21704"
"http://user49976:1756576976@103.82.25.188:49976"
"http://user19783:1758265252@103.82.25.199:19783"
"http://user59966:1758978003@103.82.26.78:59966"
"http://user19280:1758907059@103.82.25.188:19280"
"http://user27681:1758477705@103.82.25.188:27681"
"http://user19623:1758518106@103.82.26.78:19623"
"http://user18802:1758907044@103.82.25.188:18802"
"http://user40667:1758907990@103.82.25.188:40667"
"http://user55618:1759114872@103.82.26.78:55618"
"http://user23231:1758163586@103.82.26.78:23231"
"http://user20472:1756785620@103.82.25.9:20472"
"http://user20019:1756792808@103.82.25.9:20019"
"http://user20262:1756577036@103.82.25.188:20262"
"http://user33846:1758907029@103.82.25.188:33846"
"http://user17070:1758906804@103.82.25.188:17070"
"http://user16952:1758906759@103.82.25.188:16952"
"http://user59335:1756576946@103.82.25.188:59335"
"http://user12196:1758123046@103.82.27.148:12196"
"http://user12219:1756577096@103.82.25.188:12219"
"http://user50642:1756577006@103.82.25.188:50642"
"http://user10485:1759114812@103.82.27.99:10485"
"http://user17059:1758905979@103.82.25.9:17059"
"http://user13465:1756577111@103.82.25.188:13465"
"http://user35325:1759040255@103.82.26.78:35325"
"http://user53809:1756578161@103.82.27.99:53809"
"http://user28983:1757082934@103.82.25.9:28983"
"http://user17038:1758905994@103.82.25.9:17038"
"http://user13988:1758477675@103.82.25.188:13988"
"http://dangkhoitao:9999999999@103.82.25.188:12696"
"http://user23645:1758177032@103.82.25.199:23645"
"http://user12289:1758861014@103.82.25.188:12289"
"http://user19654:1759040224@103.82.26.78:19654"
"http://user29246:1758177032@103.82.25.199:29246"
"http://user50907:1756577156@103.82.25.188:50907"
"http://user17139:1758177017@103.82.25.199:17139"
"http://user18586:1758905979@103.82.25.9:18586"
"http://user37318:1758265252@103.82.25.199:37318"
"http://user33957:1759040270@103.82.26.78:33957"
"http://user19300:1758907044@103.82.25.188:19300"
"http://user45914:1758348936@103.82.26.78:45914"
"http://user34447:1759010403@103.82.26.78:34447"
"http://user13198:1758906774@103.82.25.188:13198"
"http://user22543:1758477690@103.82.25.188:22543"
"http://user20967:1758880841@103.82.25.188:20967"
"http://user53875:1758955625@103.82.26.78:53875"
"http://user20538:1758177032@103.82.25.199:20538"











)


# Cổng SOCKS5 lắng nghe trên host cho từng tuyến (tuyến i dùng START_SOCKS+i)
START_SOCKS=1080

# Tên base cho container theo tuyến
GLIDER_NAME_BASE="glider"
TUN_NAME_BASE="tun"
DOH_NAME_BASE="doh"

# Phiên bản image
IMG_GLIDER="nadoo/glider:latest"
IMG_TUN="xjasonlyu/tun2socks:v2.6.0"
IMG_DOH="cloudflare/cloudflared:latest"

# Log level cho tun2socks
TUN_LOGLEVEL="info"   # debug|info|warn|error

# MTU tuỳ tuyến (để trống để mặc định). Ví dụ 1400 nếu gặp timeouts:
TUN_MTU=""            # ví dụ: "1400"

# ===================== PRECHECK =====================
command -v docker >/dev/null 2>&1 || { echo "[ERR] Cần Docker."; exit 1; }

# Linux cần /dev/net/tun
if [[ ! -e /dev/net/tun ]]; then
  echo "[INFO] Tạo /dev/net/tun..."
  sudo mkdir -p /dev/net || true
  sudo mknod /dev/net/tun c 10 200 || true
  sudo chmod 600 /dev/net/tun || true
fi

# ===================== FUNCTIONS =====================
cleanup_route() {
  local idx="$1"
  local g="${GLIDER_NAME_BASE}${idx}"
  local t="${TUN_NAME_BASE}${idx}"
  local d="${DOH_NAME_BASE}${idx}"
  docker rm -f "$d" "$t" "$g" >/dev/null 2>&1 || true
}

start_route() {
  local idx="$1"
  local upstream="$2"
  local socks_port=$((START_SOCKS + idx - 1))

  local g="${GLIDER_NAME_BASE}${idx}"
  local t="${TUN_NAME_BASE}${idx}"
  local d="${DOH_NAME_BASE}${idx}"
  local resolv_file="resolv_${idx}.conf"

  echo "------------------------------------------------------------"
  echo "[ROUTE $idx] Upstream: $upstream"
  echo "[ROUTE $idx] SOCKS5 listen on host: ${socks_port}"

  # 1) Cleanup cũ
  cleanup_route "$idx"

  # 2) Tạo glider: chuyển mọi upstream -> SOCKS5 cục bộ
  echo "[ROUTE $idx] Khởi chạy glider -> socks5://0.0.0.0:${socks_port}"
  docker run -d --name "$g" --restart=always --network host "$IMG_GLIDER" \
    -verbose \
    -listen "socks5://0.0.0.0:${socks_port}" \
    -forward "$upstream"

  # 3) resolv.conf cục bộ (DNS sẽ hỏi 127.0.0.1 trong namespace tun)
  cat > "$resolv_file" <<EOF
options ndots:0
nameserver 127.0.0.1
EOF

  # 4) tun2socks
  #   PROXY trỏ tới SOCKS5 trên host qua địa chỉ bridge 172.17.0.1 (Linux Docker)
  #   Nếu hệ khác, có thể đổi sang host.docker.internal:PORT (Docker Desktop)
  echo "[ROUTE $idx] Khởi chạy tun2socks..."
  docker run -d --name "$t" --restart=always \
    --cap-add=NET_ADMIN \
    -v /dev/net/tun:/dev/net/tun \
    -v "$PWD/$resolv_file":/etc/resolv.conf:ro \
    -e PROXY="socks5://172.17.0.1:${socks_port}" \
    -e LOGLEVEL="$TUN_LOGLEVEL" \
    -e EXTRA_COMMANDS="ip rule add iif lo ipproto udp dport 53 lookup main;" \
    "$IMG_TUN"

  # Tuỳ chọn set MTU nếu cấu hình
  if [[ -n "${TUN_MTU}" ]]; then
    echo "[ROUTE $idx] Set MTU=${TUN_MTU} (best-effort)"
    docker exec -it "$t" sh -c "ip link set dev tun0 mtu ${TUN_MTU} || true"
  fi

  # 5) Cloudflared DoH trong cùng namespace với tun
  echo "[ROUTE $idx] Khởi chạy cloudflared DoH..."
  docker run -d --name "$d" --restart=always \
    --network=container:"$t" \
    --user root \
    "$IMG_DOH" \
    proxy-dns --address 127.0.0.1 --port 53

  # 6) Kiểm tra IP qua tuyến
  echo "[ROUTE $idx] Kiểm tra IP egress..."
  docker run --rm --network=container:"$t" curlimages/curl:latest -s https://ifconfig.me || true
  echo
  echo "[ROUTE $idx] SẴN SÀNG. Gắn container vào tuyến này bằng:"
  echo "  docker run ... --network=container:${t} <image> ..."
}

down_all() {
  echo "[CLEANUP] Xoá toàn bộ tuyến..."
  local i=1
  for _ in "${UPSTREAMS[@]}"; do
    cleanup_route "$i"
    rm -f "resolv_${i}.conf" || true
    ((i++))
  done
  echo "[DONE] Đã xoá."
}

status_all() {
  local i=1
  for _ in "${UPSTREAMS[@]}"; do
    local t="${TUN_NAME_BASE}${i}"
    if docker ps --format '{{.Names}}' | grep -qx "$t"; then
      printf "[STATUS] %s " "$t"
      docker run --rm --network=container:"$t" curlimages/curl:latest -s https://ifconfig.me || true
    else
      echo "[STATUS] $t: not running"
    fi
    ((i++))
  done
}

# ===================== CLI =====================
# ./script.sh          -> khởi chạy tất cả tuyến
# ./script.sh status   -> in IP từng tuyến
# ./script.sh down     -> xoá toàn bộ tuyến
case "${1:-up}" in
  up)
    i=1
    for up in "${UPSTREAMS[@]}"; do
      start_route "$i" "$up"
      ((i++))
    done
    echo
    echo "✅ ĐÃ KHỞI TẠO ${#UPSTREAMS[@]} TUYẾN."
    echo "👉 Gắn container client vào tuyến N:  --network=container:tunN"
    ;;
  status)
    status_all
    ;;
  down)
    down_all
    ;;
  *)
    echo "Usage: $0 [up|status|down]"
    exit 1
    ;;
esac
