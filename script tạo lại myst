#!/bin/bash
set -e

# ==== 1. Cáº¤U HÃŒNH (GIá»® NGUYÃŠN Tá»ª SCRIPT Cá»¦A Báº N) ====
IMG_MYST="mysteriumnetwork/myst:latest"
log() { echo -e "\e[32m[INFO] $1\e[0m"; }
err() { echo -e "\e[31m[ERROR] $1\e[0m"; exit 1; }

# ==== 2. Láº¤Y IP PRIVATE (DÃ™NG CHO BIND PORT 4449) ====
IP_PRIVATE_A=$(/sbin/ip -4 -o addr show scope global noprefixroute ens5 | awk '{gsub(/\/.*/,"",$4); print $4}')
IP_PRIVATE_B=$(/sbin/ip -4 -o addr show scope global dynamic ens5 | awk '{gsub(/\/.*/,"",$4); print $4}')

if [ -z "$IP_PRIVATE_A" ] || [ -z "$IP_PRIVATE_B" ]; then err "KhÃ´ng láº¥y Ä‘Æ°á»£c IP Private trÃªn ens5!"; fi
log "IP Private detected: A=$IP_PRIVATE_A | B=$IP_PRIVATE_B"

# ==== 3. XÃ“A Sáº CH MYSTERIUM (CONTAINER & VOLUME) ====
log "Äang xÃ³a sáº¡ch cÃ¡c Node Mysterium cÅ© vÃ  Volume dá»¯ liá»‡u..."

for id in 1 2; do
    # Dá»«ng vÃ  xÃ³a container
    docker rm -f myst$id >/dev/null 2>&1 || true
    # XÃ“A VOLUME (Äá»ƒ xÃ³a Identity cÅ©, báº¯t Ä‘áº§u láº¡i tá»« Ä‘áº§u)
    docker volume rm myst-data$id >/dev/null 2>&1 || true
done

# ==== 4. Äáº¢M Báº¢O NETWORK VÃ€ IPTABLES (CÆ  CHáº¾ ROUTING) ====
# (Pháº§n nÃ y script sáº½ cháº¡y láº¡i Ä‘á»ƒ Ä‘áº£m báº£o IP 1 Ä‘i Network 1, IP 2 Ä‘i Network 2)
# Giáº£ sá»­ báº¡n Ä‘Ã£ táº¡o network my_network_1 vÃ  2 nhÆ° script trÆ°á»›c.

# ==== 5. CÃ€I Äáº¶T Láº I MYSTERIUM (GIá»® PORT 4449) ====
log "ðŸš€ Khá»Ÿi cháº¡y láº¡i Mysterium vá»›i cÆ¡ cháº¿ Bind IP..."

run_myst_node() {
    local ID=$1
    local NET="my_network_$ID"
    local BIND_IP=$2
    
    # CÆ¡ cháº¿: -p BIND_IP:4449:4449 cho phÃ©p dÃ¹ng cÃ¹ng port 4449 trÃªn 2 IP khÃ¡c nhau
    docker run -d \
        --network $NET \
        --cap-add NET_ADMIN \
        --name myst$ID \
        -p ${BIND_IP}:4449:4449 \
        -v myst-data$ID:/var/lib/mysterium-node \
        --restart unless-stopped \
        $IMG_MYST service --agreed-terms-and-conditions >/dev/null
    
    log "âœ… Node myst$ID Ä‘Ã£ cháº¡y trÃªn IP: $BIND_IP | Port: 4449"
}

run_myst_node 1 "$IP_PRIVATE_A"
run_myst_node 2 "$IP_PRIVATE_B"

echo "----------------------------------------------------------"
log "Tá»”NG Káº¾T LINK TRUY Cáº¬P UI:"
echo "ðŸ”— Node 1: http://$IP_PRIVATE_A:4449"
echo "ðŸ”— Node 2: http://$IP_PRIVATE_B:4449"
echo "----------------------------------------------------------"
