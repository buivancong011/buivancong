#!/bin/bash
set -e

# ==== 1. CแบคU HรNH ====
IMG_MYST="mysteriumnetwork/myst:latest"

log() { echo -e "\e[32m[INFO] $1\e[0m"; }
err() { echo -e "\e[31m[ERROR] $1\e[0m"; exit 1; }

# ==== 2. LแบคY IP PRIVATE (DรNG CHO BIND PORT 4449) ====
IP_PRIVATE_A=$(/sbin/ip -4 -o addr show scope global noprefixroute ens5 | awk '{gsub(/\/.*/,"",$4); print $4}')
IP_PRIVATE_B=$(/sbin/ip -4 -o addr show scope global dynamic ens5 | awk '{gsub(/\/.*/,"",$4); print $4}')

if [ -z "$IP_PRIVATE_A" ] || [ -z "$IP_PRIVATE_B" ]; then err "Khรดng lแบฅy ฤฦฐแปฃc IP Private trรชn ens5!"; fi
log "IP Private detected: A=$IP_PRIVATE_A | B=$IP_PRIVATE_B"

# ==== 3. CHแป XรA CONTAINER (GIแปฎ LแบI VOLUME) ====
log "ฤang dแปซng vร dแปn dแบนp Container cลฉ (Dแปฏ liแปu/Identity ฤฦฐแปฃc giแปฏ nguyรชn)..."

for id in 1 2; do
    # Chแป xรณa container, tuyแปt ฤแปi KHรNG xรณa volume
    docker rm -f myst$id >/dev/null 2>&1 || true
done

# ==== 4. KHแปI CHแบY LแบI MYSTERIUM (BแบฎT ฤรNG IP Vร PORT 4449) ====
log "๐ Khแปi chแบกy lแบกi Mysterium (Gแบฏn lแบกi volume cลฉ)..."

run_myst_node() {
    local ID=$1
    local NET="my_network_$ID"
    local BIND_IP=$2
    
    # Run container vร gแบฏn vรo Volume ฤรฃ cรณ (myst-data1, myst-data2)
    docker run -d \
        --network $NET \
        --cap-add NET_ADMIN \
        --name myst$ID \
        -p ${BIND_IP}:4449:4449 \
        -v myst-data$ID:/var/lib/mysterium-node \
        --restart unless-stopped \
        $IMG_MYST service --agreed-terms-and-conditions >/dev/null
    
    log "โ Node myst$ID: ฤรฃ khแปi ฤแปng trรชn $BIND_IP:4449"
}

run_myst_node 1 "$IP_PRIVATE_A"
run_myst_node 2 "$IP_PRIVATE_B"

echo "----------------------------------------------------------"
log "TแปNG KแบพT LINK TRUY CแบฌP UI (IDENTITY Cลจ):"
echo "๐ Node 1: http://$IP_PRIVATE_A:4449"
echo "๐ Node 2: http://$IP_PRIVATE_B:4449"
echo "----------------------------------------------------------"
