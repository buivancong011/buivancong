#!/bin/bash
set -e  # D·ª´ng ngay n·∫øu c√≥ l·ªói

# ==========================================
# 1. C·∫§U H√åNH T√ÄI KHO·∫¢N (S·ª¨A 1 L·∫¶N D√ôNG CHUNG)
# ==========================================
TOKEN_TM="/PfkwR8qQMfbsCMrSaaDhsX96E9w2PeHH2bcGeyFBno="
TOKEN_EARNFM="50f04bbe-94d9-4f6a-82b9-b40016bd4bbb"
# Repocket
RP_EMAIL="nguyenvinhson000@gmail.com"
RP_API="cad6dcce-d038-4727-969b-d996ed80d3ef"
# UrNetwork
UR_USER="nguyenvinhcao123@gmail.com"
UR_PASS="CAOcao123CAO@"


# ==== C·∫§U H√åNH DNS CHUNG (TƒÉng t·ªëc ƒë·ªô k·∫øt n·ªëi) ====
DNS_OPTS="--dns 8.8.8.8 --dns 1.1.1.1"

# ==========================================
# 2. H√ÄM LOG
# ==========================================
log() { echo -e "\e[32m[INFO] $1\e[0m"; }

# ==========================================
# 3. C√ÄI ƒê·∫∂T DOCKER
# ==========================================
if ! command -v docker &> /dev/null; then
  log "ƒêang c√†i ƒë·∫∑t Docker..."
  sudo yum update -y -q
  sudo yum install -y -q docker
  sudo systemctl enable --now docker
  log "Docker ƒë√£ kh·ªüi ƒë·ªông."
fi

# ==========================================
# 4. D·ªåN D·∫∏P CONTAINER C≈®
# ==========================================
log "D·ªçn d·∫πp container c≈© ƒë·ªÉ tr√°nh tr√πng l·∫∑p..."
docker rm -f tm urnetwork antgain earnfm repocket >/dev/null 2>&1 || true
docker image prune -f >/dev/null 2>&1

# ==========================================
# 5. K√âO IMAGE (CH·∫†Y SONG SONG CHO NHANH)
# ==========================================
log "ƒêang t·∫£i Images..."
docker pull traffmonetizer/cli_v2:latest >/dev/null 2>&1 &
docker pull techroy23/docker-urnetwork:latest >/dev/null 2>&1 &
docker pull pinors/antgain-cli:latest >/dev/null 2>&1 &
docker pull earnfm/earnfm-client:latest >/dev/null 2>&1 &
docker pull repocket/repocket:latest >/dev/null 2>&1 &

wait # ƒê·ª£i t·∫•t c·∫£ t·∫£i xong
log "T·∫£i ·∫£nh ho√†n t·∫•t."

# ==========================================
# 6. KH·ªûI CH·∫†Y CONTAINER (FULL 5 APPS + DNS)
# ==========================================
log "üöÄ Kh·ªüi ch·∫°y c√°c ·ª©ng d·ª•ng c√†y ti·ªÅn..."

# 1. Traffmonetizer
docker run -d --restart always --name tm $DNS_OPTS \
  traffmonetizer/cli_v2:latest start accept --token "$TOKEN_TM"

# 2. UrNetwork (ƒê√£ th√™m l·∫°i theo y√™u c·∫ßu)
docker run -d --name urnetwork --restart always --cap-add NET_ADMIN $DNS_OPTS \
  -v ur_data:/var/lib/vnstat \
  -e USER_AUTH="$UR_USER" -e PASSWORD="$UR_PASS" \
  techroy23/docker-urnetwork:latest


# 4. EarnFM
docker run -d --name earnfm --restart always $DNS_OPTS \
  -e EARNFM_TOKEN="$TOKEN_EARNFM" \
  earnfm/earnfm-client:latest

# 5. Repocket
docker run -d --name repocket --restart always $DNS_OPTS \
  -e RP_EMAIL="$RP_EMAIL" -e RP_API_KEY="$RP_API" \
  repocket/repocket:latest

# ==========================================
# 7. HO√ÄN T·∫§T
# ==========================================
log "==== C√ÄI ƒê·∫∂T TH√ÄNH C√îNG ===="
docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Image}}"
