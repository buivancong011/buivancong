#!/bin/bash
set -Eeuo pipefail

# ================= CONFIG =================
IMAGE_TM="traffmonetizer/cli_v2:latest"
TOKEN="JoaF9KjqyUjmIUCOMxx6W/6rKD0Q0XTHQ5zlqCEJlXM="

# Danh sÃ¡ch container: tÃªn container:tÃªn network:tÃªn thiáº¿t bá»‹ hiá»ƒn thá»‹
CONTAINERS=(
"tm1:tun1:device_tm1"
"tm2:tun2:device_tm2"
"tm3:tun3:device_tm3"
"tm4:tun4:device_tm4"
"tm5:tun5:device_tm5"
"tm6:tun6:device_tm6"
"tm7:tun7:device_tm7"
"tm8:tun8:device_tm8"
"tm9:tun9:device_tm9"
"tm10:tun10:device_tm10"
"tm11:tun11:device_tm11"
"tm12:tun12:device_tm12"
"tm13:tun13:device_tm13"
"tm14:tun14:device_tm14"
"tm15:tun15:device_tm15"
"tm16:tun16:device_tm16"
"tm17:tun17:device_tm17"
"tm18:tun18:device_tm18"
"tm19:tun19:device_tm19"
"tm20:tun20:device_tm20"
"tm21:tun21:device_tm21"
"tm22:tun22:device_tm22"
"tm23:tun23:device_tm23"
"tm24:tun24:device_tm24"
"tm25:tun25:device_tm25"
"tm26:tun26:device_tm26"
"tm27:tun27:device_tm27"
"tm28:tun28:device_tm28"
"tm29:tun29:device_tm29"
"tm30:tun30:device_tm30"
"tm31:tun31:device_tm31"
"tm32:tun32:device_tm32"
"tm33:tun33:device_tm33"
"tm34:tun34:device_tm34"
"tm35:tun35:device_tm35"
"tm36:tun36:device_tm36"
"tm37:tun37:device_tm37"
"tm38:tun38:device_tm38"
"tm39:tun39:device_tm39"
"tm40:tun40:device_tm40"
"tm41:tun41:device_tm41"
"tm42:tun42:device_tm42"
"tm43:tun43:device_tm43"
"tm44:tun44:device_tm44"
"tm45:tun45:device_tm45"
"tm46:tun46:device_tm46"
"tm47:tun47:device_tm47"
"tm48:tun48:device_tm48"
"tm49:tun49:device_tm49"
"tm50:tun50:device_tm50"
"tm51:tun51:device_tm51"
"tm52:tun52:device_tm52"
"tm53:tun53:device_tm53"
"tm54:tun54:device_tm54"
"tm55:tun55:device_tm55"
"tm56:tun56:device_tm56"
"tm57:tun57:device_tm57"
"tm58:tun58:device_tm58"
"tm59:tun59:device_tm59"
"tm60:tun60:device_tm60"
"tm61:tun61:device_tm61"
"tm62:tun62:device_tm62"
"tm63:tun63:device_tm63"
"tm64:tun64:device_tm64"
"tm65:tun65:device_tm65"
"tm66:tun66:device_tm66"
"tm67:tun67:device_tm67"
"tm68:tun68:device_tm68"
"tm69:tun69:device_tm69"
"tm70:tun70:device_tm70"
"tm71:tun71:device_tm71"
"tm72:tun72:device_tm72"
"tm73:tun73:device_tm73"
"tm74:tun74:device_tm74"
"tm75:tun75:device_tm75"
"tm76:tun76:device_tm76"
"tm77:tun77:device_tm77"
"tm78:tun78:device_tm78"
"tm79:tun79:device_tm79"
"tm80:tun80:device_tm80"
"tm81:tun81:device_tm81"
"tm82:tun82:device_tm82"
"tm83:tun83:device_tm83"
"tm84:tun84:device_tm84"
"tm85:tun85:device_tm85"
"tm86:tun86:device_tm86"
"tm87:tun87:device_tm87"
"tm88:tun88:device_tm88"
"tm89:tun89:device_tm89"
"tm90:tun90:device_tm90"





)

# =============== TRIá»‚N KHAI ===============
for pair in "${CONTAINERS[@]}"; do
  name="${pair%%:*}"                      # tm1
  rest="${pair#*:}"                      # tun1:device_tm1
  tun="${rest%%:*}"                      # tun1
  device_name="${rest#*:}"               # device_tm1

  echo "ðŸ§ª [SETUP] XoÃ¡ container cÅ© $name náº¿u cÃ³..."
  docker rm -f "$name" >/dev/null 2>&1 || true

  echo "ðŸš€ [RUN] Khá»Ÿi cháº¡y $name qua $tun vá»›i tÃªn thiáº¿t bá»‹: $device_name ..."
  docker run -d --restart=always \
    --network=container:"$tun" \
    --name "$name" \
    "$IMAGE_TM" start accept \
      --token "$TOKEN" \
      --device-name "$device_name"
done

echo ""
echo "âœ… HoÃ n táº¥t! CÃ¡c container TraffMonetizer Ä‘Ã£ Ä‘Æ°á»£c khá»Ÿi cháº¡y:"
docker ps --filter "ancestor=$IMAGE_TM" --format "table {{.Names}}\t{{.Status}}\t{{.Networks}}"
echo ""
echo "ðŸ“¡ Gá»£i Ã½ test IP tá»«ng tuyáº¿n:"
for pair in "${CONTAINERS[@]}"; do
  name="${pair%%:*}"
  tun="${pair#*:}"
  tun="${tun%%:*}"
  echo "  docker run --rm --network=container:$tun curlimages/curl:latest -s ifconfig.me"
done
