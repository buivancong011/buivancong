#!/bin/bash
set -Eeuo pipefail

# ================= CONFIG =================
IMAGE_TM="traffmonetizer/cli_v2:latest"
TOKEN="JoaF9KjqyUjmIUCOMxx6W/6rKD0Q0XTHQ5zlqCEJlXM="

# Danh sÃ¡ch container: tÃªn container:tÃªn network:tÃªn thiáº¿t bá»‹ hiá»ƒn thá»‹
CONTAINERS=(
  "tm1:tun1:device_tm1"
  "tm2:tun2:device_tm2"
  "tm3:tun3:device_tm3"
  "tm4:tun4:device_tm4"
  "tm5:tun5:device_tm5"
  "tm6:tun6:device_tm6"
  "tm7:tun7:device_tm7"
  "tm8:tun8:device_tm8"
  "tm9:tun9:device_tm9"
  "tm10:tun10:device_tm10"
  "tm11:tun11:device_tm11"
  "tm12:tun12:device_tm12"
  "tm13:tun13:device_tm13"
  "tm14:tun14:device_tm14"
  "tm15:tun15:device_tm15"
  "tm16:tun16:device_tm16"
  "tm17:tun17:device_tm17"
  "tm18:tun18:device_tm18"
  "tm19:tun19:device_tm19"
  "tm20:tun20:device_tm20"
  "tm21:tun21:device_tm21"
  "tm22:tun22:device_tm22"
)

# =============== TRIá»‚N KHAI ===============
for pair in "${CONTAINERS[@]}"; do
  name="${pair%%:*}"                      # tm1
  rest="${pair#*:}"                      # tun1:device_tm1
  tun="${rest%%:*}"                      # tun1
  device_name="${rest#*:}"               # device_tm1

  echo "ðŸ§ª [SETUP] XoÃ¡ container cÅ© $name náº¿u cÃ³..."
  docker rm -f "$name" >/dev/null 2>&1 || true

  echo "ðŸš€ [RUN] Khá»Ÿi cháº¡y $name qua $tun vá»›i tÃªn thiáº¿t bá»‹: $device_name ..."
  docker run -d --restart=always \
    --network=container:"$tun" \
    --name "$name" \
    "$IMAGE_TM" start accept \
      --token "$TOKEN" \
      --device-name "$device_name"
done

echo ""
echo "âœ… HoÃ n táº¥t! CÃ¡c container TraffMonetizer Ä‘Ã£ Ä‘Æ°á»£c khá»Ÿi cháº¡y:"
docker ps --filter "ancestor=$IMAGE_TM" --format "table {{.Names}}\t{{.Status}}\t{{.Networks}}"
echo ""
echo "ðŸ“¡ Gá»£i Ã½ test IP tá»«ng tuyáº¿n:"
for pair in "${CONTAINERS[@]}"; do
  name="${pair%%:*}"
  tun="${pair#*:}"
  tun="${tun%%:*}"
  echo "  docker run --rm --network=container:$tun curlimages/curl:latest -s ifconfig.me"
done
