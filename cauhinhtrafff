#!/bin/bash
set -Eeuo pipefail

# ================= CONFIG =================
IMAGE_TM="traffmonetizer/cli_v2:latest"
TOKEN="JoaF9KjqyUjmIUCOMxx6W/6rKD0Q0XTHQ5zlqCEJlXM="

# TÃªn container báº¡n muá»‘n cháº¡y
CONTAINERS=(

  "tm21:tun21"
  "tm22:tun22"
)

# =============== TRIá»‚N KHAI ===============
for pair in "${CONTAINERS[@]}"; do
  name="${pair%%:*}"
  tun="${pair#*:}"

  echo "ðŸ§ª [SETUP] XoÃ¡ container cÅ© $name náº¿u cÃ³..."
  docker rm -f "$name" >/dev/null 2>&1 || true

  echo "ðŸš€ [RUN] Khá»Ÿi cháº¡y $name qua tuyáº¿n máº¡ng $tun ..."
  docker run -d --restart=always \
    --network=container:"$tun" \
    --name "$name" \
    --label "app=traffmonetizer" \
    --label "tm.index=$name" \
    --label "tm.network=$tun" \
    "$IMAGE_TM" start accept --token "$TOKEN"
done

echo ""
echo "âœ… HoÃ n táº¥t! CÃ¡c container TraffMonetizer Ä‘Ã£ Ä‘Æ°á»£c khá»Ÿi cháº¡y:"
docker ps --filter "ancestor=$IMAGE_TM" --format "table {{.Names}}\t{{.Status}}\t{{.Networks}}"
echo ""
echo "ðŸ“¡ Gá»£i Ã½ test IP tá»«ng tuyáº¿n:"
for pair in "${CONTAINERS[@]}"; do
  name="${pair%%:*}"
  tun="${pair#*:}"
  echo "  docker run --rm --network=container:$tun curlimages/curl:latest -s ifconfig.me"
done
